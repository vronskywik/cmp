USE [msdb]
GO

/****** Object:  Job [AdjFctr_Check]    Script Date: 3/15/2016 8:55:52 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:52 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'AdjFctr_Check', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for Adjustment factors present in Vendor''s adj table AND Adjfctr.  12/02/2009  Removed FIRST CALL from query.  Below is original query with FIRST CALL.                                               select distinct f.*, coalesce(i.cusip, ig.cusip, c.cusip) as cusip_sedol, coalesce(i.name, ig.name, c.name, v.conm) as name, 
i.iticker IBES, 
v.gvkey Compustat, 
c.ticker FirstCall, 
ig.iticker IbesGlbl
from adjfctr f left join ibesinfo3 i on i.code = f.vendorcode and f.database_ in (1,2)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:52 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select distinct f.Database_, i.iticker IBES, v.gvkey Compustat, ig.iticker IbesGlbl,
coalesce(i.cusip, ig.cusip) as cusip_sedol, coalesce(i.name, ig.name, v.conm) as name

from adjfctr f left join ibesinfo3 i on i.code = f.vendorcode and f.database_ in (1,2) -- IBES
      left join ibesadj a on a.code = i.code and a.date_ > dateadd(mm,-1,getdate())
      left join ibgsinfo3 ig on ig.code = f.vendorcode and f.database_ in (7,8) -- IBES global
      left join ibgsadj ag on ag.code = ig.code and ag.date_ > dateadd(mm,-1,getdate())
      left join csvcompany v on v.gvkey = f.vendorcode and f.database_ in (3,4,6,9,10) -- Compustat codes
      left join cscoadjfact va on va.gvkey = v.gvkey and va.effdate > dateadd(mm,-1,getdate())

where a.code is not null or ag.code is not null or va.effdate is not null

order by f.database_
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\AdjFctr\ADJFCTRCheck_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Axioma_Bad_Last_Trade_Date]    Script Date: 3/15/2016 8:55:52 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:52 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Axioma_Bad_Last_Trade_Date', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch cases where the last trade date is an obvious error because it is 365 days or more different than the contract year and month combination. This was in response to TT#1034605', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:52 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select DsMnem, FutCode, convert(smalldatetime, ''01/''+substring(Contrdate, 1, 2)+''/''+substring(Contrdate, 3, 2), 3) ContrDate, convert(smalldatetime, LastTrdDate, 2) LastTrdDate
from DsFutContrInfo  where
abs(datediff(d, convert(smalldatetime, ''01/''+substring(Contrdate, 1, 2)+''/''+substring(Contrdate, 3, 2), 3),convert(smalldatetime, LastTrdDate, 2))) > 360
and LastTrdDate >= getdate(); 

select distinct currency_ from msdfxdly where currency_ not in 
(select desc_ from mscode where codename=''currency'') and currency_ not in (''mxp'',''plz'',''rur'')

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Arun\Last Trade Date Check for AXIOMA__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080821, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8b971dc9-f1ae-4094-ac91-b3ed87edfac4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Axioma_Percentage_Change_Check]    Script Date: 3/15/2016 8:55:52 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:52 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Axioma_Percentage_Change_Check', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This request came from Arun on behalf of Axioma. This will track high percentage price changes in their universe.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:52 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'
select contrname, contrdate, dsmnem, current_price.* 
From dsfutcontrval current_price , dsfutcontrinfo info, dsfutcontr contr 
where contr.contrcode in (1753,
1148,
4154,
2369,
1986,
3427,
2297,
1118,
168,
1481,
647,
1134,
2735,
1110,
1159,
355,
1154,
1129,
1441,
2440,
1309,
2108,
2175,
1149,
1502,
378,
2990,
379,
827,
1160,
3730,
1141,
717,
2445,
1280,
2439,
2036,
2038,
1130,
1155,
298,
3241,
3161,
3016,
444,
1420,
1135,
1112,
2248,
1687,
2872,
4,
1123,
2442,
2493,
1877,
1361,
191,
2173,
1383,
364,
1382,
1111,
2065,
329,
801,
2477,
1576,
2177,
449,
2029,
2446,
1575,
1516,
3171,
2724,
1980,
402,
2698,
1365,
1140,
2483,
1691,
4084,
1122,
1926,
3456,
3284,
1368,
2363,
2557,
2091,
1226,
1421,
506,
2101,
2074,
3153,
4106,
1116,
323,
396,
1150,
430,
1379,
1156,
1692,
2308,
1114,
362,
2991,
975,
1153,
2020,
1405,
911,
1696,
1422,
2378,
1131,
788,
775,
1136,
401,
1117,
2558,
385,
1115,
2324,
1381,
2026,
1142,
2045,
3735,
1138,
3156,
2384,
2197,
1614,
2104,
2060,
1790,
630,
3246,
1157,
282,
1992,
2444,
1881,
92,
1143,
1128,
1139,
1127,
1124,
1978,
2744,
2368,
1321,
3390,
310,
1324,
1329,
301,
2517,
2000,
1338,
1506,
1675,
486,
834,
704,
779,
723,
1559,
3479,
3361,
1563,
334,
2741,
342,
1995,
1394,
1398,
920,
1355,
1471,
3701,
1550,
1364,
2148,
2881,
2035,
2873,
1367,
2093,
2290,
2100,
1343,
1377,
1378,
2630,
414,
417,
326,
1339,
420,
429,
3392,
3388,
3389,
3393,
3395,
3397,
9,
53,
42,
108) and settlement > 0 and 
contr.contrcode = info.contrcode and info.futcode = current_price.futcode and 
(exists (
select 1 from dsfutcontrval next_price where next_price.futcode = current_price.futcode and next_price.Date_ = (
select min(next_prices.Date_) from dsfutcontrval next_prices where next_prices.futcode = current_price.futcode and next_prices.Date_ > current_price.Date_
and next_prices.settlement > 0 
)
and (next_price.Settlement/current_price.Settlement < 0.2 or next_price.Settlement/current_price.Settlement > 5)
)
or exists (
select 1 from dsfutcontrval previous_price where previous_price.futcode = current_price.futcode and previous_price.Date_ = (
select max(previous_prices.Date_) from dsfutcontrval previous_prices where previous_prices.futcode = current_price.futcode and previous_prices.Date_ < current_price.Date_
and previous_prices.settlement > 0 
)
and (previous_price.Settlement/current_price.Settlement < 0.2 or previous_price.Settlement/current_price.Settlement > 5)
))
order by contrname, dsmnem, Date_;

select distinct currency_ from msdfxdly where currency_ not in 
(select desc_ from mscode where codename=''currency'') and currency_ not in (''mxp'',''plz'',''rur'')

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Arun\Percentage Change Check for AXIOMA__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 2:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'b5db78d1-5a69-4532-9fb8-4e7e45769c74'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Diff_Price(G)]    Script Date: 3/15/2016 8:55:52 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:52 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Diff_Price(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'At the request of Bangalore Data.                                                Purpose: Daily check for global equities on same date where Close does not match between DS2 and IDC Global.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Comparing CLOSE prices across IDC and DS2 for last trading date.
--For DS2 PriceUnit = E+00, rounding done to 3 decimal places but showing entire price

select distinct s.ID, 
g.Sedol, g.Issuer+g.Issue as "IDC Name", convert(varchar(10),gp.Date_,111) as "IDC Date", gp.Close_ as "IDC Close", gp.Exchange,
d.DsCode, d.DsQtName, convert(varchar(10),dp.MarketDate,111) as "DS2 Date", dp.Close_ as "DS2 Close", de.PriceUnit, dx.ExchName, dp.ExchIntCode
from gsecmstrx s join gsecmapx m on (s.seccode=m.seccode) and s.type_=10 join gsecmapx m2 on (s.seccode=m2.seccode)
and (m.seccode=m2.seccode)
join gprcinfo2 g on (m.vencode=g.code) and m.ventype=1 join gprcval gp on (g.code=gp.code) join gprcvala ga on (gp.code=ga.code) and (gp.date_=ga.date_)
join ds2ctryqtinfo d on (m2.vencode=d.infocode) and m2.ventype=33 join ds2primqtprc dp on (d.infocode=dp.infocode)
and (gp.Date_=dp.MarketDate) join ds2exchqtinfo de on (d.infocode=de.infocode) join ds2exchange dx on (dp.exchintcode=dx.exchintcode)
where gp.Date_>=GetDate()-2 and de.PriceUnit=''E+00'' and round(gp.Close_,3)!=round(dp.Close_,3)
and gp.Exchange in 
(''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''AAS'', ''FHH'', ''FMS'', ''FKN'', ''FIB'', ''FIN'', ''FTA'', ''FTB'') 
and dp.ExchIntCode not in (23, 24, 40, 51, 56, 59, 70, 76, 122, 136, 179, 245, 58, 60, 62, 72, 77, 86, 92, 96, 131, 133, 134, 150, 184) 
-- Exclude all German/Japanese exchanges except for Xetra (78) and Tokyo (200)
and (ga.CloseTypeCode=''9'' and dp.RefPrcTypCode=1)

UNION
--For DS2 PriceUnit = E-02, rounding done to 4 decimal places
select distinct s.ID, 
g.Sedol, g.Issuer+g.Issue as "IDC Name", convert(varchar(10),gp.Date_,111) as "IDC Date", gp.Close_ as "IDC Close", gp.Exchange,
d.DsCode, d.DsQtName, convert(varchar(10),dp.MarketDate,111) as "DS2 Date", (dp.Close_/100) as "DS2 Close", de.PriceUnit, dx.ExchName, dp.ExchIntCode
from gsecmstrx s join gsecmapx m on (s.seccode=m.seccode) and s.type_=10 join gsecmapx m2 on (s.seccode=m2.seccode)
and (m.seccode=m2.seccode)
join gprcinfo2 g on (m.vencode=g.code) and m.ventype=1 join gprcval gp on (g.code=gp.code) join gprcvala ga on (gp.code=ga.code) and (gp.date_=ga.date_)
join ds2ctryqtinfo d on (m2.vencode=d.infocode) and m2.ventype=33 join ds2primqtprc dp on (d.infocode=dp.infocode)
and (gp.Date_=dp.MarketDate) join ds2exchqtinfo de on (d.infocode=de.infocode) join ds2exchange dx on (dp.exchintcode=dx.exchintcode)
where gp.Date_>=GetDate()-2 and de.PriceUnit=''E-02'' and round(gp.Close_,4)!=round((dp.Close_/100),4)
and gp.Exchange in 
(''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''AAS'', ''FHH'', ''FMS'', ''FKN'', ''FIB'', ''FIN'', ''FTA'', ''FTB'') 
and dp.ExchIntCode not in (23, 24, 40, 51, 56, 59, 70, 76, 122, 136, 179, 245, 58, 60, 62, 72, 77, 86, 92, 96, 131, 133, 134, 150, 184) 
-- Exclude all German/Japanese exchanges except for Xetra (78) and Tokyo (200)
and (ga.CloseTypeCode=''9'' and dp.RefPrcTypCode=1)

Order by gp.Exchange, s.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Diffs\Diff_Price(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Su-Th 7:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=31, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120815, 
		@active_end_date=99991231, 
		@active_start_time=180000, 
		@active_end_time=235959, 
		@schedule_uid=N'748a691d-f3e9-493b-9b6e-0577ece282ce'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Diff_Price(NA)]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Diff_Price(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Compares IDC and DataStream prices for last trade date in U.S. and Canadian markets.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Comparing CLOSE prices across IDC and DS2 for last trading date.

--US, DS2 PriceUnit E+00, rounding done to 3 decimal places but show entire price
select distinct s.ID, ''US'' as Region,
g.Cusip, g.Issuer+g.Issue as "IDC Name", convert(varchar(10),gp.Date_,111) as "IDC Date", gp.Close_ as "IDC Close", g.CurrEx,
d.DsCode, d.DsQtName, convert(varchar(10),dp.MarketDate,111) as "DS2 Date", dp.Close_ as "DS2 Close", de.PriceUnit, dx.ExchName, dp.ExchIntCode
from secmstrx s join secmapx m on (s.seccode=m.seccode) and s.type_=1 join secmapx m2 on (s.seccode=m2.seccode) and (m.seccode=m2.seccode)
join prc.prcinfo g on (m.vencode=g.code) and m.ventype=1 and m.exchange=1 join prc.prcdly gp on (g.code=gp.code)
join ds2ctryqtinfo d on (m2.vencode=d.infocode) and m2.ventype=33 and m2.exchange=1 join ds2primqtprc dp on (d.infocode=dp.infocode)
and (gp.Date_=dp.MarketDate) join ds2exchqtinfo de on (d.infocode=de.infocode) join ds2exchange dx on (dp.exchintcode=dx.exchintcode)
where gp.Date_>=GetDate()-2 and de.PriceUnit=''E+00'' and round(gp.Close_,3)!=round(dp.Close_,3)
and g.CurrEx in (''A'', ''B'', ''F'')
and dp.ExchIntCode not in (27, 36, 41, 42, 124, 140, 141, 147, 154, 155, 158, 159, 176, 195, 244, 252, 253, 254, 255 )
-- Exclude all US exchanges except Amex Comp (12), NYSE Comp (145), Nasdaq Comp (135)
and dp.RefPrcTypCode=1

UNION
--CA, DS2 PriceUnit E+00, rounding done to 3 decimal places but show actual price
select distinct s.ID, ''CA'' as Region,
g.Cusip, g.Issuer+g.Issue as "IDC Name", convert(varchar(10),gp.Date_,111) as "IDC Date", gp.Close_ as "IDC Close", g.CurrEx,
d.DsCode, d.DsQtName, convert(varchar(10),dp.MarketDate,111) as "DS2 Date", dp.Close_ as "DS2 Close", de.PriceUnit, dx.ExchName, dp.ExchIntCode
from secmstrx s join secmapx m on (s.seccode=m.seccode) and s.type_=1 join secmapx m2 on (s.seccode=m2.seccode) and (m.seccode=m2.seccode)
join cprcinfo g on (m.vencode=g.code) and m.ventype=1 and m.exchange=2 join cprcdly gp on (g.code=gp.code)
join ds2ctryqtinfo d on (m2.vencode=d.infocode) and m2.ventype=33 and m2.exchange=2 join ds2primqtprc dp on (d.infocode=dp.infocode)
and (gp.Date_=dp.MarketDate) join ds2exchqtinfo de on (d.infocode=de.infocode) join ds2exchange dx on (dp.exchintcode=dx.exchintcode)
where gp.Date_>=GetDate()-2 and de.PriceUnit=''E+00'' and round(gp.Close_,3)!=round(dp.Close_,3)
and dp.ExchIntCode not in (5, 118, 273, 274, 275)
-- Exclude all CA exchanges except Toronto (197) and Venture (201)
and dp.RefPrcTypCode=1

UNION
--US, DS2 PriceUnit E-02, rounding done to 4 decimal places but show entire price
select distinct s.ID, ''US'' as Region,
g.Cusip, g.Issuer+g.Issue as "IDC Name", convert(varchar(10),gp.Date_,111) as "IDC Date", gp.Close_ as "IDC Close", g.CurrEx,
d.DsCode, d.DsQtName, convert(varchar(10),dp.MarketDate,111) as "DS2 Date", dp.Close_ as "DS2 Close", de.PriceUnit, dx.ExchName, dp.ExchIntCode
from secmstrx s join secmapx m on (s.seccode=m.seccode) and s.type_=1 join secmapx m2 on (s.seccode=m2.seccode) and (m.seccode=m2.seccode)
join prc.prcinfo g on (m.vencode=g.code) and m.ventype=1 and m.exchange=1 join prc.prcdly gp on (g.code=gp.code)
join ds2ctryqtinfo d on (m2.vencode=d.infocode) and m2.ventype=33 and m2.exchange=1 join ds2primqtprc dp on (d.infocode=dp.infocode)
and (gp.Date_=dp.MarketDate) join ds2exchqtinfo de on (d.infocode=de.infocode) join ds2exchange dx on (dp.exchintcode=dx.exchintcode)
where gp.Date_>=GetDate()-2 and de.PriceUnit=''E-02'' and round(gp.Close_,4)!=round(dp.Close_,4)
and g.CurrEx in (''A'', ''B'', ''F'')
and dp.ExchIntCode not in (27, 36, 41, 42, 124, 140, 141, 147, 154, 155, 158, 159, 176, 195, 244, 252, 253, 254, 255 )
-- Exclude all US exchanges except Amex Comp (12), NYSE Comp (145), Nasdaq Comp (135)
and dp.RefPrcTypCode=1

UNION
--CA, DS2 PriceUnit E-02, rounding done to 4 decimal places but show actual price
select distinct s.ID, ''CA'' as Region,
g.Cusip, g.Issuer+g.Issue as "IDC Name", convert(varchar(10),gp.Date_,111) as "IDC Date", gp.Close_ as "IDC Close", g.CurrEx,
d.DsCode, d.DsQtName, convert(varchar(10),dp.MarketDate,111) as "DS2 Date", dp.Close_ as "DS2 Close", de.PriceUnit, dx.ExchName, dp.ExchIntCode
from secmstrx s join secmapx m on (s.seccode=m.seccode) and s.type_=1 join secmapx m2 on (s.seccode=m2.seccode) and (m.seccode=m2.seccode)
join cprcinfo g on (m.vencode=g.code) and m.ventype=1 and m.exchange=2 join cprcdly gp on (g.code=gp.code)
join ds2ctryqtinfo d on (m2.vencode=d.infocode) and m2.ventype=33 and m2.exchange=2 join ds2primqtprc dp on (d.infocode=dp.infocode)
and (gp.Date_=dp.MarketDate) join ds2exchqtinfo de on (d.infocode=de.infocode) join ds2exchange dx on (dp.exchintcode=dx.exchintcode)
where gp.Date_>=GetDate()-2 and de.PriceUnit=''E-02'' and round(gp.Close_,4)!=round(dp.Close_,4)
and dp.ExchIntCode not in (5, 118, 273, 274, 275)
-- Exclude all CA exchanges except Toronto (197) and Venture (201)
and dp.RefPrcTypCode=1

Order by Region, g.CurrEx, s.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Diffs\Diff_Price(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090529, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'05a9074f-b8b4-491d-8d49-c2665ee5a12a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_AdjMissing]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_AdjMissing', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'CapEvents that are not in the Adjustment table (reviewing DS2).  #981455', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Reviews DS2 with TUNA''s business rules applied

Select distinct i.DsCode, e.InfoCode, e.EventNum, e.ActionTypeCode, e.EffectiveDate, e.CashAmt
from Ds2CapEvent e join Ds2PrimQtPrc p on (e.infocode=p.infocode) join Ds2CtryQtInfo i on (i.infocode=e.infocode) 
where not exists (select * from Ds2Adj a where AdjType=2 and (a.infocode=e.infocode) 
and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7))) 
and i.CovergCode in (''F'', ''L'') and e.EffectiveDate <=getdate()-1
and (e.ActionTypeCode not in (''RGHT'', ''BONS'') and e.RenMarker not in (''N'', ''X'') and e.EffectiveDate > ''20000101'')
and i.DsCode not in (''756290'', ''875521'')
group by i.DsCode, e.InfoCode, e.EventNum, e.ActionTypeCode, e.EffectiveDate, e.CashAmt
having min(p.MarketDate)<=e.EffectiveDate

order by DsCode, EffectiveDate, ActionTypeCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_AdjMissing_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_CapAdj]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_CapAdj', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Any infocode/dscode with at least 1 entry in the CapEvent table but
no entries in the adjustment table (DS, DS2).  #966789', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Capital event records w/o adjustment records
--DS2
select distinct a.Infocode, ''DS2'' as Region, a.DsCode, a.DsMnem, a.CovergCode, a.StatusCode
from ds2capevent c join Ds2CtryQtInfo a on (a.infocode=c.infocode)
where not exists (select * from Ds2Adj where infocode=c.infocode)
and covergcode not in (''e'',''d'', ''r'')

UNION

--DS
select distinct a.Infocode, ''DS'' as Region, a.DsCode, a.DsMnem, a.CovergCode, a.StatusCode
from dscapevent c join DsCtryQtInfo a on (a.infocode=c.infocode)
where not exists (select * from DsAdj where infocode=c.infocode)
and covergcode not in (''e'',''d'', ''r'')

order by DsCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_CapAdj_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_CapEventMissing]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_CapEventMissing', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Adjustments not in CapEvent table or the dates do not match (reviewing both DS and DS2).  BLR request', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS, DS2 Adj not in CapEvents

Select ''DS2'' as Region, i.DsCode, a.InfoCode, a.AdjDate, a.EndAdjDate, a.AdjFactor from Ds2Adj a join Ds2CtryQtInfo i on (a.infocode=i.infocode)
where AdjType=2 and not exists (select * from Ds2CapEvent e where AdjType=2 and 
(a.infocode=e.infocode) and (a.AdjDate=e.EffectiveDate)) and a.AdjDate >= GetDate()-30
and AdjFactor is not NULL and a.CumAdjFactor!=1

UNION

Select ''DS'' as Region, i.DsCode, a.InfoCode, a.AdjDate, a.EndAdjDate, a.AdjFactor from DsAdj a join DsCtryQtInfo i on (a.infocode=i.infocode)
where not exists (select * from DsCapEvent e where (a.infocode=e.infocode) and (a.AdjDate=e.EffectiveDate)) 
and a.AdjDate >= GetDate()-30
and AdjFactor is not NULL and a.CumAdjFactor!=1

order by i.DsCode, Region, AdjDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_CapEventMissing_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DivDates]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DivDates', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'2/24/2010 - Counterpart to IDC div dates check - currently looks for A) missing DivRate; B) missing Pay Date.  "Announcement Date" and "Record Date" will be added later in 2010 when DataStream backfills dividend history from DSE/Corax.  (Per Gemma Rogers.)  4/22/10 - add''l filter:  only if PayDateEstFlag is not NULL.  11/10/10 Condensed the DS and DS2 checks into this one.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2_Div
select ''DS2'' as Region, d.Infocode, s.Sedol, i.DsCode, d.EventNum, d.DivTypeCode, d.DivRate, d.PayDate, d.PayDateEstFlag,
d.EffectiveDate, d.EffDateEstFlag, i.DsQtName
from ds2div d join ds2ctryqtinfo i on (d.infocode=i.infocode) join ds2sedolchg s on (i.infocode=s.infocode)
and s.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=i.infocode order by StartDate desc)
where RecDateEstFlag is not NULL and paydate is NULL or DivRate is NULL 

UNION

--Legacy DataStream
select ''DS'' as Region, d.Infocode, i.Sedol, i.DsCode, d.EventNum, d.DivTypeCode, d.DivRate, d.PayDate, d.PayDateEstFlag,
d.EffectiveDate, d.EffDateEstFlag, i.DsQtName
from dsdiv d join dsctryqtinfo i on (d.infocode=i.infocode) where PayDateEstFlag is not NULL and paydate is NULL
or DivRate is NULL 

Order by i.DsCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_DivDates_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DsDataType]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DsDataType', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for DataTypeMnem in DSINDEXDATATYPEHST* tables that have no description in DSDATATYPE.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT S.DSINDEXCODE
,	H1.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST1 H1
	ON S.DSINDEXCODE = H1.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H1.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H2.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST2 H2
	ON S.DSINDEXCODE = H2.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H2.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H3.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST3 H3
	ON S.DSINDEXCODE = H3.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H3.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H4.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST4 H4
	ON S.DSINDEXCODE = H4.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H4.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H5.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST5 H5
	ON S.DSINDEXCODE = H5.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H5.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H6.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST6 H6
	ON S.DSINDEXCODE = H6.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H6.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H7.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST7 H7
	ON S.DSINDEXCODE = H7.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H7.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H8.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST8 H8
	ON S.DSINDEXCODE = H8.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H8.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H9.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST9 H9
	ON S.DSINDEXCODE = H9.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H9.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H10.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST10 H10
	ON S.DSINDEXCODE = H10.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H10.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H11.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST11 H11
	ON S.DSINDEXCODE = H11.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H11.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H12.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST12 H12
	ON S.DSINDEXCODE = H12.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H12.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H13.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST13 H13
	ON S.DSINDEXCODE = H13.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H13.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H14.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST14 H14
	ON S.DSINDEXCODE = H14.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H14.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H15.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST15 H15
	ON S.DSINDEXCODE = H15.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H15.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H16.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST16 H16
	ON S.DSINDEXCODE = H16.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H16.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H17.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST17 H17
	ON S.DSINDEXCODE = H17.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H17.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H18.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST18 H18
	ON S.DSINDEXCODE = H18.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H18.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H19.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST19 H19
	ON S.DSINDEXCODE = H19.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H19.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H20.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST20 H20
	ON S.DSINDEXCODE = H20.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H20.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H21.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST21 H21
	ON S.DSINDEXCODE = H21.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H21.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H22.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST22 H22
	ON S.DSINDEXCODE = H22.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H22.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H23.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST23 H23
	ON S.DSINDEXCODE = H23.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H23.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL
UNION
SELECT S.DSINDEXCODE
,	H24.VALUEDATE
,	T.DESCN
FROM DSEQUITYINDEX S
JOIN DSINDEXDATATYPEHST24 H24
	ON S.DSINDEXCODE = H24.DSINDEXCODE
LEFT JOIN DSDATATYPE T
	ON H24.DATATYPEMNEM = T.DATATYPEMNEM 	AND T.ENTITYTYPEID = 3
WHERE T.DATATYPEMNEM IS NULL OR DESCN IS NULL

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_DsDataType_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 7:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=193000, 
		@active_end_time=235959, 
		@schedule_uid=N'92c127a4-a78a-4bd0-b62c-704eb24679db'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DupeCusips]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DupeCusips', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This checks for multiple securities assigned the same cusip, excluding nulls or blanks.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Duplicate cusips

select 
  i.dscode
, i.DsQtName 
, i.region
, c.infocode as InfoCode1
, c2.infocode as InfoCode2
, c.cusip as Cusip1
, c2.cusip as Cusip2
, c.startdate as StartDate1
, c2.startdate as StartDate2
, c.enddate as EndDate1
, c2.enddate as EndDate2
from ds2ctryqtinfo i
join ds2cusipchg c
on i.infocode = c.infocode
and i.region in(''can'', ''us'')
join ds2cusipchg c2
on c.cusip = c2.cusip
and c.infocode <> c2.infocode
join ds2ctryqtinfo i2
on c2.infocode = i2.infocode
and i.region = i2.region 
where c.startdate between c2.startdate and c2.enddate
or c2.startdate between c.startdate and c.enddate
order by c.cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_DupeCusips_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DupeDsMnem]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DupeDsMnem', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'2/24/2010  Counterpart to IDC dupe ticker check, looking for duplicate DsMnem in CtryQtInfo for DS and DS2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2

select ''DS2'' as Region, s.Sedol, a.Infocode as Infocode_A, b.infocode as Infocode_B, a.dscode as DsCode_A, b.dscode as DsCode_B,
a.dsmnem as DsMnem_A, b.dsmnem as DsMnem_B, a.covergcode as CovergCode_A, b.covergcode as CovergCode_B
from ds2ctryqtinfo a join ds2ctryqtinfo b on (a.infocode=b.infocode) join ds2sedolchg s on (a.infocode=s.infocode)
and s.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=a.infocode order by StartDate desc)
where a.DsMnem = b.DsMnem and a.dsseccode!=b.dsseccode

UNION

--Legacy DS
select ''DS'' as Region, a.Sedol, a.Infocode as Infocode_A, b.infocode as Infocode_B, a.dscode as DsCode_A, b.dscode as DsCode_B,
a.dsmnem as DsMnem_A, b.dsmnem as DsMnem_B, a.covergcode as CovergCode_A, b.covergcode as CovergCode_B
from dsctryqtinfo a join dsctryqtinfo b on (a.infocode=b.infocode) 
where a.DsMnem = b.DsMnem and a.dsseccode!=b.dsseccode

Order by a.DsMnem, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_DupeDsMnem_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DupeISIN]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DupeISIN', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans DsIsinChg & Ds2isinChg for same ISIN assigned to more than 1 DsSecCode.  #953210 (ZBI)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DataStream duplicate ISIN (#953210)

--DS
SELECT ''DS'' as Region, T1.DsSecCode AS DsSecCode1, T2.DsSecCode AS DsSecCode2, t1.NewISIN as "Isin" FROM DsIsinChg AS T1 
WITH (NOLOCK) INNER JOIN DsIsinChg AS T2 WITH (NOLOCK) ON (T1.NewISIN = T2.NewISIN ) or (t1.NewISIN=t2.OldISIN)
or (t1.OldISIN=t2.OldISIN) or (t1.OldISIN=t2.NewISIN)
WHERE T1.DsSecCode != T2.DsSecCode --AND T2.StartDate >= T1.StartDate AND T2.StartDate <= T1.EndDate

UNION

--DS2
SELECT ''DS2'' as Region, T1.DsSecCode AS DsSecCode1, T2.DsSecCode AS DsSecCode2, T1.Isin FROM Ds2IsinChg AS T1 
WITH (NOLOCK) INNER JOIN Ds2IsinChg AS T2 WITH (NOLOCK) ON T1.ISIN = T2.ISIN 
WHERE T1.DsSecCode != T2.DsSecCode AND T2.StartDate >= T1.StartDate AND T2.StartDate <= T1.EndDate

order by Isin, Region, t1.DsSecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\DataStream\DS\DS_DupeISIN_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DupeSedol]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DupeSedol', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans DsCtryQtInfo & Ds2SedolChg for multiple securities assigned the same sedol, excluding nulls or blanks in DS and DS2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2
select ''DS2'' as Region, i.DsCode, i.Infocode from ds2ctryqtinfo i join ds2sedolchg s1 on (i.infocode=s1.infocode)
join ds2sedolchg s2 on (i.infocode=s2.infocode) where s1.sedol = s2.sedol and s1.infocode!=s2.infocode

UNION

--DS
select ''DS'' as Region, i.DsCode, i.Infocode from dsctryqtinfo i join dsctryqtinfo b on (i.infocode=b.infocode)
where b.sedol = i.sedol and b.infocode!=i.infocode

Order by Region, i.DsCode
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_DupeSedols_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_DupPrimQtInfoCode]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:53 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_DupPrimQtInfoCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Reviews DsSecurity & Ds2Security for same PrimQtInfocode mapped to different DsSctyCodes.  (#953210)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:53 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Dupe PrimQtInfoCode in DsSecurity, Ds2Security

Select ''DS2'' as Region, s1.DsSecCode, s1.DsSctyCode, s1.DsCmpyCode, s1.DsCmpyCode, s1.PrimQtInfoCode, 
s2.DsSecCode, s2.DsSctyCode, s2.DsCmpyCode, s2.DsCmpyCode
from ds2security s1 join ds2security s2 on (s1.dscmpycode=s2.dscmpycode)
where s1.dssctycode!=s2.dssctycode and s1.primqtinfocode=s2.primqtinfocode

UNION

Select ''DS'' as Region, s1.DsSecCode, s1.DsSctyCode, s1.DsCmpyCode, s1.DsCmpyCode, s1.PrimQtInfoCode, 
s2.DsSecCode, s2.DsSctyCode, s2.DsCmpyCode, s2.DsCmpyCode
from dssecurity s1 join dssecurity s2 on (s1.dscmpycode=s2.dscmpycode)
where s1.dssctycode!=s2.dssctycode and s1.primqtinfocode=s2.primqtinfocode

Order by s1.PrimQtInfoCode, s1.DsSecCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\DataStream\DS\DS_DupPrimQtInfoCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 4:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=40000, 
		@active_end_time=235959, 
		@schedule_uid=N'21969e35-41c5-42ed-a2cc-eb710bb4497a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_ExchangeCount]    Script Date: 3/15/2016 8:55:53 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_ExchangeCount', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This outputs the infocode totals for the last 4 days on exchanges worldwide, designed to catch exchanges missed in a days update.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS & DS2 exchange counts

Select ''DS2-Pri'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode 
from ds2PrimQtPrc a join ds2exchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS2-Scd'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode 
from ds2ScdQtPrc a join ds2exchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode 
from dsqtprice1 a join dsexchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode
from dsqtprice2 a join dsexchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode
from dsqtprice3 a join dsexchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode
from dsqtprice4 a join dsexchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode
from dsqtprice5 a join dsexchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem
UNION
select ''DS'' as Region, count(distinct a.infocode) as Total, a.MarketDate, e.ExchName, e.ExchMnem, a.ExchIntCode
from dsqtprice6 a join dsexchange e on (a.exchintcode=e.exchintcode)
where a.marketdate >= getdate()-5 group by a.marketdate, a.exchintcode, e.exchname, e.exchmnem

Order by e.ExchName, ExchIntCode, Region, a.MarketDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_ExchangeCount_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 12:05am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=500, 
		@active_end_time=235959, 
		@schedule_uid=N'2156868f-2edd-4093-affd-cc08faa342fc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_ExchIntCode]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_ExchIntCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans DsExchQtInto for undefined ExchIntCodes (references DsExchange) for DS and DS2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Undefined ExchIntCodes in the DS*ExchQtInfo
--DS2
SELECT ''DS2'' as  Region, i.InfoCode, s.Sedol, i.ExchIntCode, e.ExchMnem
FROM DS2EXCHQTINFO I LEFT JOIN DS2EXCHANGE E ON I.EXCHINTCODE = E.EXCHINTCODE
join ds2sedolchg s on (i.infocode=s.infocode) and s.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=i.infocode order by StartDate desc)
WHERE EXCHMNEM IS NULL

UNION

--DS
SELECT ''DS'' as  Region, i.InfoCode, c.Sedol, i.ExchIntCode, e.ExchMnem
FROM DSEXCHQTINFO I LEFT JOIN DSEXCHANGE E ON (I.EXCHINTCODE = E.EXCHINTCODE)
join dsctryqtinfo c on (i.infocode=c.infocode) WHERE EXCHMNEM IS NULL

Order by Region, i.ExchIntCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_Exchange_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_FuturePrices]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_FuturePrices', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for prices in the legacy DS and DS2 tables that are for dates in the future (greater then today).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2
select ''DS2-Prim'' as Region, s.Infocode, i.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode
from ds2ctryqtinfo s join ds2PrimQtPrc p on (s.infocode=p.infocode) 
join ds2sedolchg i on (i.infocode=s.infocode) and i.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=s.infocode order by StartDate desc)
where p.marketdate > GetDate()
UNION
select ''DS2-Scd'' as Region, s.Infocode, s.DsCode, s.DsQtName, p.ExchIntCode
from ds2ctryqtinfo s join ds2ScdQtPrc p on (s.infocode=p.infocode) 
join ds2sedolchg i on (i.infocode=s.infocode) and i.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=s.infocode order by StartDate desc)
where p.marketdate > GetDate()
UNION

--Legacy DataStream
SELECT ''DS-Qt1'' as Region, s.InfoCode, s.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode FROM DSCTRYQTINFO S
JOIN DSQTPRICE1 P ON S.INFOCODE = P.INFOCODE WHERE P.MARKETDATE > GETDATE()
UNION
SELECT ''DS-Qt2'' as Region, s.InfoCode, s.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode FROM DSCTRYQTINFO S
JOIN DSQTPRICE2 P ON S.INFOCODE = P.INFOCODE WHERE P.MARKETDATE > GETDATE()
UNION
SELECT ''DS-Qt3'' as Region, s.InfoCode, s.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode FROM DSCTRYQTINFO S
JOIN DSQTPRICE3 P ON S.INFOCODE = P.INFOCODE WHERE P.MARKETDATE > GETDATE()
UNION
SELECT ''DS-Qt4'' as Region, s.InfoCode, s.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode FROM DSCTRYQTINFO S
JOIN DSQTPRICE4 P ON S.INFOCODE = P.INFOCODE WHERE P.MARKETDATE > GETDATE()
UNION
SELECT ''DS-Qt5'' as Region, s.InfoCode, s.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode FROM DSCTRYQTINFO S
JOIN DSQTPRICE5 P ON S.INFOCODE = P.INFOCODE WHERE P.MARKETDATE > GETDATE()
UNION
SELECT ''DS-Qt6'' as Region, s.InfoCode, s.Sedol, s.DsCode, s.DsQtName, p.ExchIntCode FROM DSCTRYQTINFO S
JOIN DSQTPRICE6 P ON S.INFOCODE = P.INFOCODE WHERE P.MARKETDATE > GETDATE()

Order by DsCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_FutPrices_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:00pm', 
		@enabled=0, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=200000, 
		@active_end_time=235959, 
		@schedule_uid=N'1c403b05-36b2-4551-b6ed-36262f110877'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_FxRate]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_FxRate', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looking for null Mid, Bid, or Offer in the DsFxRate and Ds2FxRate tables.  Stemmed from client complaint #945160 (Marshall Wace).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Null Mid (ER), Bid (EB), or Offer (EO) in DsFxRate and Ds2FxRate.  #945160

select ''DS'' as Region, i.ExRateDesc, x.* from dsfxcode i join dsfxrate x on (i.ExRateIntCode=x.ExRateIntCode)
where (x.MidRate is NULL and x.BidRate is NULL) and ExRateDate>=getdate()-5

UNION

select ''Ds2'' as Region, i.ExRateDesc, x.* from dsfxcode i join ds2fxrate x on (i.ExRateIntCode=x.ExRateIntCode)
where (x.MidRate is NULL and x.BidRate is NULL) and ExRateDate>=getdate()-5

order by ExRateIntCode, Region, ExRateDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_FxRate_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=8
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:00pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=200000, 
		@active_end_time=235959, 
		@schedule_uid=N'14d121b4-d0b1-4d89-ad54-09570ec49267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_HolidayPrices(NA)]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_HolidayPrices(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for pricing in DS and DS2 for US & Canadian securities on exchange holidays.  Prompted by #948248.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS_HolidayPrices(NA)
--DS North America prices on holiday dates TSE=197, TSX=201, NAS=135, NYS=145, AMEX=12, ARCA=244

Select ''DS-CA(2)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.ClosingPrice as Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join DsQtPrice2 p on (p.MarketDate=d.date_) join DsCtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''TrS''
and p.ExchIntCode in (197, 201) and p.MarketDate not in (''9/11/01'', ''9/14/01'')

UNION

Select ''DS-US(3)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.ClosingPrice as Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join DsQtPrice3 p on (p.MarketDate=d.date_) join DsCtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''NYS''
and p.ExchIntCode=145

UNION

Select ''DS-US(5)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.ClosingPrice as Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join DsQtPrice5 p on (p.MarketDate=d.date_) join DsCtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''NYS''
and p.ExchIntCode=135

UNION

Select ''DS2-CA(Pri)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join Ds2PrimQtPrc p on (p.MarketDate=d.date_) join Ds2CtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''TrS''
and p.ExchIntCode in (197, 201) and p.MarketDate not in (''9/11/01'', ''9/14/01'')

UNION

Select ''DS2-CA(Scd)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join Ds2ScdQtPrc p on (p.MarketDate=d.date_) join Ds2CtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''TrS''
and p.ExchIntCode in (197, 201) and p.MarketDate not in (''9/11/01'', ''9/14/01'')

UNION

Select ''DS2-US(Pri)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join Ds2ScdQtPrc p on (p.MarketDate=d.date_) join Ds2CtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''NYS''
and p.ExchIntCode in (12, 135, 145, 244)

UNION

Select ''DS2-US(Scd)'' as Region, d.date_ as Holiday_Date, i.Infocode, i.DsCode, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join Ds2ScdQtPrc p on (p.MarketDate=d.date_) join Ds2CtryQtinfo i on (p.infocode=i.infocode) where e.ExchAbbr=''NYS''
and p.ExchIntCode in (12, 135, 145, 244)

order by Region, i.Infocode, Holiday_Date
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\DataStream\DS\DS_HolidayPrices(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_IdxTotRet]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_IdxTotRet', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for index RI (return index) moves greater than 20% day-to-day.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'WITH DSINDEX AS (SELECT ROW_NUMBER () OVER 
(PARTITION BY S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H1.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST1 H1
	ON S.DSINDEXCODE = H1.DSINDEXCODE
JOIN DSDATATYPE T
	ON H1.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 1
WHERE T.DATATYPEMNEM = ''RI'' AND S.DSINDEXCODE = 10

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H2.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST2 H2
	ON S.DSINDEXCODE = H2.DSINDEXCODE
JOIN DSDATATYPE T
	ON H2.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 2
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H3.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST3 H3
	ON S.DSINDEXCODE = H3.DSINDEXCODE
JOIN DSDATATYPE T
	ON H3.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 3
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H4.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST4 H4
	ON S.DSINDEXCODE = H4.DSINDEXCODE
JOIN DSDATATYPE T
	ON H4.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 4
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H5.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST5 H5
	ON S.DSINDEXCODE = H5.DSINDEXCODE
JOIN DSDATATYPE T
	ON H5.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 5
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H6.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST6 H6
	ON S.DSINDEXCODE = H6.DSINDEXCODE
JOIN DSDATATYPE T
	ON H6.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 6
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H7.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST7 H7
	ON S.DSINDEXCODE = H7.DSINDEXCODE
JOIN DSDATATYPE T
	ON H7.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 7
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H8.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST8 H8
	ON S.DSINDEXCODE = H8.DSINDEXCODE
JOIN DSDATATYPE T
	ON H8.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 8
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H9.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST9 H9
	ON S.DSINDEXCODE = H9.DSINDEXCODE
JOIN DSDATATYPE T
	ON H9.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 9
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H10.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST10 H10
	ON S.DSINDEXCODE = H10.DSINDEXCODE
JOIN DSDATATYPE T
	ON H10.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 10
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H11.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST11 H11
	ON S.DSINDEXCODE = H11.DSINDEXCODE
JOIN DSDATATYPE T
	ON H11.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 11
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H12.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST12 H12
	ON S.DSINDEXCODE = H12.DSINDEXCODE
JOIN DSDATATYPE T
	ON H12.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 12
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H13.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST13 H13
	ON S.DSINDEXCODE = H13.DSINDEXCODE
JOIN DSDATATYPE T
	ON H13.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 13
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H14.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST14 H14
	ON S.DSINDEXCODE = H14.DSINDEXCODE
JOIN DSDATATYPE T
	ON H14.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 14
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H15.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST15 H15
	ON S.DSINDEXCODE = H15.DSINDEXCODE
JOIN DSDATATYPE T
	ON H15.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 15
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H16.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST16 H16
	ON S.DSINDEXCODE = H16.DSINDEXCODE
JOIN DSDATATYPE T
	ON H16.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 16
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H17.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST17 H17
	ON S.DSINDEXCODE = H17.DSINDEXCODE
JOIN DSDATATYPE T
	ON H17.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 17
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H18.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST18 H18
	ON S.DSINDEXCODE = H18.DSINDEXCODE
JOIN DSDATATYPE T
	ON H18.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 18
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H19.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST19 H19
	ON S.DSINDEXCODE = H19.DSINDEXCODE
JOIN DSDATATYPE T
	ON H19.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 19
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H20.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST20 H20
	ON S.DSINDEXCODE = H20.DSINDEXCODE
JOIN DSDATATYPE T
	ON H20.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 20
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H21.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST21 H21
	ON S.DSINDEXCODE = H21.DSINDEXCODE
JOIN DSDATATYPE T
	ON H21.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 21
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H22.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST22 H22
	ON S.DSINDEXCODE = H22.DSINDEXCODE
JOIN DSDATATYPE T
	ON H22.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 22
WHERE T.DATATYPEMNEM = ''RI'' 


UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H23.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST23 H23
	ON S.DSINDEXCODE = H23.DSINDEXCODE
JOIN DSDATATYPE T
	ON H23.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 23
WHERE T.DATATYPEMNEM = ''RI'' 

UNION

SELECT 
  ROW_NUMBER () OVER (PARTITION BY 	S.DSINDEXCODE ORDER BY VALUEDATE) AS ROW
, S.DSINDEXCODE
, H24.VALUEDATE
, S.IndexDesc
, T.DATATYPEMNEM
, T.DESCN
, DATATYPEVALUE AS RI , S.TABLEID

FROM DSEquityIndex S
JOIN DSINDEXDATATYPEHST24 H24
	ON S.DSINDEXCODE = H24.DSINDEXCODE
JOIN DSDATATYPE T
	ON H24.DATATYPEMNEM = T.DATATYPEMNEM 	
	AND T.ENTITYTYPEID = 3
	AND S.TABLEID = 24
WHERE T.DATATYPEMNEM = ''RI'' 

)
SELECT 
	P.DSINDEXCODE
,	P.INDEXDESC
,	P.DESCN
,	P.VALUEDATE
,	P.RI
,	P2.VALUEDATE
,	P2.RI
,	P.TABLEID

,	(((P.RI - P2.RI) / P2.RI)) * 100  AS CHANGE
FROM 
		DSINDEX P
JOIN	DSINDEX P2
	ON	P.DSINDEXCODE = P2.DSINDEXCODE
	AND P.ROW - 1 = P2.ROW
WHERE (((P.RI - P2.RI) / P2.RI)) NOT BETWEEN -20 AND 20 -- CHANGE VALUE TO GET HIGHER PERCENTAGE OUTLIERS
AND P.DSINDEXCODE = 51113
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_IdxTotRet_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_Index_EntityCode]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_Index_EntityCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Originating from a Palantir complaint (#940117) where table DsEqIdxListConst''s ENTITYCODE is mapped to more than one (1) INFOCODE.  Tends to be orphan infocodes from the May 2010 DS AltDsCode project clean-up.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--EntityCodes with > 1 infocode (Palantir, #940117

select distinct EntityCode as DsEqIdxListConst_EntityCode, InfoCode from DsEqIdxListConst where 
EntityCode in (select EntityCode from (select distinct EntityCode, InfoCode from DsEqIdxListConst) 
x group by EntityCode having count (*) >1)  and EntityCode not in (95983, 179026)
order by EntityCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_Index_EntityCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_Index_Infocode]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_Index_Infocode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Infocodes in DsEqIdxListConst not in DsCtryQtInfo.
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Orphan Infocodes (outgrowth of DS_Index_EntityCode check)

select distinct a.Infocode, a.EntityCode, a.IndexListCode
from DsEqIdxListConst a where not exists (select * from DsCtryQtInfo b where a.infocode=b.infocode)
order by Infocode
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_Index_InfoCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=8
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_IsMajor(Security)]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_IsMajor(Security)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Checks DsSecurity and Ds2Security where DsCmpyCode has > 1 DsSecCode with "IsMajor=Y."  #946918, Macquarie', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DataStream SECURITY with multi "IsMajor=Y" or none defined as primary
--Legacy DS

Select ''DS'' as Region, dc.DsCompCode as TUNA_DsCmpyCode, dc.DsCmpyCode, dc.DsCmpyName, count(1) as Total
from dssecurity ds inner join dscompany dc on dc.dscmpycode=ds.dscmpycode
where ismajorsec=''Y'' group by dc.dscompcode, dc.dscmpycode, dc.dscmpyname having count(1)>1 or count(1) < 1

UNION

--DS2
Select ''DS2'' as Region, dc.DsCompCode as TUNA_DsCmpyCode, dc.DsCmpyCode, dc.DsCmpyName, count(1) as Total
from ds2security ds inner join ds2company dc on dc.dscmpycode=ds.dscmpycode
where ismajorsec=''Y'' group by dc.dscompcode, dc.dscmpycode, dc.dscmpyname having count(1)>1 or count(1) < 1

order by dc.DsCompCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_IsMajor(Security)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_IsPrimExchQt(ExchQtInfo)]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_IsPrimExchQt(ExchQtInfo)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for multiple IsPrimExchQt=Y on same InfoCode or no IsPrimExchQt=Y defined.  Requested by Nancy O''Hara.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DataStream ExchQtInfo with multi "IsPrimExchQt"

Select ''DS'' as Region, infocode, count(*) as Total from dsexchqtinfo where IsPrimExchQt=''Y'' 
group by infocode having count(*) > 1 or count(*) < 1

union

Select ''DS2'' as Region, infocode, count(*) as Total from ds2exchqtinfo where IsPrimExchQt=''Y'' 
group by infocode having count(*) > 1 or count(*) < 1
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_IsPrimExchQt(ExchQtInfo)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_IsPrimQt(CtryQtInfo)]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_IsPrimQt(CtryQtInfo)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for cases where DsSecCode does not have any IsPrimQt defined OR has multiple IsPrimQt.  Requested by Nancy O''Hara, updated to include missing IsPrimQt by Parimala (TT #1010826).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DataStream CtryQtInfo with multi "IsPrimQt" or NO primary quote defined

Select ''DS2'' as Region, DsSecCode, count(*) as Total from ds2ctryqtinfo where IsPrimQt=''1'' 
group by DsSecCode having count(*) > 1 or count(*) < 1

UNION

Select ''DS'' as Region, DsSecCode, count(*) as Total from ds2ctryqtinfo where IsPrimQt=''1'' 
group by DsSecCode having count(*) > 1 or count(*) < 1

Order by Region, DsSecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_IsPrimQt(CtryQtInfo)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_MissingAdjFctrs]    Script Date: 3/15/2016 8:55:54 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:54 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_MissingAdjFctrs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'DsCodes that have no entry in the ADJUSTMENT table.  TT #982282', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:54 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DsCodes in the INFO table with no entry in the ADJUSTMENT table

--DS2
Select ''DS2'' as Region, a.Infocode, s.Sedol, a.DsCode, a.DsQtName, a.DsMnem, a.CovergCode, a.StatusCode, a.TypeCode
from Ds2CtryQtInfo a join Ds2sedolchg s on (a.infocode=s.infocode)
and s.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=a.infocode order by StartDate desc)
where not exists (select * from Ds2Adj b where a.infocode=b.infocode)

UNION

--DS
Select ''DS'' as Region, a.Infocode, a.Sedol, a.DsCode, a.DsQtName, a.DsMnem, a.CovergCode, a.StatusCode, a.TypeCode
from DsCtryQtInfo a where not exists (select * from DsAdj b where a.infocode=b.infocode)

Order by a.DsCode, Region, a.InfoCode, CovergCode, StatusCode, TypeCode
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_MissingAdjFctr_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_MissingCodes]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_MissingCodes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Added by request, #948778 (ZBI) to report DsCmpyCodes that are in Ds(2)Security but not in Ds(2)Company.  *Scans DS Legacy tables.  *Updated 2012-05-07 to report missing CODES (infocode, DsSecCode, and DsCmpyCode) in relevant tables.  Now has SIX (6) queries, generating three sections of output.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS Legacy
--InfoCodes in CtryQtInfo but not ExchQtInfo
Select ''DS InfoCode in CtryQtInfo'' as Region, i.InfoCode as "Missing InfoCode", i.DsCode, i.DsQtName from DsCtryQtinfo i where not exists (select * from DsExchQtInfo e where i.InfoCode=e.InfoCode)
order by i.DsCode

--InfoCodes in ExchQtInfo but not CtryQtInfo
Select ''DS InfoCode in ExchQtInfo'' as Region, e.InfoCode as "Missing InfoCode", e.DsQtName, e.ExchIntCode, x.DsExchCode
from DsExchQtInfo e join dsexchange x on (e.ExchIntCode=x.ExchIntCode)
where not exists (select * from DsCtryQtInfo i where i.InfoCode=e.InfoCode) order by e.InfoCode

--DsSecCode in *CtryQtInfo but not *Security
Select ''DS DsSecCode in CtryQtInfo'' as Region, i.DsSecCode as "Missing DsSecCode", i.InfoCode, i.DsCode from DsCtryQtinfo i where not exists (select * from DsSecurity s where i.DsSecCode=s.DsSecCode)
order by i.DsCode

--DsSecCode in *Security but not *CtryQtInfo
Select ''DS DsSecCode in Security'' as Region, s.DsSecCode as "Missing DsSecCode", s.DsSctyCode, 
s.DsCmpyCode as "TRDW Company Code", s.DsSecName
from DsSecurity s where not exists (select * from DsCtryQtInfo i where i.DsSecCode=s.DsSecCode)
order by s.DsSctyCode

--DsCmpyCode in *Security but not in *Company
Select ''DS CmpyCode in Security'' as Region, s.DsCmpyCode as "Missing DsCmpyCode", s.DsSecCode, s.DsSctyCode,
s.DsSecName, s.PrimQtSedol
from DsSecurity s where not exists (select * from DsCompany c where s.dscmpycode=c.dscmpycode)
order by s.DsSctyCode

--DsCmpyCode in *Company but not in *Security
Select ''DS CmpyCode in Company'' as Region, c.DsCmpyCode as "Missing TRDW Company Code", 
c.DsCompCode as "TUNA DsCmpyCode", c.DsCmpyName
from DsCompany c where not exists (select * from DsSecurity s where s.dscmpycode=c.dscmpycode)
order by Region, c.DsCompCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------


', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_MissingCodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=8
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_MissingPrices]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_MissingPrices', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for DsCodes in DsCtryQtInfo but not in DsExchQtInfo.  Scans DS and DS2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2
Select ''DS2'' as Region, a.Infocode, s.Sedol, a.DsCode, a.DsQtName, a.DsMnem, a.CovergCode, a.StatusCode, a.TypeCode
from Ds2CtryQtInfo a join Ds2sedolchg s on (a.infocode=s.infocode)
and s.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=a.infocode order by StartDate desc)
where not exists (select * from Ds2ExchQtInfo b where a.infocode=b.infocode)

UNION

--DS
select ''DS'' as Region, a.Infocode, a.Sedol, a.DsCode, a.DsQtName, a.DsMnem, a.CovergCode, a.StatusCode, a.TypeCode
from DsCtryQtInfo a where not exists (select * from DsExchQtInfo b where a.infocode=b.infocode)

order by a.DsCode, Region, a.InfoCode, CovergCode, StatusCode, TypeCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_MissingPrices_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_NumShares]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_NumShares', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for shares outstanding changes greater than 25% in the last 2 trading days in legacy DS and DS2.  8/14/12 Market filters applied (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2
SELECT ''DS2'' as Region, I.DsCode, c.Sedol, I.InfoCode, I.DsQtName, S.EventDate, S.NumShrs, S2.EventDate, S2.NumShrs
, (100 * ((S.NumShrs / S2.NumShrs) - 1)) AS PctChgShares, x.ExchIntCode, x2.ExchName
FROM ds2ctryqtinfo i join ds2numshares s on (i.infocode=s.infocode) join ds2numshares s2 on (s.infocode=s2.infocode)
join ds2exchqtinfo x on (i.infocode=x.infocode) join ds2exchange x2 on (x.ExchIntCode=x2.ExchIntCode)
join ds2sedolchg c on (i.infocode=c.infocode) and c.StartDate=(select top 1 StartDate from Ds2SedolChg where infocode=i.infocode order by StartDate desc)
and s2.EventDate = (select MAX(EventDate) from ds2numshares where infocode = s2.infocode and EventDate < s.EventDate) where ((100 * ((s.NumShrs / s2.NumShrs) - 1)) 
not between -25 and 25) 	and s.EventDate >= GetDate() - 2
and x.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

UNION

--Legacy DataStream
SELECT ''DS'' as Region, I.DsCode, i.Sedol, I.InfoCode, I.DsQtName, S.EventDate, S.NumShrs, S2.EventDate, S2.NumShrs,
(100 * ((S.NumShrs / S2.NumShrs) - 1)) AS PctChgShares, x.ExchIntCode, x2.ExchName
FROM DSCTRYQTINFO I JOIN DSNUMSHARES S 	ON I.INFOCODE = S.INFOCODE JOIN DSNUMSHARES S2 ON S.INFOCODE = S2.INFOCODE
join dsexchqtinfo x on (i.infocode=x.infocode) join dsexchange x2 on (x.ExchIntCode=x2.ExchIntCode)
	AND S2.EVENTDATE = (SELECT MAX(EVENTDATE) FROM DSNUMSHARES WHERE INFOCODE = S2.INFOCODE AND EVENTDATE < S.EVENTDATE)
WHERE ((100 * ((S.NumShrs / S2.NumShrs) - 1)) NOT BETWEEN -25 AND 25) 
	AND S.EVENTDATE >= GETDATE() - 2
and x.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

Order by i.DsCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_NumShares_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_Orphan_DsSecCode]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_Orphan_DsSecCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'DsSecCodes that exist in DsCtryQtInfo & Ds2CtryQtInfo but not in DsSecurity & Ds2Security.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Missing DsSecCode

Select ''DS2'' as Region, a.Infocode, a.DsCode, a.DsSecCode from Ds2CtryQtInfo a where not exists 
(select * from Ds2Security b where a.DsSecCode=b.DsSecCode)

UNION

select ''DS'' as Region, a.Infocode, a.DsCode, a.DsSecCode from DsCtryQtInfo a where not exists 
(select * from DsSecurity b where a.DsSecCode=b.DsSecCode)

order by DsCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_Orphan_DsSecCodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_PrimQtInfocode]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_PrimQtInfocode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'9/21/2012  Added at Blackrock''s request.  Scans DS & DS2 security''s PrimQtInfocode does not match designated primary Infocode in *CtryQtInfo (IsPrimQt=1).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Select ''DS2'' as Region, i.Infocode, i.Dscode, s.DsSecCode, s.DsSctyCode
from ds2security s join ds2ctryqtinfo i on (s.dsseccode=i.dsseccode)
where i.IsPrimQt=1 and s.PrimQtInfocode!=i.Infocode

UNION

Select ''DS'' as Region, i.Infocode, i.Dscode, s.DsSecCode, s.DsSctyCode
from dssecurity s join dsctryqtinfo i on (s.dsseccode=i.dsseccode)
where i.IsPrimQt=1 and s.PrimQtInfocode!=i.Infocode

order by i.DsCode, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_PrimQtInfocode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_PrimSedol]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_PrimSedol', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Primary Quote Sedol not matching between Security and Ds2CtryQtInfo / Ds2SedolChg.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Primary Quote Sedol not matching between Security and DsCtryQtInfo / Ds2SedolChg
--DS2, 92 rows

Select ''DS2'' as Region, i.DsCode, s.DsSecCode, e.InfoCode, e.ExchIntCode, s.PrimQtSedol, c.Sedol
 from Ds2Security s join Ds2CtryQtInfo i on (s.DsSecCode=i.DsSecCode) join Ds2ExchQtInfo e on (i.infocode=e.infocode)
join Ds2SedolChg c on (i.infocode=c.infocode) where c.EndDate=''20790605'' and e.IsPrimExchQt=''Y''
and i.IsPrimQt=''1'' and (s.PrimQtSedol!=(c.sedol + c.SedolChk)) and (s.PrimQtInfoCode=c.infocode)

UNION

--Legacy DS, 4 rows
Select ''DS'' as Region, i.DsCode, s.DsSecCode, e.InfoCode, e.ExchIntCode, s.PrimQtSedol, i.Sedol
from DsSecurity s join DsCtryQtInfo i on (s.DsSecCode=i.DsSecCode) join DsExchQtInfo e on (i.infocode=e.infocode)
where (i.IsPrimQt=''1'' and s.PrimQtSedol!=i.Sedol) and (s.PrimQtInfoCode=i.infocode)

order by s.DsSecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_PrimSedol_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_Region]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_Region', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query scans DsCompany for undefined region codes (references DsRegion) for DS and DS2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2
select ''DS2'' as Region, c.CmpyCtryCode, c.DsCmpyCode from DS2company C left join DS2region R on (c.CmpyCtryCode = r.Region)
where Name_ is NULL or Region is NULL

UNION

--DS
select ''DS'' as Region, c.CmpyCtryCode, c.DsCmpyCode FROM DSCOMPANY C LEFT JOIN DSREGION R ON C.CMPYCTRYCODE = R.CTRYCODE
WHERE NAME IS NULL OR CTRYCODE IS NULL

order by Region, CmpyCtryCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_Region_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_RI]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_RI', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'4/14/10 Overhauled DS (legacy) RI check because the old one never generated output.  Prices > 5 and RI > 20%, Prices < 5 and RI > 50%.  8/14/12 Market filter added (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Legacy DS RI
With DSPricing (Row, MarketDate, ExchIntCode, Sedol, DsCode, Name, InfoCode, ClosingPrice, RI, TableID) as
(
Select Row_Number () over (partition by p.Infocode, p.ExchIntCode order by p.MarketDate) as 
Row,	p.MarketDate, p.ExchIntCode, s.Sedol, s.DsCode, s.DsQtName, s.Infocode, p.ClosingPrice, r.RI, e.TableID
from DsCtryQtInfo s join DsQtPrice1 p on (p.InfoCode=s.InfoCode) join DsQtRI1 r on (p.InfoCode=r.InfoCode)
join DsExchQtInfo e on (p.infocode=e.infocode) and (r.MarketDate=p.MarketDate) and (p.ExchIntCode=r.ExchIntCode)
and r.RI<>0 and p.MarketDate >= getdate() -2
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

UNION
--DsQtRI2
select Row_Number () over (partition by p.Infocode, p.ExchIntCode order by p.MarketDate) as 
Row,	p.MarketDate, p.ExchIntCode, s.Sedol, s.DsCode, s.DsQtName, s.Infocode, p.ClosingPrice, r.RI, e.TableID
from DsCtryQtInfo s join DsQtPrice2 p on (p.InfoCode=s.InfoCode) join DsQtRI2 r on (p.InfoCode=r.InfoCode)
join DsExchQtInfo e on (p.infocode=e.infocode) and (r.MarketDate=p.MarketDate) and (p.ExchIntCode=r.ExchIntCode)
and r.RI<>0 and p.MarketDate >= getdate() -2
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

UNION
--DsQtRI3
select Row_Number () over (partition by p.Infocode, p.ExchIntCode order by p.MarketDate) as 
Row,	p.MarketDate, p.ExchIntCode, s.Sedol, s.DsCode, s.DsQtName, s.Infocode, p.ClosingPrice, r.RI, e.TableID
from DsCtryQtInfo s join DsQtPrice3 p on (p.InfoCode=s.InfoCode) join DsQtRI3 r on (p.InfoCode=r.InfoCode)
join DsExchQtInfo e on (p.infocode=e.infocode) and (r.MarketDate=p.MarketDate) and (p.ExchIntCode=r.ExchIntCode)
and r.RI<>0 and p.MarketDate >= getdate() -2
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

UNION
--DsQtRI4
select Row_Number () over (partition by p.Infocode, p.ExchIntCode order by p.MarketDate) as 
Row,	p.MarketDate, p.ExchIntCode, s.Sedol, s.DsCode, s.DsQtName, s.Infocode, p.ClosingPrice, r.RI, e.TableID
from DsCtryQtInfo s join DsQtPrice4 p on (p.InfoCode=s.InfoCode) join DsQtRI4 r on (p.InfoCode=r.InfoCode)
join DsExchQtInfo e on (p.infocode=e.infocode) and (r.MarketDate=p.MarketDate) and (p.ExchIntCode=r.ExchIntCode)
and r.RI<>0 and p.MarketDate >= getdate() -2
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

UNION
--DsQtRI5
select Row_Number () over (partition by p.Infocode, p.ExchIntCode order by p.MarketDate) as 
Row,	p.MarketDate, p.ExchIntCode, s.Sedol, s.DsCode, s.DsQtName, s.Infocode, p.ClosingPrice, r.RI, e.TableID
from DsCtryQtInfo s join DsQtPrice5 p on (p.InfoCode=s.InfoCode) join DsQtRI5 r on (p.InfoCode=r.InfoCode)
join DsExchQtInfo e on (p.infocode=e.infocode) and (r.MarketDate=p.MarketDate) and (p.ExchIntCode=r.ExchIntCode)
and r.RI<>0 and p.MarketDate >= getdate() -2
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

UNION
--DsQtRI6
select Row_Number () over (partition by p.Infocode, p.ExchIntCode order by p.MarketDate) as 
Row,	p.MarketDate, p.ExchIntCode, s.Sedol, s.DsCode, s.DsQtName, s.Infocode, p.ClosingPrice, r.RI, e.TableID
from DsCtryQtInfo s join DsQtPrice6 p on (p.InfoCode=s.InfoCode) join DsQtRI6 r on (p.InfoCode=r.InfoCode)
join DsExchQtInfo e on (p.infocode=e.infocode) and (r.MarketDate=p.MarketDate) and (p.ExchIntCode=r.ExchIntCode)
and r.RI<>0 and p.MarketDate >= getdate() -2
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
)

Select p.Infocode, p.DsCode, p.Sedol, p.Name, p.MarketDate, p.ClosingPrice, p.RI,
p2.MarketDate as PrevDate, p2.ClosingPrice as PrevClose, p2.RI as PrevRI,
(((p.RI - p2.RI) / p2.RI)) * 100  as Change,	p.ExchIntCode, p.TableID
from DsPricing p join DsPricing p2 on (p.infocode=p2.infocode) and (p.ExchIntCode=p2.ExchIntCode) 
and (p.row -1 = p2.row) where (p.ClosingPrice between 2 and 5.01 and ((p.RI / p2.RI)-1) not between -.50 and .50)
or (p.ClosingPrice > 5 and ((p.RI / p2.RI)-1) not between -.20 and .20)
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
order by p.TableID, p.ExchIntCode, p.Infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_RI_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 7:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=193000, 
		@active_end_time=235959, 
		@schedule_uid=N'92c127a4-a78a-4bd0-b62c-704eb24679db'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS_SecType Diff (with IDC)]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS_SecType Diff (with IDC)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for mismatches in sectype between IDC and DataStream, where IDC has "preferred" and DS has "ordinary share" (EQ).             IDC "unit" currently commented out.                                    Teamtrack #971502 (Newgate)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--SecType Diff btwn IDC & DS for preferreds & units (currently commented out), #971502
--Filtering out DsCodes where DS maintains the type s/b "EQ."

Select q.Region, q.DsCode, i.sedol as CuSed, q.DsQtName, q.TypeCode, r.desc_ as DS_SecType,
i.Issuer as "IDC Name", i.SecType as "IDC SecType", d.desc_ as "IDC Description"
from gprcinfo2 i join gprccode d on (i.sectype = d.code) and d.type_ = 76 
join ds2sedolchg c on (i.sedol = c.sedol) join ds2ctryqtinfo q on (c.infocode = q.infocode) 
join ds2xref r on (q.typecode = r.code) and r.type_ = 2 where i.sectype in (''31'',''32'',''34'',''35'') --and i.sectype=(''54'') 
and q.typecode = ''eq'' and i.health = ''1'' and q.DsCode not in (''13765V'', ''682060'', ''31425F'',''50967P'', ''25502W'',
''77110N'',''502750'',''264308'',''70869U'', ''27687E'', ''87061X'')

UNION

Select q.Region, q.DsCode, i.Cusip as CuSed, q.DsQtName, q.TypeCode, r.desc_ as DS_SecType,
i.Issuer as "IDC Name", i.SecType as "IDC SecType", d.desc_ as "IDC Description"
from prc.prcinfo i join prccode2 d on (i.sectype = char(d.code)) and d.type_ = 1 
join ds2cusipchg c on (i.cusip= c.cusip) join ds2ctryqtinfo q on (c.infocode = q.infocode) 
join ds2xref r on (q.typecode = r.code) and r.type_ = 2 where i.sectype in (''P'') --and i.sectype in (''U'') 
and q.typecode = ''EQ'' and i.status=''0'' and q.DsCode not in (''15421W'', ''13900J'', ''14691J'', ''29269U'', ''41104D'',
''26817D'', ''30202H'',''77110N'',''502750'',''264308'',''70869U'', ''27687E'', ''87061X'')

UNION

Select q.Region, q.DsCode, i.Cusip as CuSed, q.DsQtName, q.TypeCode, r.desc_ as DS_SecType,
i.Issuer as "IDC Name", i.SecType as "IDC SecType", d.desc_ as "IDC Description"
from cprcinfo i join prccode2 d on (i.sectype = char(d.code)) and d.type_ = 1 
join ds2cusipchg c on (i.cusip= c.cusip) join ds2ctryqtinfo q on (c.infocode = q.infocode) 
join ds2xref r on (q.typecode = r.code) and r.type_ = 2 where i.sectype in (''P'') --and i.sectype in (''U'') 
and q.typecode = ''EQ'' and i.status=''0'' and q.DsCode not in (''15421W'', ''13900J'', ''14691J'', ''29269U'', ''41104D'',
''26817D'', ''30202H'',''77110N'',''502750'',''264308'',''70869U'')

order by Region, CuSed

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS\DS_SecType Diff_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'349dcb04-c560-4756-9b60-b53739c36662'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_AdjType1]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_AdjType1', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'In DS2, scans for splits (SPLT, REVS, STKD) that are in AdjType=2 (all cap events) but not AdjType=1 (splits only).  #981455', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Splits not included in Type 1 but in Type 2
Select ''STKD'' as Region, i.DsCode, e.InfoCode, e.EventNum, e.ActionTypeCode, e.EffectiveDate
from Ds2CapEvent e join Ds2CtryQtInfo i on (i.infocode=e.infocode)
where ActionTypeCode=''STKD'' and not exists (select * from Ds2Adj a where AdjType=1 and 
(a.infocode=e.infocode) and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7))) 
and exists (select * from Ds2Adj a where AdjType=2 and 
(a.infocode=e.infocode) and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7)))
UNION
Select ''SPLT'' as Region, i.DsCode, e.InfoCode, e.EventNum, e.ActionTypeCode, e.EffectiveDate
from Ds2CapEvent e join Ds2CtryQtInfo i on (i.infocode=e.infocode)
where ActionTypeCode=''SPLT'' and not exists (select * from Ds2Adj a where AdjType=1 and 
(a.infocode=e.infocode) and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7)))
and exists (select * from Ds2Adj a where AdjType=2 and 
(a.infocode=e.infocode) and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7)))
UNION
Select ''REVS'' as Region, i.DsCode, e.InfoCode, e.EventNum, e.ActionTypeCode, e.EffectiveDate
from Ds2CapEvent e join Ds2CtryQtInfo i on (i.infocode=e.infocode)
where ActionTypeCode=''REVS'' and not exists (select * from Ds2Adj a where AdjType=1 and 
(a.infocode=e.infocode) and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7)))
and exists (select * from Ds2Adj a where AdjType=2 and 
(a.infocode=e.infocode) and (a.AdjDate between e.EffectiveDate and (e.EffectiveDate+7)))

order by e.InfoCode, Region, e.EffectiveDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_AdjType1_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Saturday 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=64, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'54eef44e-f470-4e9d-a5c5-1eced288ab5a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Citi_Checks]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Citi_Checks', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:55 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--overlapping sedols check
select ''DS2SedolChg'' as ''table'', InfoCode, EndDate, COUNT(1) from  DS2SEDOLChg group by InfoCode, EndDate having COUNT(1)>1
--overlapping cusips check
select ''DS2CUSIPChg'' as ''table'', InfoCode, EndDate, COUNT(1) from  DS2CUSIPChg group by InfoCode, EndDate having COUNT(1)>1
--overlapping isins check
select ''DS2ISINChg'' as ''table'', DsSecCode, EndDate, COUNT(1) from  DS2ISINChg group by DsSecCode, EndDate having COUNT(1)>1
--multiple isprim check
select ''DS2Security'' as ''table'', *
from DS2Security s
where (select COUNT(*) from DS2CtryQtInfo where DsSecCode = s.DsSecCode and IsPrimQt = ''1'') > 1
--multiple ismajorsec check
select ''DS2Company'' as ''table'', *
from DS2Company s
where (select COUNT(*) from DS2Security where DsCmpyCode = s.DsCmpyCode and IsMajorSec = ''y'') > 1
--overlapping adj check
select ''DS2CtryQtInfo'' as ''table''
from DS2CtryQtInfo i
where infocode in (select InfoCode from DS2Adj where i.InfoCode = InfoCode and AdjDate > isnull(EndAdjDate,''2079-01-01''))
--multiple seccode check
select ''SecMapX'' as ''table'', VenCode, VenType, EndDate, COUNT(1) from  SecMapX where VenType in (2,33,10,25) and RANK=1 group by VenCode, VenType, EndDate having COUNT(1)>1

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_Citi_Check_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily Schedule', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140509, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'9ff6455b-acee-4e24-99ac-e476b5a45448'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_ConsolMktVal]    Script Date: 3/15/2016 8:55:55 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:55 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_ConsolMktVal', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Checks DS''s MVC (consolidated market value) for 100% moves within last two trading days.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DataStream Consolidated Market Value
select i.ID, d.DsCode, d.DsQtName, v1.*, v2.*
from secmstrx i join secmapx x on (i.seccode=x.seccode) and x.ventype=33
join ds2ctryqtinfo d on (x.vencode=d.infocode) join ds2mktval v1 on (d.infocode=v1.infocode)
join ds2mktval v2 on (d.infocode=v2.infocode) and (v1.infocode=v2.infocode) and (v1.ValDate=v2.ValDate)
where v1.ConsolMktVal > (2*v2.ConsolMktVal) and v1.ValDate>=getdate()-2 
UNION
--Global
select i.ID, d.DsCode, d.DsQtName, v1.*, v2.*
from gsecmstrx i join gsecmapx x on (i.seccode=x.seccode) and x.ventype=33
join ds2ctryqtinfo d on (x.vencode=d.infocode) join ds2mktval v1 on (d.infocode=v1.infocode)
join ds2mktval v2 on (d.infocode=v2.infocode) and (v1.infocode=v2.infocode) and (v1.ValDate=v2.ValDate)
where v1.ConsolMktVal > (2*v2.ConsolMktVal) and v2.ValDate>=getdate()-2 
order by d.DsQtName

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_ConsolMktVal_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:00pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=200000, 
		@active_end_time=235959, 
		@schedule_uid=N'14d121b4-d0b1-4d89-ad54-09570ec49267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_CurrDiff]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_CurrDiff', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for mismatches in ISOCurrCode between Ds2ExchQtInfo & DS2 pricing tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DsExchQtInfo CURRENCY does not match Pricing CURRENCY

Select distinct i.DsCode, p.InfoCode, e.IsPrimExchQt, e.ISOCurrCode as "ExchQt Curr", p.ISOCurrCode as "Price Curr"
from ds2ctryqtinfo i join ds2exchqtinfo e on (i.infocode=e.infocode) join ds2primqtprc p on (e.infocode=p.infocode) 
join ds2exchange x on (e.ExchIntCode=x.ExchIntCode) where e.IsPrimExchQt=''Y'' and e.ISOCurrCode!=p.ISOCurrCode
group by i.DsCode, p.InfoCode, e.IsPrimExchQt, e.ISOCurrCode, p.ISOCurrCode

UNION

Select distinct i.DsCode, p.InfoCode, e.IsPrimExchQt, e.ISOCurrCode as "ExchQt Curr", p.ISOCurrCode as "Price Curr"
from ds2ctryqtinfo i join ds2exchqtinfo e on (i.infocode=e.infocode) join ds2scdqtprc p on (e.infocode=p.infocode) 
join ds2exchange x on (e.ExchIntCode=x.ExchIntCode) where e.IsPrimExchQt=''N'' and e.ISOCurrCode!=p.ISOCurrCode
group by i.DsCode, p.InfoCode, e.IsPrimExchQt, e.ISOCurrCode, p.ISOCurrCode

order by i.DsCode, e.IsPrimExchQt

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_CurrDiff_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 5:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=50000, 
		@active_end_time=235959, 
		@schedule_uid=N'05cd41e6-a689-468b-869d-ee63e44924c5'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_CusipChk]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_CusipChk', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'By client request (ZBI, #950016), check Ds2CusipChg for incorrect/inconsistent check digits for cusips.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 cusip check digit check

Select distinct c.InfoCode, i.DsCode, c.Cusip
from ds2cusipchg c join ds2cusipchg c2 on (c.InfoCode = c2.InfoCode)
join ds2ctryqtinfo i on (c.infocode=i.infocode)
where c.cusip=c2.cusip and c.cusipchk!=c2.cusipchk
group by c.infocode, i.dscode, c.cusip order by InfoCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_CusipChk_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Dupe_VenCodes]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Dupe_VenCodes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This Query checks for InfoCode thats mapped to two different SecCodes with Rank=1 in GSecMapX Table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select VenCode,COUNT(SecCode)from GSecMapX where VenType=33 
and RANK=1 group by VenCode having COUNT(*)>1

----------------------------------------------------------------------------------------------------------------------------------------							
Declare @row_num INT							
SET @row_num = @@ROWCOUNT							
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
IF @row_num = 0                                                        PRINT ''***ZERO RESULTS***'';							
ELSE IF @row_num  > 0 AND @row_num <= 1	    PRINT ''***WARNING***'';		
ELSE                                                                           PRINT ''***CRITICAL***'';							
GO							
-----------------------------------------------------------------------------------------------------------------------------------------							
PRINT ''***CM:<<<BLR Team>>>|CM***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\DataStream\DS2_Dupe_Vencodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_E-_Numshrs_ds2numsharesj]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_E-_Numshrs_ds2numsharesj', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'If there is output, check DSAdvance to see what the value should be and correct.  If not clear what correct value should be, please open CZ ticket with them.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step1]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from ds2numshares where Numshrs like ''%E-%''

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<BLR Team>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_E-_Numshrs_ds2numsharesj_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 12:05am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=500, 
		@active_end_time=235959, 
		@schedule_uid=N'2156868f-2edd-4093-affd-cc08faa342fc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_IsinChgDates]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_IsinChgDates', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for overlapping dates in the ISIN change table (startdate earlier than previous ISIN''s EndDate).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Ds2IsinChg Overlapping Dates

WITH IsinChg as (select Row_Number () over (partition by i.DsSecCode order by i.DsSecCode, v.StartDate) as Row,
V.StartDate, v.EndDate, v.ISIN, i.DsSecCode from Ds2Security i join Ds2ISINchg V on i.DsSecCode = V.DsSecCode)
	
select b.DsSecCode, B.ISIN, B.StartDate, A.ISIN as PrevISIN, A.EndDate as EndDate
from IsinChg A join IsinChg B on a.DsSecCode=b.DsSecCode AND A.ROW = B.ROW-1
	and B.StartDate <= a.EndDate

order by b.DsSecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_IsinChgDates_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_LicFlag]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_LicFlag', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Reviews all DS2 tables with LicFlag fields and outputs records with LicFlag=0 (zero) or NULL.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Review DS2 tables with LicFlag.  LicFlag should not be zero or NULL.

Select ''Ds2Adj'' as Region, InfoCode as "(Code)" from ds2adj where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2CapEvent'' as Region, InfoCode as "(Code)" from ds2capevent where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2Div'' as Region, InfoCode as "(Code)" from ds2div where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2Dps'' as Region, InfoCode as "(Code)" from ds2dps where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2ExchQtInfo'' as Region, InfoCode as "(Code)" from ds2exchqtinfo where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2IsinChg'' as Region, DsSecCode as "(Code)" from ds2isinchg where LicFlagC is NULL or LicFlagC=''0''
UNION
select ''Ds2MktVal'' as Region, InfoCode as "(Code)" from ds2mktval where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2NumShares'' as Region, InfoCode as "(Code)" from ds2numshares where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2PrimExchQtChg'' as Region, InfoCode as "(Code)" from ds2primexchqtchg where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2PrimQtPrc'' as Region, InfoCode as "(Code)" from ds2primqtprc where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2PrimQtRI'' as Region, InfoCode as "(Code)" from ds2primqtri where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2ScdQtPrc'' as Region, InfoCode as "(Code)" from ds2scdqtprc where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2ScdQtRI'' as Region, InfoCode as "(Code)" from ds2scdqtri where LicFlag is NULL or LicFlag=''0''
UNION
select ''Ds2ShareHldgs'' as Region, InfoCode as "(Code)" from ds2sharehldgs where LicFlag is NULL or LicFlag=''0''

Order by Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_LicFlag_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_MissingCodes]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_MissingCodes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans DS2 tables for codes that are in one table but not the other.  DS2 counterpart to the (legacy) DS_MissingCodes check.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2
--InfoCodes in CtryQtInfo but not ExchQtInfo
Select ''DS2 InfoCode in CtryQtInfo'' as Region, i.InfoCode as "Missing InfoCode", i.DsCode, i.DsQtName from Ds2CtryQtinfo i where not exists (select * from Ds2ExchQtInfo e where i.InfoCode=e.InfoCode)
order by i.DsCode

--InfoCodes in ExchQtInfo but not CtryQtInfo
Select ''DS2 InfoCode in ExchQtInfo'' as Region, e.InfoCode as "Missing InfoCode", e.DsQtName, e.ExchIntCode, x.DsExchCode
from Ds2ExchQtInfo e join ds2exchange x on (e.ExchIntCode=x.ExchIntCode)
where not exists (select * from Ds2CtryQtInfo i where i.InfoCode=e.InfoCode) order by e.InfoCode

--DsSecCode in *CtryQtInfo but not *Security
Select ''DS2 DsSecCode in CtryQtInfo'' as Region, i.DsSecCode as "Missing DsSecCode", i.InfoCode, i.DsCode from Ds2CtryQtinfo i where not exists (select * from Ds2Security s where i.DsSecCode=s.DsSecCode)
order by i.DsCode

--DsSecCode in *Security but not *CtryQtInfo
Select ''DS2 DsSecCode in Security'' as Region, s.DsSecCode as "Missing DsSecCode", s.DsSctyCode, 
s.DsCmpyCode as "TRDW Company Code", s.DsSecName
from Ds2Security s where not exists (select * from Ds2CtryQtInfo i where i.DsSecCode=s.DsSecCode)
order by s.DsSctyCode

--DsCmpyCode in *Security but not in *Company
Select ''DS2 CmpyCode In Security'' as Region, s.DsCmpyCode as "Missing DsCmpyCode", s.DsSecCode, s.DsSctyCode, 
s.DsSecName, s.PrimQtSedol
from Ds2Security s where not exists (select * from Ds2Company c where s.dscmpycode=c.dscmpycode)
order by s.DsSctyCode

--DsCmpyCode in *Company but not in *Security
Select ''DS2 CmpyCode in Company'' as Region, c.DsCmpyCode as "Missing TRDW Company Code", 
c.DsCompCode as "TUNA DsCmpyCode", c.DsCmpyName
from Ds2Company c where not exists (select * from Ds2Security s where s.dscmpycode=c.dscmpycode)
order by c.DsCompCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_MissingCodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_MnemChg]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_MnemChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Reported by David Sargent (TRSL):  infocodes with more than one record having EndDate=20790605.  4038 in original run (June 2010).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Ds2MnemChg mulitple EndDate=20790605, reported by David Sargent

select InfoCode, count(*) as ''EndDate=20790605'' from ds2mnemchg where EndDate=''2079-06-05'' 
group by infocode having count(*) > 1 order by Infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_MnemChg_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=4
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Orphan_CspSdl]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Orphan_CspSdl', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Searching for orphan infocodes in Ds2CusipChg and Ds2SedolChg tables.  Requested by Nancy O''Hara (2/08/2011).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT ''Cusip'' as Region, CC.InfoCode, CC.Cusip as Identifier FROM Ds2CusipChg AS CC WITH (NOLOCK) LEFT OUTER JOIN Ds2CtryQtInfo AS CQI WITH (NOLOCK) 
ON CC.InfoCode = CQI.InfoCode WHERE CQI.InfoCode IS NULL

UNION 

SELECT ''Sedol'' as Region, SC.InfoCode, SC.Sedol as Identifier FROM Ds2SedolChg AS SC WITH (NOLOCK) LEFT OUTER JOIN Ds2CtryQtInfo AS CQI WITH (NOLOCK)
ON SC.InfoCode = CQI.InfoCode WHERE CQI.InfoCode IS NULL

Order by Region, InfoCode
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_Orphan_SdlCsp_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=8
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Orphan_Isin]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Orphan_Isin', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Searching for orphan dsseccodes in Ds2IsinChg.
Requested by Nancy O''Hara (2/08/2011).
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT IC.* FROM Ds2IsinChg AS IC WITH (NOLOCK) LEFT OUTER JOIN Ds2Security AS SEC WITH (NOLOCK) 
ON IC.DsSecCode = SEC.DsSecCode WHERE SEC.DsSecCode IS NULL
order by DsSecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_Orphan_ISIN_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Overlapping_Cusip_StartEndDates]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Overlapping_Cusip_StartEndDates', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This Query checks for cases when the Cusip StartDate and/or the EndDate are the same for in DS2CUSIPChg Table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:56 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from DS2CUSIPChg where InfoCode in(
select a.InfoCode from
(select *,ROW_NUMBER()over(partition by InfoCode order by StartDate)as i from DS2CUSIPChg) a left join
(select *,ROW_NUMBER()over(partition by InfoCode order by StartDate)as i from DS2CUSIPChg) b
on a.InfoCode=b.InfoCode and a.i=b.i-1
where a.EndDate>=b.StartDate
) order by InfoCode,EndDate 

----------------------------------------------------------------------------------------------------------------------------------------							
Declare @row_num INT							
SET @row_num = @@ROWCOUNT							
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
IF @row_num = 0                                                        PRINT ''***ZERO RESULTS***'';							
ELSE IF @row_num  > 0 AND @row_num <= 1	    PRINT ''***WARNING***'';		
ELSE                                                                           PRINT ''***CRITICAL***'';							
GO							
-----------------------------------------------------------------------------------------------------------------------------------------							
PRINT ''***CM:<<<BLR Team>>>|CM***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
							
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\DataStream\DS2_Overlapping_Cusip_StartEndDates_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Overlapping_Cusips]    Script Date: 3/15/2016 8:55:56 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:56 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Overlapping_Cusips', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This Query will check for one Infocode with different cusips on the same date i.e. overlapping cusip dates in Ds2CusipChg Table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from DS2CUSIPChg where InfoCode in(
select InfoCode from DS2CUSIPChg where EndDate>=''2079-01-01''
group by InfoCode having COUNT(distinct Cusip)>1
)order by InfoCode,EndDate



----------------------------------------------------------------------------------------------------------------------------------------							
Declare @row_num INT							
SET @row_num = @@ROWCOUNT							
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
IF @row_num = 0                                                        PRINT ''***ZERO RESULTS***'';							
ELSE IF @row_num  > 0 AND @row_num <= 1	    PRINT ''***WARNING***'';		
ELSE                                                                           PRINT ''***CRITICAL***'';							
GO							
-----------------------------------------------------------------------------------------------------------------------------------------							
PRINT ''***CM:<<<BLR Team>>>|CM***''							
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\DataStream\DS2_Overlapping_Cusips_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'349dcb04-c560-4756-9b60-b53739c36662'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_PriceOutliers(Pri)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_PriceOutliers(Pri)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'2/24/2010  Counterpart to various IDC price checks.  Searches for instances in the previous trading date where High > 2 * open or close; Low < .5 * open or close; open > 2 * close; and close > 2 * open.  (Combines IDC''s HLOC & Daily_OC_Diff checks).  Both OPEN and CLOSE must be greater than 2, volume greater than 0 (zero).  **Pulling sedol & cusip from legacy DsCtryQtInfo.  8/14/12 Market filters applied (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Primary Pricing outliers, high > 2* open or close, low < .5* open or close; open > 2 * close or close> 2 * open.

select s.Infocode, s.DsCode, S.DsQtName, p.MarketDate, round(p.Open_,4) "Open", 
round(p.High,4) "High", round(p.Low,4) "Low", round(p.Close_,4) "Close", p.Bid, p.Ask, p.Volume, p.ISOCurrCode, 
e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
from ds2ctryqtinfo s join ds2PrimQtPrc p on (s.infocode=p.infocode) 
join ds2exchange e on (p.exchintcode=e.exchintcode)
and p.marketdate = (select filedate from update_status where tablename=''ds2primqtprc'')

where p.RefPrcTypCode=1 and p.ExchIntCode not in (4,73,99,104,111,116,157,161,186,199,229)

and (p.open_ > 2.01 and p.close_ > 2.01 and p.Volume <> 0)
and (p.high > (2 * open_) or p.high > (2 * close_) or p.low < (.5 * open_) or p.low < (.5 * close_)
or p.open_ > (2 * close_) or p.close_ > (2 * open_))
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_PriceOutliers(Pri)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_PriceOutliers(Sec)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_PriceOutliers(Sec)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'2/24/2010  In DS''s Secondary Exchange pricing table - counterpart to various IDC price checks.  Searches for instances in the previous trading date where High > 2 * open or close; Low < .5 * open or close; open > 2 * close; and close > 2 * open.  (Combines IDC''s HLOC & Daily_OC_Diff checks).  Both OPEN and CLOSE must be greater than 2, volume greater than 0 (zero).  **Pulling sedol & cusip from legacy DsCtryQtInfo.  8/14/12 Market filters applied (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Secondary Exchange Pricing outliers, high > 2* open or close, low < .5* open or close; open > 2 * close or close> 2 * open.

select s.Infocode, s.DsCode, S.DsQtName, p.MarketDate, 
round(p.Open_,4) "Open", round(p.High,4) "High", round(p.Low,4) "Low", round(p.Close_,4) "Close", 
p.Bid, p.Ask, p.Volume, p.ISOCurrCode, e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
from ds2ctryqtinfo s join ds2ScdQtPrc p on (s.infocode=p.infocode) 
join ds2exchange e on (p.exchintcode=e.exchintcode)
and p.marketdate = (select filedate from update_status where tablename=''ds2primqtprc'')

where p.RefPrcTypCode=1 and p.ExchIntCode not in (4,73,99,104,111,116,157,161,186,199,229)

and (p.open_ > 2.01 and p.close_ > 2.01 and p.Volume <> 0)
and (p.high > (2 * open_) or p.high > (2 * close_) or p.low < (.5 * open_) or p.low < (.5 * close_)
or p.open_ > (2 * close_) or p.close_ > (2 * open_))
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
order by p.ExchIntCode, p.infocode
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_PriceOutliers(Sec)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_PriceViolations(Pri)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_PriceViolations(Pri)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'DataStream Primary pricing check, on DS2'' Ds2PrimQtPrc, to look for High < Low, Low > Open > High, Low > Close > High.  *Replacing the "DS_OHLC_Violations" check.  Qualifier:  RefPrcTypCode=1 (1 means price is final).  *Pulls sedol & cusip from legacy DsCtryQtInfo table.  3/02/11 Excluding Karachi (ExchIntCode 88) because CLOSE is an evaluated price.  8/14/12 Market filters added (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Primary HL range violations, and RefPrcTypCode=1 (price is final)

SELECT s.Infocode, s.DsCode, S.DsQtName, p.MarketDate, ROUND(p.Open_,4) "Open", 
ROUND(p.High,4) "High", ROUND(p.Low,4) "Low", ROUND(p.Close_,4) "Close", p.Bid, p.Ask, p.Volume, 
p.ConsolVol, p.ISOCurrCode, e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
FROM Ds2CtryQtInfo s join ds2PrimQtPrc p on (s.infocode=p.infocode)
join ds2exchange e on (p.exchintcode=e.exchintcode)
	and p.marketdate = (SELECT FILEDATE FROM UPDATE_STATUS WHERE TABLENAME = ''ds2primqtprc'')

WHERE p.RefPrcTypCode=1 and p.ExchIntCode not in (4,73,88, 99,104,111,116,157,161,186,199,229)

and (p.close_ > p.high or p.open_ > p.High or p.Close_ < p.Low or p.Open_ < Low) or (p.High < p.Low)
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_PriceViolations(Pri)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_PriceViolations(Sec)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_PriceViolations(Sec)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'DataStream Primary pricing check, on DS2'' Ds2ScdQtPrc, to look for High < Low, Low > Open > High, Low > Close > High.  *Replacing the "DS_OHLC_Violations" check.  Qualifier:  RefPrcTypCode=1 (1 means price is final).  *Pulls sedol & cusip from legacy DsCtryQtInfo table.  *3/02/11 Excluded Karachi (exchintcode 88) b/c CLOSE is an evaluated price.  8/14/12 Market filters added (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Secondary HL range violations, and RefPrcTypCode=1 (price is final)

SELECT s.Infocode, s.DsCode, S.DsQtName, p.MarketDate, ROUND(p.Open_,4) "Open", 
ROUND(p.High,4) "High", ROUND(p.Low,4) "Low", ROUND(p.Close_,4) "Close", p.Bid, p.Ask, p.Volume, 
p.ConsolVol, p.ISOCurrCode, e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
FROM Ds2CtryQtInfo s join ds2ScdQtPrc p on (s.infocode=p.infocode)
join ds2exchange e on (p.exchintcode=e.exchintcode)
	and p.marketdate = (SELECT FILEDATE FROM UPDATE_STATUS WHERE TABLENAME = ''ds2primqtprc'')

WHERE p.RefPrcTypCode=1 and p.ExchIntCode not in (4,73,88, 99,104,111,116,157,161,186,199,229)

and (p.close_ > p.high or p.open_ > p.High or p.Close_ < p.Low or p.Open_ < Low) or (p.High < p.Low)
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_PriceViolations(Sec)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_QuoteOutliers(Pri)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_QuoteOutliers(Pri)', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'2/24/2010  A counterpart to the IDC checks that looks at CLOSE and BID/ASK relationships.  Close/Bid or Close/Ask that is greater than 25% is flagged for review.  **Sedol and Cusip pulled from legacy DsCtryQtInfo.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Primary Close/Bid/Ask:  close/bid or close/ask 

select s.Infocode, s.DsCode, S.DsQtName, p.MarketDate, round(p.Open_,4) "Open", 
round(p.High,4) "High", round(p.Low,4) "Low", round(p.Close_,4) "Close", p.Bid, p.Ask, p.Volume, p.ConsolVol, 
p.ISOCurrCode, e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
from Ds2CtryQtInfo s join ds2primqtprc p on (s.infocode=p.infocode)
join ds2exchange e on (p.exchintcode=e.exchintcode)
and p.marketdate = (select filedate from update_status where tablename=''ds2primqtprc'')
where p.RefPrcTypCode=1 and (p.open_ > 2.01 and p.close_ > 2.01 and p.bid > 0 and p.ask > 0 and p.Volume <> 0)
and ((p.close_/p.bid) not between -1.25 and 1.25) and ((p.close_/p.ask) not between -1.25 and 1.25)

order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_QuoteOutliers(Pri)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_QuoteOutliers(Sec)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_QuoteOutliers(Sec)', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'2/24/2010  DS Secondary Exchange pricing - counterpart to the IDC checks that looks at CLOSE and BID/ASK relationships.  Close/Bid or Close/Ask that is greater than 25% is flagged for review.  **Sedol and Cusip pulled from legacy DsCtryQtInfo.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Secondary Close/Bid/Ask:  close/bid or close/ask

select s.Infocode, s.DsCode, S.DsQtName, p.MarketDate, round(p.Open_,4) "Open", 
round(p.High,4) "High", round(p.Low,4) "Low", round(p.Close_,4) "Close", p.Bid, p.Ask, p.Volume, p.ConsolVol, 
p.ISOCurrCode, e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
from Ds2CtryQtInfo s join ds2ScdQtPrc p on (s.infocode=p.infocode)
join ds2exchange e on (p.exchintcode=e.exchintcode)
and p.marketdate = (select filedate from update_status where tablename=''ds2primqtprc'')
where p.RefPrcTypCode=1 and (p.open_ > 2.01 and p.close_ > 2.01 and p.bid > 0 and p.ask > 0 and p.Volume <> 0)
and ((p.close_/p.bid) not between -1.25 and 1.25) and ((p.close_/p.ask) not between -1.25 and 1.25)

order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_QuoteOutliers(Sec)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_RI(Pri)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_RI(Pri)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Return Index check in Ds2PrimQtRI.  QC check that outputs Datastream infocodes that have return index (RI) moves greater than 20% and close > 2.00.  8/14/12 Market filters added (list provided by Lisa Conner).  9/19/2012 At Lisa Conner''s request market cap added to output.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Primary RI
select i.Infocode, i.Dscode, i.DsQtName, i.TypeCode, p1.ExchIntCode, p1.MarketDate, p1.Close_, p1.Volume, r1.RI,
p2.MarketDate as PrevDate, p2.Close_ as PrevClose, p2.Volume as PrevVol, r2.RI as PrevRI, s.NumShrs, round((p1.Close_ * s.NumShrs),2) as MktCap
from ds2ctryqtinfo i join ds2primqtprc p1 on (i.infocode=p1.infocode)
join ds2primqtri r1 on (i.infocode=r1.infocode) and (p1.MarketDate=r1.MarketDate)
join ds2primqtprc p2 on (i.infocode=p2.infocode) and (p1.MarketDate-1=p2.MarketDate)
join ds2primqtri r2 on (i.infocode=r2.infocode) and (r1.MarketDate-1=r2.MarketDate)
join ds2numshares s on (i.infocode=s.infocode) 
and s.EventDate = (select top 1 EventDate from ds2numshares where infocode=s.infocode order by EventDate desc)
where (p1.Volume is not NULL or p1.Volume<>0) and (p2.Volume is not NULL or p2.Volume<>0)
and p1.MarketDate>=GetDate()-2
and p1.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
and p1.Close_ between 2 and 5 and ((r1.RI / r2.RI) -1) not between -.5 and .5

UNION

select i.Infocode, i.Dscode, i.DsQtName, i.TypeCode, p1.ExchIntCode, p1.MarketDate, p1.Close_, p1.Volume, r1.RI,
p2.MarketDate as PrevDate, p2.Close_ as PrevClose, p2.Volume as PrevVol, r2.RI as PrevRI, s.NumShrs, round((p1.Close_ * s.NumShrs),2) as MktCap
from ds2ctryqtinfo i join ds2primqtprc p1 on (i.infocode=p1.infocode)
join ds2primqtri r1 on (i.infocode=r1.infocode) and (p1.MarketDate=r1.MarketDate)
join ds2primqtprc p2 on (i.infocode=p2.infocode) and (p1.MarketDate-1=p2.MarketDate)
join ds2primqtri r2 on (i.infocode=r2.infocode) and (r1.MarketDate-1=r2.MarketDate)
join ds2numshares s on (i.infocode=s.infocode) 
and s.EventDate = (select top 1 EventDate from ds2numshares where infocode=s.infocode order by EventDate desc)
where (p1.Volume is not NULL or p1.Volume<>0) and (p2.Volume is not NULL or p2.Volume<>0)
and p1.MarketDate>=GetDate()-2
and p1.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
and p1.Close_ > 5 and ((r1.RI / r2.RI) -1) not between -.2 and .2

Order by p1.ExchIntCode, MktCap desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_RI(Pri)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 7:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=193000, 
		@active_end_time=235959, 
		@schedule_uid=N'92c127a4-a78a-4bd0-b62c-704eb24679db'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_RI(Sec)]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_RI(Sec)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'DS2 RI check on Ds2ScdQtRI.  QC check that outputs Datastream infocodes that have return index (RI) moves greater than 25% and close > 2.00.  8/14/12 Market filter added (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Secondary RI

select i.Infocode, i.Dscode, i.DsQtName, i.TypeCode, p1.ExchIntCode, p1.MarketDate, p1.Close_, p1.Volume, r1.RI,
p2.MarketDate as PrevDate, p2.Close_ as PrevClose, p2.Volume as PrevVol, r2.RI as PrevRI, s.NumShrs, round((p1.Close_ * s.NumShrs),2) as MktCap
from ds2ctryqtinfo i join ds2scdqtprc p1 on (i.infocode=p1.infocode)
join ds2scdqtri r1 on (i.infocode=r1.infocode) and (p1.MarketDate=r1.MarketDate)
join ds2scdqtprc p2 on (i.infocode=p2.infocode) and (p1.MarketDate-1=p2.MarketDate) and (p1.ExchIntCode=p2.ExchIntCode)
join ds2scdqtri r2 on (i.infocode=r2.infocode) and (r1.MarketDate-1=r2.MarketDate) and (r1.ExchIntCode=r2.ExchIntCode)
join ds2numshares s on (i.infocode=s.infocode) 
and s.EventDate = (select top 1 EventDate from ds2numshares where infocode=s.infocode order by EventDate desc)
where (p1.Volume is not NULL or p1.Volume<>0) and (p2.Volume is not NULL or p2.Volume<>0)
and p1.MarketDate>=GetDate()-2
and p1.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
and (p1.Close_ between 2 and 5 and p2.Close_ between 2 and 5)
and ((r1.RI / r2.RI) -1) not between -.5 and .5

UNION

select i.Infocode, i.Dscode, i.DsQtName, i.TypeCode, p1.ExchIntCode, p1.MarketDate, p1.Close_, p1.Volume, r1.RI,
p2.MarketDate as PrevDate, p2.Close_ as PrevClose, p2.Volume as PrevVol, r2.RI as PrevRI, s.NumShrs, round((p1.Close_ * s.NumShrs),2) as MktCap
from ds2ctryqtinfo i join ds2scdqtprc p1 on (i.infocode=p1.infocode)
join ds2scdqtri r1 on (i.infocode=r1.infocode) and (p1.MarketDate=r1.MarketDate)
join ds2scdqtprc p2 on (i.infocode=p2.infocode) and (p1.MarketDate-1=p2.MarketDate) and (p1.ExchIntCode=p2.ExchIntCode)
join ds2scdqtri r2 on (i.infocode=r2.infocode) and (r1.MarketDate-1=r2.MarketDate) and (r1.ExchIntCode=r2.ExchIntCode)
join ds2numshares s on (i.infocode=s.infocode) 
and s.EventDate = (select top 1 EventDate from ds2numshares where infocode=s.infocode order by EventDate desc)
where (p1.Volume is not NULL or p1.Volume<>0) and (p2.Volume is not NULL or p2.Volume<>0)
and p1.MarketDate>=GetDate()-2
and p1.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)
and p1.Close_ > 5 and ((r1.RI / r2.RI) -1) not between -.2 and .2

Order by p1.ExchIntCode, MktCap desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_RI(Sec)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 7:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=193000, 
		@active_end_time=235959, 
		@schedule_uid=N'92c127a4-a78a-4bd0-b62c-704eb24679db'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Status]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Status', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Counterpart to IDC checks that compare non-active status versus the pricing record.  If there are prices or quotes for the previous day and the status says security is DEAD or SUSPENDED, then either the status or the prices are wrong.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Status check:  status is (D)ead or (S)uspended but still getting 
--close and/or bid/ask.

select i.StatusCode, i.InfoCode, i.DsCode, i.DsQtName, i.DsMnem, i.TypeCode, 
p. MarketDate, p.Close_, p.Bid, p.Ask, i.Region, i.CovergCode
from ds2ctryqtinfo i join ds2primqtprc p on (i.infocode=p.infocode)
where statuscode!=''A'' 
--and p.marketdate > (select filedate from update_status where tablename=''ds2primqtprc'')
and p.marketdate > GetDate()+1
order by i.Statuscode, i.Infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_Status_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_Volume]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_Volume', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'DataStream provides Volume and Consolidated Volume (ConsolVol not populated in most cases).  This looks for any cases where Volume > ConsolVol.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 Volume, when Volume > ConsolVol

select p.infocode, s.DsCode, p.ExchIntCode, e.ExchMnem, S.DsQtName, p.MarketDate, 
p.Volume, p.ConsolVol, p.ISOCurrCode, e.ExchName, e.ExchCtryCode
from ds2ctryqtinfo s join ds2primqtprc p on (s.infocode=p.infocode) 
join ds2exchange e on (p.exchintcode=e.exchintcode)
and p.marketdate = (select filedate from update_status where tablename=''ds2primqtprc'')
where p.RefPrcTypCode=1 and p.volume > p.consolvol

order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_Volume_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DS2_VWAP]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DS2_VWAP', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Counterpart to IDC VWAP check, looking for VWAPs > high or VWAPs < low.  At the time of this check DataStream only provides VWAPs for US and Canadian markets.  8/14/12 Market filters added (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:57 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS2 VWAP:  VWAP < Low or VWAP > High

select s.Infocode, s.DsCode, s.DsQtName, p.MarketDate, round(p.High,4) "High", round(p.Low,4) "Low", 
round(p.Close_,4) "Close", p.VWAP, p.Volume, p.ISOCurrCode, 
e.ExchName, e.ExchCtryCode, p.ExchIntCode, e.ExchMnem
from ds2ctryqtinfo s join ds2PrimQtPrc p on (s.infocode=p.infocode) 
join ds2exchange e on (p.exchintcode=e.exchintcode)
and p.marketdate = (select filedate from update_status where tablename=''ds2primqtprc'')

where p.RefPrcTypCode=1

and volume <> 0 and (round(p.VWAP,2) > round(p.High,2) or round(p.VWAP,2) < round(p.Low,2))
and p.ExchIntCode in (12, 135, 145, 104, 163, 28, 78, 59, 116, 109, 111, 6, 215, 206, 45, 98, 200, 150, 189, 73, 90, 14, 132, 18, 22)

order by p.ExchIntCode, p.infocode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream\DS2_VWAP_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 7:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=193000, 
		@active_end_time=235959, 
		@schedule_uid=N'92c127a4-a78a-4bd0-b62c-704eb24679db'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DsIdx_Count_ConstData]    Script Date: 3/15/2016 8:55:57 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:57 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DsIdx_Count_ConstData', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Tracks constituent counts for indices in DsEqIdxListConstData.  (By request from Hiroshi Shiratori and Mary Ann Serrahn.)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS_ConCount_DsEqIdxListConstData
--DS Index constituent counts in DSEqIdxListConstData

select count(distinct d.EntityCode) as Constituent_Total, d.Date_, i.IndexListCode, i.IndexListName, i.IndexListMnem
from DsEqIdxListInfo i join DsEqIdxListConstData d on (i.IndexListCode=d.IndexListCode)
where d.date_ >= getdate()-4 group by d.date_, i.IndexListCode, i.IndexListName, i.IndexListMnem

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream Indices\DsIdx_Count_ConstData_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DsIdx_Count_DJS]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DsIdx_Count_DJS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Monthly constituent count check in DsMnthlyConstHstDJS.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS Monthly Constituents by SOURCE in DsMnthlyConstHst.
--DS_Count_DsMnthlyConstHstDJS
--Look for those that don''t have most recent month, and constituent totals (Total)

select ''DJS'' as Region, count(distinct d.ConstituentCode) as Constituent_Total, d.ValueDate, 
i.IndexListIntCode, i.IndexListDesc, i.IndexListCode 
from DsIndexList i join DsMnthlyConstHstDJS d on (i.IndexListIntCode=d.IndexListIntCode)
where d.valuedate >= getdate()-70 and i.IndexListIntCode=444 

group by d.valuedate, i.IndexListIntCode, i.IndexListDesc, i.IndexListCode

order by Region, i.IndexListIntCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream Indices\DsIdx_Count_DJS_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DsIdx_Count_Hst]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DsIdx_Count_Hst', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looking at constituent counts & that indices have been updated through most recently completed month.  At request of Hiroshi Shiratori and Mary Ann Serrahn.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS Monthly Constituents in DsMnthlyConstHst.
--Look for those that don''t have most recent month, and constituent totals (Total)

select ''DSMnthlyConstHst'' as Region, count(distinct d.ConstituentCode) as Constituent_Total, d.ValueDate, 
i.IndexListIntCode, i.IndexListDesc, i.IndexListCode 
from DsIndexList i join DsMnthlyConstHst d on (i.IndexListIntCode=d.IndexListIntCode)
where d.valuedate >= getdate()-70 and
i.IndexListIntCode in (149, 567, 53, 23, 7179, 157, 156, 214, 3907, 3905, 3906, 3909, 256, 265, 266,
13, 268, 6959, 6960, 6964, 6961, 6965, 6962, 6958, 6963, 128, 277, 517, 485, 419, 441, 570, 571, 3670, 
3453, 3462, 3900, 3901, 7153, 6165, 4124, 4344, 4029, 7736, 4224, 4290, 4356, 7186, 6967, 4401, 5548, 
5571, 5859, 4408, 4406, 7732, 4409, 136, 140, 6428, 4410) 
group by d.valuedate, i.IndexListIntCode, i.IndexListDesc, i.IndexListCode

order by IndexListIntCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream Indices\DsIdx_Count_Hst_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DsIDx_Count_TXA]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DsIDx_Count_TXA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Monthly constituent count check in DsMnthlyConstHstTXA.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS Monthly Constituents by SOURCE in DsMnthlyConstHst.
--DS_Count_DsMnthlyConstHstTXA
--Look for those that don''t have most recent month, and constituent totals (Total)

select ''DJS'' as Region, count(distinct d.ConstituentCode) as Constituent_Total, d.ValueDate, 
i.IndexListIntCode, i.IndexListDesc, i.IndexListCode 
from DsIndexList i join DsMnthlyConstHstTXA d on (i.IndexListIntCode=d.IndexListIntCode)
where d.valuedate >= getdate()-70 and i.IndexListIntCode in (6416, 6436, 4407)

group by d.valuedate, i.IndexListIntCode, i.IndexListDesc, i.IndexListCode

order by i.IndexListIntCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream Indices\DsIDx_Count_TXA_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DsIdx_Count_TXC]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DsIdx_Count_TXC', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Monthly constituent count check in DsMnthlyConstHstTXC.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS Monthly Constituents by SOURCE in DsMnthlyConstHst.
--DS_Count_DsMnthlyConstHstTXC
--Look for those that don''t have most recent month, and constituent totals (Total)

select ''DJS'' as Region, count(distinct d.ConstituentCode) as Constituent_Total, d.ValueDate, 
i.IndexListIntCode, i.IndexListDesc, i.IndexListCode 
from DsIndexList i join DsMnthlyConstHstTXC d on (i.IndexListIntCode=d.IndexListIntCode)
where d.valuedate >= getdate()-70 and i.IndexListIntCode in (6427)

group by d.valuedate, i.IndexListIntCode, i.IndexListDesc, i.IndexListCode

order by i.IndexListIntCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream Indices\DsIdx_Count_TXC_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [DsIdx_Count_TXS]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'DsIdx_Count_TXS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Monthly constituent count check in DsMnthlyConstHstTXS.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS Monthly Constituents by SOURCE in DsMnthlyConstHst.
--DS_Count_DsMnthlyConstHstTXS
--Look for those that don''t have most recent month, and constituent totals (Total)

select ''DJS'' as Region, count(distinct d.ConstituentCode) as Constituent_Total, d.ValueDate, 
i.IndexListIntCode, i.IndexListDesc, i.IndexListCode 
from DsIndexList i join DsMnthlyConstHstTXS d on (i.IndexListIntCode=d.IndexListIntCode)
where d.valuedate >= getdate()-70 and i.IndexListIntCode in (6428)

group by d.valuedate, i.IndexListIntCode, i.IndexListDesc, i.IndexListCode

order by i.IndexListIntCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Datastream Indices\DsIdx_Count_TXS_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Dupe_Mappings]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Dupe_Mappings', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Dupe mappings', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step 1]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step 1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select
p.vencode, p.exchange, count(1) cnt 
from
secmstrx m 
 join secmapx p 
 on p.seccode = m.seccode 
where
1=1 
 and m.type_ = 1 
 and p.ventype = 1 
 and p.exchange in (1
, 2) 
group by
p.VenCode
, p.exchange 
having
count(1) > 1


---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1           PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Nancy>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Dupe Mappings\Dupe_Mappings_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=126, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140711, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f44494-13fe-4f98-a83d-64108446a267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Economic Indicators]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Economic Indicators', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs the econ indicators with report dates from the last 7 days.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Updated Econ Ind from last 7 days
select b.ReportDate, a.Ticker, a.Name, b.PeriodDate, b.Estimate, b.Actual from 
econinfo a, econrpt b where a.code=b.code and b.reportdate >= GetDate()-7
order by b.reportdate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Econ\EconInd_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [failed_jobs]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'failed_jobs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This job checks for failed jobs on the current day.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select cast(sj.name as char(45)) as job_name, cast(jh.message as char(75)) as error_message, jh.run_date, jh.run_time, js.next_run_date, js.next_run_time,  cast(sj.description as char(125)) as job_description, sl.name as job_owner from msdb.dbo.sysjobhistory jh
join msdb.dbo.SysJobs sj on sj.job_id = jh.job_id
join msdb.dbo.SysJobSchedules js on js.job_id = jh.job_id
join msdb.dbo.SysJobSteps jst on jst.job_id = jh.job_id
join master.sys.syslogins sl on sj.owner_sid = sl.sid
where jh.run_date >= (select convert(varchar,getDate()-1,112)) and jh.message like ''The job failed%''
order by run_date, run_time

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          	PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1		PRINT ''***WARNING***'';
ELSE                                                                     		PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Denis - DISPLAYS ALL FAILED JOBS>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'msdb', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\failed_jobs\failed_jobs_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'failed_jobs', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20141209, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'a16d5e20-96d2-4b44-9eda-2d49c695bfb1'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IBES_DailyMeans_Orphans]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IBES_DailyMeans_Orphans', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for orphans between the DM estimates tables and the info tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT ''IBESUSDLYEST'' as Region, CODE FROM IBESUSDLYEST WHERE CODE NOT IN(SELECT CODE FROM IBESINFO3)
UNION
SELECT ''IBESINTDLYEST'' as Region, CODE FROM IBESINTDLYEST WHERE CODE NOT IN(SELECT CODE FROM IBGSINFO3)
order by Region, code

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IBES\IBESDM_Orphans_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090529, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'05a9074f-b8b4-491d-8d49-c2665ee5a12a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IBES_Dupe_Codes]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IBES_Dupe_Codes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Sweeps Ibesinfo3 & Ibgsinfo3 for duplicate CODEs.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Duplicate codes in Ibesinfo3, Ibgsinfo3
select ''Ibgsinfo3'' as REGION, Code, count(*) Total 
from ibgsinfo3 group by code having count(*) > 1

union

select ''Ibesinfo3'' as REGION, code, count(*) 
from ibesinfo3 group by code having count(*) > 1
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IBES\IBES_DupeCodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IBES_MappingViolations_Global]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IBES_MappingViolations_Global', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for IBES global mapping violations on Secmapx table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:58 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from gsecmapx a
join gsecmapx b
on a.ventype=b.ventype and a.vencode=b.vencode and a.rank=b.rank
where a.ventype=2 and a.rank=1
and a.seccode<b.seccode
and (a.startdate between b.startdate and isnull(b.enddate, ''6/6/2079'') 
or b.startdate between a.startdate and isnull(a.enddate, ''6/6/2079''))

----------------------------------------------------------------------------------------------------------------------------------------							
Declare @row_num INT							
SET @row_num = @@ROWCOUNT							
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';							
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';		
ELSE                                                                             PRINT ''***CRITICAL***'';							
GO							
-----------------------------------------------------------------------------------------------------------------------------------------							
PRINT ''***CM:<<<Celine>>>|CM***''							
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IBES\IBES_MappingViolations_Global_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IBES_MappingViolations_NA]    Script Date: 3/15/2016 8:55:58 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:58 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IBES_MappingViolations_NA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for IBES Mapping Violations in Secmapx table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from secmapx a
join secmapx b
on a.ventype=b.ventype and a.vencode=b.vencode and a.rank=b.rank
where a.ventype=2 and a.rank=1
and a.seccode<b.seccode
and (a.startdate between b.startdate and isnull(b.enddate, ''6/6/2079'') 
or b.startdate between a.startdate and isnull(a.enddate, ''6/6/2079''))
----------------------------------------------------------------------------------------------------------------------------------------							
Declare @row_num INT							
SET @row_num = @@ROWCOUNT							
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';							
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';		
ELSE                                                                             PRINT ''***CRITICAL***'';							
GO							
-----------------------------------------------------------------------------------------------------------------------------------------							
PRINT ''***CM:<<<Celine>>>|CM***''							
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IBES\IBES_MappingViolations_NA_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ADR_Missing]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ADR_Missing', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Sweeps US and Canadian adr tables, looking for sectype A (ADR) with no corresponding ADR ratio.  Based on complaint from Magnetar (#907184).  8/20/2009', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC ADR Ratio
Select ''US'' as Region, x.ID, d.Cusip as "Full Cusip", i.Issuer, i.Cusip, min(s.StartDate) as "First Date", i.Status
from secmstrx x join secmapx m on (x.seccode=m.seccode) 
and x.type_=1 and m.ventype=1 and m.exchange=1
join secmapx m1 on (x.seccode=m1.seccode) and m1.ventype=16 and m1.exchange=1
join prc.prcinfo i on (m.vencode=i.code) join prc.prcscchg s on (i.code=s.code)
join dsctryqtinfo d on (m1.vencode=d.infocode)
full outer join prc.prcadr a on (i.code=a.code) where i.currex in (''A'', ''B'', ''F'') and i.sectype=''A'' and a.code is NULL
group by x.Id, d.Cusip, i.Issuer, i.Cusip, i.Status

UNION

Select ''CA'' as Region, x.ID, d.Cusip as "Full Cusip", i.Issuer, i.Cusip, min(s.StartDate) as "First Date", i.Status
from secmstrx x join secmapx m on (x.seccode=m.seccode) 
and x.type_=1 and m.ventype=1 and m.exchange=2
join secmapx m1 on (x.seccode=m1.seccode) and m1.ventype=16 and m1.exchange=2
join cprcinfo i on (m.vencode=i.code) join cprcscchg s on (i.code=s.code)
join dsctryqtinfo d on (m1.vencode=d.infocode)
full outer join cprcadr a on (i.code=a.code) where i.sectype=''A'' and a.code is NULL
group by x.Id, d.Cusip, i.Issuer, i.Cusip, i.Status

Order by Region desc, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_ADR_Missing_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Bogus_SC_Records]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Bogus_SC_Records', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Nancy has found were not processing IDCs bulletin file properly and generating tons of bogus records in the US and Canadian security change tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Last night''s bogus entries in US and Canadia security change tables.

select ''USA'' as REGION, i.cusip, i.ticker as Info_Ticker, i.status, s.startdate, s.enddate, s.ticker, s.fullticker, s.issuer, i.code from prc.prcscchg s join prc.prcinfo i on (s.code=i.code)
where s.startdate in (select max(startdate) from prc.prcscchg) and s.ticker is not NULL and s.baseticker is NULL and s.startdate=s.enddate
union
select ''CAN'' as REGION, i.cusip, i.ticker as Info_Ticker, i.status, s.startdate, s.enddate, s.ticker, s.fullticker, s.issuer, i.code from cprcscchg s join cprcinfo i on (s.code=i.code)
where s.startdate in (select max(startdate) from prc.prcscchg) and s.ticker is not NULL and s.baseticker is NULL and s.startdate=s.enddate

order by region, i.cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								
ELSE                                                                     	      PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_Bogus_SC_Records_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Canadian_Full_Ticker]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Canadian_Full_Ticker', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch Full Tickers that have a .J in the name.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from cprcscchg where fullticker like (''%.j'')
		
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
		
		', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_Canadian_Full_Ticker_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Schedule', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130516, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'21ad6846-c6fa-486a-9cc7-a5041b0d8dac'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Canadian_Sedol_Mismatch]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Canadian_Sedol_Mismatch', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This was brought up by Menta Capital. TT#1038173. This will show discrepencies between CPRCSDLCHG and CPRCSCCHG table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select
	*
	from cprcscchg chg
	join cprcsdlchg sdl
	on chg.code = sdl.code
	and chg.startdate = (select max(startdate) from cprcscchg where code = chg.code)
	and sdl.startdate = (select max(startdate) from cprcsdlchg where code = chg.code)
	where chg.SEDOL <> sdl.SEDOL

select
	*
	from cprcscchg chg
	join cprcsdlchg sdl
	on chg.code = sdl.code
	and chg.startdate = (select max(startdate) from cprcscchg where code = chg.code)
	and sdl.startdate = (select max(startdate) from cprcsdlchg where code = chg.code)
	where chg.SEDOL <> sdl.SEDOL

	--missing SEDOLs in IDC that exists in DS
select * From ds2ctryqtinfo i
join DS2ExchQtInfo qi
on qi.infocode =i.infocode
and qi.IsPrimExchQt = ''Y''
join ds2sedolchg chg
on i.infocode = chg.infocode
where region = ''CA''
and chg.startdate > ''2014-05-1''
and not exists(select * from cprcscchg where sedol = chg.sedol)
and qi.exchintcode  <> 294
order by chg.sedol

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_Canadian_SEDOL_Mismatch_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'IDC Canadian Sedol Mismatch', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140513, 
		@active_end_date=99991231, 
		@active_start_time=40502, 
		@active_end_time=235959, 
		@schedule_uid=N'8407dc8c-d851-497a-a0ef-a433d13b842a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_CapAct Shrs]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_CapAct Shrs', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Compares IDC Global (gprccap) new & old shares to DS2 and outputs where the ratio is different.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC gprccap OldShares & NewShares ratios are incorrect, and don''t match DS2
SELECT
g.Id, g.Sedol, idc.ExDate, IDC.OLDSHARES/IDC.NEWSHARES [IDC_RATIO], idca.Factor, IDC.OLDSHARES, IDC.NEWSHARES,
DS.INFOCODE [DS_INFOCODE], ds.EventNum, DS.NUMOLDSHARES/DS.NUMNEWSHARES[DS_RATIO], DS.NUMOLDSHARES, DS.NUMNEWSHARES
FROM GPRCCAP IDC
      JOIN GSECMAPx M1 ON IDC.CODE = M1.VENCODE AND M1.VENTYPE = 1
      JOIN GSECMAPx M2 ON M1.SECCODE = M2.SECCODE AND M2.VENTYPE = 33
join gsecmstrx g on (m1.seccode=g.seccode)
      JOIN DS2CAPEVENT DS ON M2.VENCODE = DS.INFOCODE
      JOIN DS2ADJ DSA ON DS.INFOCODE = DSA.INFOCODE AND DSA.ADJTYPE = 2 -- Split and Spinoff
      JOIN GPRCADJ IDCA ON IDC.CODE = IDCA.CODE 
WHERE IDC.EXDATE = DS.EFFECTIVEDATE AND (DS.NUMOLDSHARES <> 0 AND DS.NUMNEWSHARES <> 0 AND IDC.OLDSHARES <> 0 AND IDC.NEWSHARES <> 0)
      AND (DS.NUMOLDSHARES/DS.NUMNEWSHARES <> IDC.OLDSHARES/IDC.NEWSHARES)
      AND (DSA.ENDADJDATE = IDCA.ENDDATE AND DSA.CUMADJFACTOR = IDCA.FACTOR)
ORDER BY Id, Exdate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_CapActShrs_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ChgDates_Bad]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ChgDates_Bad', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for StartDates > EndDates in US & CA security & ticker change tables OR start date is 1960-01-01 and end date is NULL.  Checks both *ScChg and *TkChg.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC_ChgDates_Bad
--Looks through Security & Ticker change tables for StartDates more recent than EndDates
--Or has a start date of 1/1/1960 and no end date.

Select ''US ScChg'' as Region, i.Cusip, c.StartDate, c.EndDate from prc.prcinfo i join prc.PrcScChg c on (i.code=c.code)
where startdate > enddate or (c.startdate=''1960-01-01'' and c.enddate is NULL) and i.cusip not in (''ZZ123456'')
UNION
select ''CA ScChg'' as Region, i.Cusip, c.StartDate, c.EndDate from cprcinfo i join cPrcScChg c on (i.code=c.code)
where startdate > enddate or (c.startdate=''1960-01-01'' and c.enddate is NULL)
UNION
select ''US TkChg'' as Region, i.Cusip, c.StartDate, c.EndDate from prc.prcinfo i join prc.PrcTkChg c on (i.code=c.code)
where startdate > enddate or (c.startdate=''1960-01-01'' and c.enddate is NULL) and i.cusip not in (''ZZ123456'')
UNION
select ''CA TkChg'' as Region, i.Cusip, c.StartDate, c.EndDate from cprcinfo i join cPrcTkChg c on (i.code=c.code)
where startdate > enddate or (c.startdate=''1960-01-01'' and c.enddate is NULL)
Order by Region, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_ChgDates_Bad _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Saturday 1:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=64, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=10000, 
		@active_end_time=235959, 
		@schedule_uid=N'f315c693-d1a2-4ae4-b17b-c69b19064088'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_CusipDiff(NA)]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_CusipDiff(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Checks for cusip differences in the US & Canada pricing database.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT ''USA'' as Region, I.Cusip as PRCINFO_Cusip, C.Cusip as PRCCHG_Cusip, S.Cusip as PRCSCCHG_Cusip, I.Issuer, S.Exchange, I.Status
FROM PRC.PRCINFO I LEFT JOIN	PRC.PRCCHG C ON	C.CODE = I.CODE
AND C.DATE_ = (SELECT TOP 1 DATE_ FROM PRC.PRCCHG WHERE CODE = I.CODE ORDER BY DATE_ DESC)
LEFT JOIN	PRC.PRCSCCHG S ON	S.CODE = I.CODE
AND S.STARTDATE = (SELECT TOP 1 STARTDATE FROM PRC.PRCSCCHG WHERE CODE = I.CODE ORDER BY STARTDATE DESC)
WHERE (I.CUSIP <> C.CUSIP OR I.CUSIP <> S.CUSIP) and i.cusip not in (''45962R30'')

UNION

SELECT ''CAN'' as Region, I.Cusip as PRCINFO_Cusip,	C.Cusip as PRCCHG_Cusip, S.Cusip	as PRCSCCHG_Cusip, I.Issuer, S.Exchange,	I.Status
FROM CPRCINFO I LEFT JOIN CPRCCHG C ON	C.CODE = I.CODE
AND C.DATE_ = (SELECT TOP 1 DATE_ FROM CPRCCHG WHERE CODE = I.CODE ORDER BY DATE_ DESC)
LEFT JOIN	CPRCSCCHG S ON S.CODE = I.CODE
AND S.STARTDATE = (SELECT TOP 1 STARTDATE FROM CPRCSCCHG WHERE CODE = I.CODE ORDER BY STARTDATE DESC)
WHERE (I.CUSIP <> C.CUSIP OR I.CUSIP <> S.CUSIP) and i.cusip not in (''45807510'', ''45895710'', ''Q7186A10'', ''36866P10'')
order by region DESC, s.exchange, i.status, i.cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_CusipDiff(NA) _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Saturday 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=64, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'54eef44e-f470-4e9d-a5c5-1eced288ab5a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DateOverlap_ScChg]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DateOverlap_ScChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looking for cases where the end date of one entry is the same as the start date in the next entry.   TT#989766', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Overlapping dates in *prcscchg

Select ''US'' as Region, i.Cusip, c1.StartDate as StartDate1, c2.StartDate as StartDate2, c1.EndDate as EndDate1, 
c2.EndDate as EndDate2 from prc.prcinfo i join prc.prcscchg c1 on (i.code=c1.code) join prc.prcscchg c2 on (c1.code = c2.code)
and (c1.startdate = c2.enddate) and (c2.startdate <> c2.enddate)

UNION

Select ''CAN'' as Region, i.Cusip, c1.StartDate as StartDate1, c2.StartDate as StartDate2, c1.EndDate as EndDate1, 
c2.EndDate as EndDate2 from cprcinfo i join cprcscchg c1 on (i.code=c1.code) join cprcscchg c2 on (c1.code = c2.code) 
and (c1.startdate = c2.enddate) and (c2.startdate <> c2.enddate)

Order by Region, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_DateOverlap_ScChg _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=4
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 5:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=50000, 
		@active_end_time=235959, 
		@schedule_uid=N'05cd41e6-a689-468b-869d-ee63e44924c5'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DeadStocks]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DeadStocks', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'IDC North America securities with a delisted status (D, E, M, R, S) that have an open-ended security change history.  I.e. There should be no NULL End Date in *ScChg tables.                                              TT#1002845', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC: Dead securities with open-ended security change history

Select ''US'' as Region, i.Cusip, i.Ticker, i.Status, x.Desc_, i.CurrEx from prc.prcinfo i join prc.prcscchg c on (i.code=c.code)
join prccode2 x on (i.Status=char(x.Code)) and x.type_=5
where i.status in (''D'', ''E'', ''M'', ''S'', ''R'') and c.EndDate is NULL and i.CurrEx not in (''G'', ''I'', ''1'')

UNION

Select ''CA'' as Region, i.Cusip, i.Ticker, i.Status, x.Desc_, i.CurrEx from cprcinfo i join cprcscchg c on (i.code=c.code)
join prccode2 x on (i.Status=char(x.Code)) and x.type_=5
where i.status in (''D'', ''E'', ''M'', ''S'', ''R'') and c.EndDate is NULL 

Order by Region, i.Status, i.Cusip 

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_DeadStocks(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Saturday 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=64, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'54eef44e-f470-4e9d-a5c5-1eced288ab5a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Delisted_SecChg]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Delisted_SecChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs cusips that delisted and a bogus entry was added to the Securty Change (*scchg).  Teamtrack #948168 (Putnam)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Delisteds'' bogus ending in Security Change (interestingly, does not appear to affect C/Prc.PrcTkChg).

select ''CA'' as Region, i.cusip, s.* from cprcscchg s join cprcinfo i on (i.code=s.code)
and i.status!=''0'' and startdate = enddate and s.ticker is null

UNION

select ''US'' as Region, i.cusip, s.* from prc.prcscchg s join prc.prcinfo i on (i.code=s.code)
and i.status!=''0'' and startdate = enddate and s.ticker is null

order by Region, startdate desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_Delisted_SecChg_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Div(G)_1020_DivType]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Div(G)_1020_DivType', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for any dividends in GPRCDIV that have a currency of 1020 and a DivType of 1.  The DivTypes for these dividends should always be 0.  The original dev ticket was logged under TT #105273.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:55:59 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT I.SEDOL, D.DIVNUMB, D.EXDATE 
FROM GPRCINFO2 I JOIN GPRCDIV D ON D.CODE = I.CODE 
WHERE D.CURRENCY_=''1020'' AND D.DIVTYPE=1 

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_Div(G)_1020_Divtype_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DividendCodes]    Script Date: 3/15/2016 8:55:59 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:55:59 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DividendCodes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for missing paytype or supptype code descriptions.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT F.CUSIP AS CUSIP
, I.PAYTYPE AS SECTYPE 
, I.SUPPTYPE AS CURR

FROM CPRCDIV I

LEFT JOIN PRCCODE2 C1
	ON C1.CODE = I.PAYTYPE
	AND C1.TYPE_ = 3

LEFT JOIN PRCCODE2 C2
	ON C2.CODE = I.SUPPTYPE
	AND C2.TYPE_ = 4

LEFT JOIN PRC.PRCINFO F
	ON I.CODE = F.CODE

WHERE I.PAYTYPE IS NULL OR I.SUPPTYPE IS NULL 

UNION

SELECT F.CUSIP AS CUSIP
, I.PAYTYPE AS SECTYPE 
, I.SUPPTYPE AS CURR

FROM PRC.PRCDIV I

LEFT JOIN PRCCODE2 C1
	ON C1.CODE = I.PAYTYPE
	AND C1.TYPE_ = 3

LEFT JOIN PRCCODE2 C2
	ON C2.CODE = I.SUPPTYPE
	AND C2.TYPE_ = 4

LEFT JOIN PRC.PRCINFO F
	ON I.CODE = F.CODE

WHERE I.PAYTYPE IS NULL OR I.SUPPTYPE IS NULL 

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_DividendCodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Dividends(G)]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Dividends(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Supplants and combines the MQA queries G_DivDatesMissing, G_DivRatesMissing into one check.  Note:  It looks for missing Rec & Ent dates from previous trading day forward, but missing PayDate only for the previous trading date.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Dividend date & rate check, replaces MQA query G_DivDatesMissing & G_DivRatesMissing

select ''RecDate'' as Region, i.sedol, d.DivNumb, d.ExDate, d.PayType, d.GrossRate, d.PayDate, d.RecDate, d.EntDate,
i.Issuer, i.Isin, i.QuoteCtry from gprcinfo2 i join gprcdiv d on (i.code=d.code)
where grossrate <> 0 and i.sectype in (''09'',''10'') and d.paytype in (''01'',''02'',''03'',''04'',''05'',''06'',''07'',''08'',''09'',''10'',''11'')
and d.exdate between getdate()-1 and getdate()-30 and (recdate is NULL)

UNION

select ''PayDate'' as Region, i.sedol, d.DivNumb, d.ExDate, d.PayType, d.GrossRate, d.PayDate, d.RecDate, d.EntDate,
i.Issuer, i.Isin, i.QuoteCtry from gprcinfo2 i join gprcdiv d on (i.code=d.code)
where grossrate <> 0 and i.sectype in (''09'',''10'') and d.paytype in (''01'',''02'',''03'',''04'',''05'',''06'',''07'',''08'',''09'',''10'',''11'')
and d.exdate between getdate()-1 and getdate()-30 and (paydate is NULL)

UNION

select ''Rate'' as Region, i.sedol, d.DivNumb, d.ExDate, d.PayType, d.GrossRate, d.PayDate, d.RecDate, d.EntDate,
i.Issuer, i.Isin, i.QuoteCtry from gprcinfo2 i join gprcdiv d on (i.code=d.code)
where grossrate = 0 and i.sectype in (''09'',''10'') and d.paytype in (''01'',''02'',''03'',''04'',''05'',''06'',''07'',''08'',''09'',''10'',''11'')
and d.exdate=getdate()-2

order by sedol, region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_Dividend(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Dividends(NA)]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Dividends(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Replaces MQA query, NA_DivDatesMissing & NA_DivRatesMissing, which looks for missing Announcement Dates, Pay Dates, or Record Dates in the US & Canadian dividend records.  (For records where ExDate >= previous day''s date.)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC dividend dates check, replaces MQA query NA_DivDatesMissing
select ''US_Date'' as Region, i.cusip, i.sedol, d.exdate, d.paytype, d.rate, d.paydate, d.recdate, d.anndate,
i.issuer, i.ticker, i.currex from prc.prcinfo i join prc.prcdiv d on (i.code=d.code)
where rate <> 0 and d.paytype!=''19'' and i.sectype not in (''F'') and i.currex not in (''%'',''U'',''G'',''I'') 
and d.exdate>=getdate()-2 and (recdate is NULL or anndate is NULL)

UNION

select ''US_Rate'' as Region, i.cusip, i.sedol, d.exdate, d.paytype, d.rate, d.paydate, d.recdate, d.anndate,
i.issuer, i.ticker, i.currex from prc.prcinfo i join prc.prcdiv d on (i.code=d.code)
where rate = 0 and d.paytype not in (''8'',''12'',''30'') and d.exdate=getdate()-2

UNION

select ''CA_Date'' as Region, i.cusip, i.sedol, d.exdate, d.paytype, d.rate, d.paydate, d.recdate, d.anndate,
i.issuer, i.ticker, i.currex from cprcinfo i join cprcdiv d on (i.code=d.code)
where rate <> 0 and d.paytype!=''19'' and i.sectype not in (''F'') --and i.currex not in (''%'',''U'',''G'',''I'') 
and d.exdate>=getdate()-2 and (recdate is NULL or anndate is NULL)

UNION

select ''CA_Rate'' as Region, i.cusip, i.sedol, d.exdate, d.paytype, d.rate, d.paydate, d.recdate, d.anndate,
i.issuer, i.ticker, i.currex from cprcinfo i join cprcdiv d on (i.code=d.code)
where rate = 0 and d.paytype not in (''8'',''12'',''30'') and d.exdate=getdate()-2

Order by Region desc, cusip, currex

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_Dividends(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 2:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'b5db78d1-5a69-4532-9fb8-4e7e45769c74'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DuallyListeds_SectypeDiff]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DuallyListeds_SectypeDiff', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Active dually listeds in IDC North America with different sectypes.  TT #1010167', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--TT #1010167 Dually listeds sectypes not matching
select i.ID, p.Cusip, p.Issuer, p.SecType as "US SecType", c.Cusip, c.Issuer, c.SecType as "CA SecType"
from secmstrx i join secmapx m on (i.seccode=m.seccode) and m.exchange=1  and m.ventype=1 and i.type_=1
join prc.prcinfo p on (m.vencode=p.code)
join secmapx m2 on (m.seccode=m2.seccode) and m2.exchange=2 and m2.ventype=1 join cprcinfo c on (m2.vencode=c.code) 
where (p.Issuer=c.Issuer) and (p.Status=c.Status) and (p.SecType!=c.SecType) order by i.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_DuallyListed_SectypeDiff_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DupeCusipSedol(NA)]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DupeCusipSedol(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for duplicate cusips and/or sedols within Prc.Prcinfo (US) and CPrcinfo (CA).  These would be divergence issues with Prod1.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Dupe cusips and/or sedols in IDC North America

Select ''US_Cusip'' as Region, i.Cusip, i.Sedol, i.Issuer, i.Code from prc.prcinfo i join (select cusip, count(cusip) as [count] 
from prc.prcinfo group by cusip having count (cusip) > 1) a
on a.cusip = i.cusip and (i.cusip <> '''' and i.cusip is not NULL) and (a.cusip <> '''' and a.cusip is not NULL)

UNION

select ''US_Sedol'' as Region, i.Cusip, i.Sedol, i.Issuer, i.Code from prc.prcinfo i join (select sedol, count(sedol) as [count] 
from prc.prcinfo group by sedol having count (sedol) > 1) a
on a.sedol = i.sedol and (i.sedol <> '''' and i.sedol is not NULL) and (a.sedol <> '''' and a.sedol is not NULL)

UNION

select ''CA_Cusip'' as Region, i.Cusip, i.Sedol, i.Issuer, i.Code from cprcinfo i join (select cusip, count(cusip) as [count] 
from cprcinfo group by cusip having count (cusip) > 1) a
on a.cusip = i.cusip and (i.cusip <> '''' and i.cusip is not NULL) and (a.cusip <> '''' and a.cusip is not NULL)

UNION

select ''CA_Sedol'' as Region, i.Cusip, i.Sedol, i.Issuer, i.Code from cprcinfo i join (select sedol, count(sedol) as [count] 
from cprcinfo group by sedol having count (sedol) > 1) a
on a.sedol = i.sedol and (i.sedol <> '''' and i.sedol is not NULL) and (a.sedol <> '''' and a.sedol is not NULL)

order by Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_DupeCusipSedol(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DupeDates_ScChg]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DupeDates_ScChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Sweeps both US & Canada exchange histories for records that have more than one entry of StartDate or EndDate the same.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Records with more than entry with same EndDate or StartDate date for IDC US and Canada.

select ''US EndDate'' as Region, s1.EndDate as Date, i.cusip as "Info Cusip", s1.Code from prc.prcscchg s1 inner join 
(select code, enddate from prc.prcscchg group by code, enddate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.enddate = s2.enddate) join prc.prcinfo i on (i.code=s1.code)

UNION

select ''US StartDate'' as Region, s1.StartDate as Date, i.cusip as "Info Cusip", s1.Code from prc.prcscchg s1 inner join 
(select code, StartDate from prc.prcscchg group by code, StartDate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.StartDate = s2.StartDate) join prc.prcinfo i on (i.code=s1.code)

UNION

select ''CA EndDate'' as Region, s1.EndDate as Date, i.cusip as "Info Cusip", s1.Code from cprcscchg s1 inner join 
(select code, enddate from cprcscchg group by code, enddate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.enddate = s2.enddate) join cprcinfo i on (i.code=s1.code)

UNION
select ''CA StartDate'' as Region, s1.StartDate as Date, i.cusip as "Info Cusip", s1.Code from cprcscchg s1 inner join 
(select code, StartDate from cprcscchg group by code, StartDate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.StartDate = s2.StartDate) join prc.prcinfo i on (i.code=s1.code)

order by Region, i.Cusip, Date

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_DupeDates_ScChg _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DupeDates_TkChg]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DupeDates_TkChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for codes in CprcTkChg and prc.PrcTkChg where the same code has the same StartDate or EndDates more than once.  [Requested by Nancy O''Hara.]  5/17/2010', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=1, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Records with more than entry with same EndDate or StartDate date for IDC US and Canada in TICKER CHANGE.

select ''US EndDate'' as Region, s1.EndDate as Date, i.cusip as "Info Cusip", s1.Code from prc.prcTkChg s1 inner join 
(select code, enddate from prc.prcTkChg group by code, enddate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.enddate = s2.enddate) join prc.prcinfo i on (i.code=s1.code)

UNION

select ''US StartDate'' as Region, s1.StartDate as Date, i.cusip as "Info Cusip", s1.Code from prc.prcTkChg s1 inner join 
(select code, StartDate from prc.prcTkChg group by code, StartDate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.StartDate = s2.StartDate) join prc.prcinfo i on (i.code=s1.code)

UNION

select ''CA EndDate'' as Region, s1.EndDate as Date, i.cusip as "Info Cusip", s1.Code from cprcTkChg s1 inner join 
(select code, enddate from cprcTkChg group by code, enddate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.enddate = s2.enddate) join cprcinfo i on (i.code=s1.code)

UNION
select ''CA StartDate'' as Region, s1.StartDate as Date, i.cusip as "Info Cusip", s1.Code from cprcTkChg s1 inner join 
(select code, StartDate from cprcTkChg group by code, StartDate having count(*) > 1)  s2
on (s1.code = s2.code) and (s1.StartDate = s2.StartDate) join prc.prcinfo i on (i.code=s1.code)

order by Region, i.Cusip, Date

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_DupeDates_TkChg _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DupeSdlHist(NA)]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DupeSdlHist(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Compares US sedol history to Canada sedol history and outputs the respective cusips that share (erroneously) a sedol.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--TT #887774, Dupe Sedols across US and Canada
select us.cusip as US_Cusip, u.sedol, ca.cusip as CA_Cusip, c.sedol from prc.prcsdlchg u join cprcsdlchg c on (u.sedol=c.sedol)
join prc.prcinfo us on (u.code=us.code) join cprcinfo ca on (ca.code=c.code) order by us.sedol

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_DupeSdlHist(NA) _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_DupeSedol(G)]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_DupeSedol(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Problems with the MQA query (G_DuplicateSedol) - didn''t catch a duplicate on 3/11/2010.  Converted check to SQL:  looks for duplicate sedols in Gprcchg.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Dupe sedols in IDC Gprcchg

Select i.sedol as "Info Sedol", s.code, s.sedol as "History Sedol" from gprcchg s join (select sedol, count(sedol) as [count] 
from gprcchg group by sedol having count (sedol) > 1) a on a.sedol = s.sedol join gprcinfo2 i on (s.code=i.code)
and s.sedol <> '''' and i.code not in (21105, 25677, 26022, 30679, 35159, 36085, 36546, 48834, 49130, 49904, 53139, 53944, 56139, 57661,
57888, 59897, 60595, 61237, 61260, 62118, 62980, 63381, 63544, 65898, 66077, 68544, 72414, 97366, 98416, 100314, 100529, 102064,
103249, 103254, 111612, 112361, 113723, 130519, 144820, 203649, 207620, 214704, 296648, 387735, 553790, 744031, 228789, 275392)
order by i.code

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_DupeSedol(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Duplicate_PrimaryFlag]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Duplicate_PrimaryFlag', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will check for cases where a dually-listed security is set as primary in both PRCINFO and CPRCINFO.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select u.Cusip,u.PrimaryFlag as USPrimary,c.PrimaryFlag as CAPrimary
from prc.PrcInfo u
join dbo.CPrcInfo c on c.Cusip=u.Cusip
where u.PrimaryFlag+c.PrimaryFlag<>1

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_Duplicate_PrimaryFlag__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run Query', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130604, 
		@active_end_date=99991231, 
		@active_start_time=235500, 
		@active_end_time=235959, 
		@schedule_uid=N'5c731bff-eccc-4024-85b2-448fd3212785'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_EndDated_Tickers]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_EndDated_Tickers', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This check was provided by J Clifford for Wells Fargo TT#1039356
This will catch cases where a security is still trading but there is no active ticker info in the Prcscchg table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT 
       I.Issuer, 
       I.CUSIP, 
       I.Code, 
       D.Date_,
       S.EndDate
       FROM prc.PrcInfo I
JOIN prc.PrcDly D
       ON I.Code = D.Code
       AND D.Date_ = (SELECT MAX(DATE_) FROM prc.prcdly
              WHERE CODE = D.CODE)       
LEFT JOIN prc.PrcScChg S
       ON I.Code = S.Code
       AND S.StartDate = (SELECT MAX(StartDate) FROM prc.prcscchg
              WHERE CODE = S.CODE)            
WHERE S.EndDate is not NULL
AND D.Date_ > ''2014-06-01''
order by date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_EndDated_Tickers_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Evening (after NA IDC)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=63, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090212, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'59c944a7-b11b-4a4d-a252-3e453a9e2a53'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_EquityInfo]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_EquityInfo', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query pulls any descriptor codes used in the IDC pricing database that do not have a corresponding description in PRCCODE2.                                                                                         [2011.10.21]  Removed requirement that CUSIP have pricing.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:00 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Combined all IDC Equity Info screens for NULL fields into 1 check.

select ''USA'' as Region, Cusip, Issuer, Country, CurrEx, SecType, Status, SIC
from prc.prcinfo where currex in (''A'', ''B'', ''F'') and country is NULL or currex is NULL or sectype is NULL or status is NULL or SIC is NULL

UNION

select ''CA'' as Region, Cusip, Issuer, Country, CurrEx, SecType, Status, SIC
from cprcinfo where country is NULL or currex is NULL or sectype is NULL or status is NULL or SIC is NULL

order by Region, cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_EquityInfo_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ExchangeCount(NA)]    Script Date: 3/15/2016 8:56:00 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:00 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ExchangeCount(NA)', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Gives exchange counts for each US & Canadian exchange for the past 4 days.  Specifically looking for low counts or exchanges not udpated at all.  *8/18/10 IDC did not provide primary exchange pricing for NYSE, Amex, Arca, OTCBB.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC North American exchange counts

Select ''US Composite'' as Region, count(distinct p.code) as Total, p.Date_, i.CurrEx from prc.prcinfo i join prc.prcdly p 
on (i.code=p.code) where p.date_ >=getdate()-4 group by date_, CurrEx

UNION

Select ''US Primary'' as Region, count(distinct p.code) as Total, p.Date_, i.CurrEx from prc.prcinfo i join prc.prcexc p 
on (i.code=p.code) where p.date_ >=getdate()-4 group by date_, CurrEx

UNION

Select ''Cdn Primary'' as Region, count(distinct p.code) as Total, p.Date_, i.CurrEx from cprcinfo i join cprcexc p 
on (i.code=p.code) where p.date_ >=getdate()-4 group by date_, CurrEx

UNION

Select ''Cdn Composite'' as Region, count(distinct p.code) as Total, p.Date_, i.CurrEx from cprcinfo i join cprcdly p 
on (i.code=p.code) where p.date_ >=getdate()-4 group by date_, CurrEx

order by CurrEx, Region, Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_ExchangeCount_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090529, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'05a9074f-b8b4-491d-8d49-c2665ee5a12a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ExchDiff_NA]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ExchDiff_NA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for exchange differences in the US and CA tables between *info & *scchg.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT ''USA'' as Region, I.CUSIP,	I.ISSUER,	I.Status, I.CURREX Info_Exchange, S.EXCHANGE Hist_Exchange
FROM PRC.PRCINFO I JOIN PRC.PRCSCCHG S ON I.CODE = S.CODE
	AND STARTDATE = (SELECT TOP 1 STARTDATE FROM PRC.PRCSCCHG WHERE CODE = I.CODE ORDER BY STARTDATE DESC)
WHERE I.CURREX <> S.EXCHANGE 

UNION

SELECT  ''CAN'' as Region, I.CUSIP,	I.ISSUER,	I.Status, I.CURREX Info_Exchange,	 S.EXCHANGE Hist_Exchange
FROM CPRCINFO I JOIN CPRCSCCHG S	ON I.CODE = S.CODE
	AND STARTDATE = (SELECT TOP 1 STARTDATE FROM CPRCSCCHG WHERE CODE = I.CODE ORDER BY STARTDATE DESC)
WHERE I.CURREX <> S.EXCHANGE 
order by region DESC, i.currex, i.status, i.cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_ExchDiff_NA _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ExtelCountry]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ExtelCountry', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for missing Extel country code descriptions.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT I.CODE, I.SEDOL, I.QUOTECTRY
FROM GPRCINFO2 I
LEFT JOIN GPRCCODE C1
	ON C1.CODE = I.QUOTECTRY
	AND C1.TYPE_ = 2
WHERE I.QUOTECTRY IS NULL

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_ExtelCountry_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ExtelCurr]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ExtelCurr', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for missing extel currency code descriptions.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT I.DATE_, I.CODE, F.SEDOL, I.CURRENCY_
FROM GPRCVAL I
LEFT JOIN GPRCCODE C1
	ON C1.CODE = I.CURRENCY_
	AND C1.TYPE_ = 6
LEFT JOIN GPRCINFO2 F
	ON I.CODE = F.CODE
WHERE I.CURRENCY_ IS NULL

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_ExtelCurr_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ExtelExch]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ExtelExch', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs exchange codes from Gprcval that are not defined in Gprccode, type_ 75.  11/30/2010 Per IDC:  If securities are unquoted, [Gprcval''s] exchange will only be two letters.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC_ExtelExch

Select i.Sedol, p.Exchange, p.Date_ from gprcval p join gprcinfo2 i on (p.code=i.code)
where p.exchange<>'''' and p.exchange not in (select code from gprccode where type_=75)
and p.exchange not in (''el'', ''ex'')
order by p.Exchange, i.Sedol, p.Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_ExtelExch_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_FutPrices(G)]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_FutPrices(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Checks IDC Global prices for entries with dates greater than today.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Global
select i.Sedol, p.Date_ from gprcinfo2 i join gprcval p on (i.code=p.code) where p.date_ > GetDate()
order by Sedol, Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_FutPrices(G) _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=4
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 4:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=40000, 
		@active_end_time=235959, 
		@schedule_uid=N'21969e35-41c5-42ed-a2cc-eb710bb4497a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_FutPrices(NA)]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_FutPrices(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Checks US & Canadian composite & primary exchange tables for entries with dates greater than today.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC North America
select ''US-Comp'' as Region, i.Cusip, p.Date_ from prc.prcinfo i join prc.prcdly p on (i.code=p.code) where p.date_ > GetDate()
UNION
select ''US-Exc'' as Region, i.Cusip, p.Date_ from prc.prcinfo i join prc.prcexc p on (i.code=p.code) where p.date_ > GetDate()
UNION
select ''CA-Comp'' as Region, i.Cusip, p.Date_ from cprcinfo i join cprcdly p on (i.code=p.code) where p.date_ > GetDate()
UNION
select ''CA-Exc'' as Region, i.Cusip, p.Date_ from cprcinfo i join cprcexc p on (i.code=p.code) where p.date_ > GetDate()

Order by Region, Cusip, Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_FutPrices(NA) _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=4
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 4:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=40000, 
		@active_end_time=235959, 
		@schedule_uid=N'21969e35-41c5-42ed-a2cc-eb710bb4497a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Global_CurrChange]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Global_CurrChange', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Compares Gprcval''s currency codes for last two trading days and outputs those sedols with currency code changes.  Generated by client complaint.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Currency code changes over the last two days.
WITH CURR as (select Row_Number () over (partition by i.code order by i.code, v.date_) as Row,
V.Date_, I.Sedol, I.Issuer, I.SecType, I.QuoteCtry, V.Currency_, V.Exchange, V.Close_,	I.Code from Gprcinfo2 I join Gprcval V on I.code = V.code)
	
SELECT B.Sedol, B.Issuer, B.SecType, B.QuoteCtry, B.Currency_, B.Exchange, B.Date_, B.Close_, A.Currency_ as PrevCurr, A.Exchange as PrevExch,
A.Date_ as PrevDate, A.Close_ as PrevClose
from Curr A join Curr B ON	A.CODE = B.CODE
	AND A.ROW = B.ROW-1
	AND B.DATE_ >= GETDATE() - 2
	And A.currency_ != B.currency_
	
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
	', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\Curr_Change\IDC_Global_CurrChange__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'11:30pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20081119, 
		@active_end_date=99991231, 
		@active_start_time=233000, 
		@active_end_time=235959, 
		@schedule_uid=N'7f6a67de-0520-44db-8003-f8d84cecdcbe'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Global_DivNetGross]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Global_DivNetGross', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans IDC global dividend table (Gprcdiv) to find instances where NetRate > GrossRate.  -Originated from client complaint.  TT #887260, Dev #149857.
--Query provided by Christina Dougherty.
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Gprcdiv where NetRate > GrossRate
--Originated from client complaint.  TT #887260, Dev #149857.
--Query provided by Christina Dougherty.  Updated 6/01/09.

select t.sedol,r.taxmarker,* from gprcdiv r join gprcinfo2 t
on r.code=t.code where r.taxmarker =''sp''
and grossrate < netrate and grossrate =0 and netrate > 0 
or grossrate <> 0 and  netrate> grossrate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_Global_DivNetGross_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_global_dupe_capaction]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_global_dupe_capaction', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [run query2]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'run query2', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select *
from gprccap a
join gprccap b
on a.code = b.code
and a.exdate = b.exdate
and a.rate = b.rate
and a.oldshares = b.oldshares
and a.newshares = b.newshares
and a.issueprice = b.issueprice
and a.currency_=b.currency_  
and a.changetype=b.changetype
and a.number <> b.number

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC global\IDC_Global_dupecap_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Evening (after NA IDC)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=63, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090212, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'4baebf42-f0c3-4dc1-ade1-eea4aa28bde7'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Global_ExtelExchange]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Global_ExtelExchange', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for undefined exchange codes in GPRCVAL.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Select i.Sedol, p.Date_, p.Exchange, p.Close_  from gprcinfo2 i join gprcval p on (i.code=p.code)
left join gprccode c on (c.code=p.exchange) and c.type_=75
where p.date_=getdate()-4 and p.exchange <> '''' and p.exchange is not NULL and c.desc_ is NULL
order by i.sedol, p.date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global Changes\IDC_Global_ExtelExch_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090529, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'05a9074f-b8b4-491d-8d49-c2665ee5a12a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_GlobalStatusCheck]    Script Date: 3/15/2016 8:56:01 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:01 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_GlobalStatusCheck', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for global securities that have a NULL status.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:01 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT I.SEDOL, I.ISSUER FROM GPRCINFO2 I WHERE I.STATUS IS NULL

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_GlobalStatusCheck_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_HealthCheck(G)]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_HealthCheck(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for securities with NULL health.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT I.SEDOL, I.ISSUER
FROM GPRCINFO2 I
WHERE I.HEALTH IS NULL

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_HealthCheck(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_HolidayPrices(NA)]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_HolidayPrices(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for pricing in IDC North America for US & Canadian securities on exchange holidays.  Prompted by #948248.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC_HolidayPrices(NA), prices on holiday dates
Select ''CA-Cmp'' as Region, d.date_ as Holiday_Date, i.Cusip, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code) 
join cprcdly p on (p.date_=d.date_) join cprcinfo i on (p.code=i.code) where e.ExchAbbr=''TrS''

UNION

Select ''CA-Exc'' as Region, d.date_ as Holiday_Date, i.Cusip, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code)
join cprcexc p on (p.date_=d.date_) join cprcinfo i on (p.code=i.code) where e.ExchAbbr=''TrS''

UNION

select ''US-Exc'' as Region, d.date_ as Holiday_Date, i.Cusip, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code)
join prc.prcexc p on (p.date_=d.date_) join prc.prcinfo i on (p.code=i.code) where e.ExchAbbr=''NYS''

UNION

select ''US-Comp'' as Region, d.date_ as Holiday_Date, i.Cusip, p.Close_ from SdExchInfo_V e 
join SdDates_V d on (d.ExchCode=E.ExchCode) join SdInfo_V s on (s.code=d.code)
join prc.prcdly p on (p.date_=d.date_) join prc.prcinfo i on (p.code=i.code) where e.ExchAbbr=''NYS''

order by Region, d.date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_HolidayPrices(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_InfoScchg_Diff]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_InfoScchg_Diff', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for cusip, sedol, ticker differences in the IDC info & scchg tables.  (Screens on US exchanges A, B, F, H only.)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Select ''US'' as Region, i.Issuer, i.CurrEx, i.Cusip as "Info Cusip", i.Sedol as "Info Sedol", i.Ticker as "Info Ticker",
s.Cusip, s.Sedol, s.Ticker from prc.prcinfo i join prc.prcscchg s on (i.code=s.code) 
and s.StartDate = (select top 1 StartDate from prc.prcscchg where code=i.code order by StartDate desc) 
where i.Status=''0'' and i.CurrEx in (''A'', ''B'', ''F'', ''H'') and ((i.Ticker <> s.Ticker) or (i.Cusip<>s.Cusip) or (i.Sedol<>s.Sedol))

UNION

Select ''CA'' as Region, i.Issuer, i.CurrEx, i.Cusip as "Info Cusip", i.Sedol as "Info Sedol", i.Ticker as "Info Ticker",
s.Cusip, s.Sedol, s.Ticker from cprcinfo i join cprcscchg s on (i.code=s.code) 
and s.StartDate = (select top 1 StartDate from cprcscchg where code=i.code order by StartDate desc) where i.Status=''0''
and ((i.Ticker <> s.Ticker) or (i.Cusip<>s.Cusip) or (i.Sedol<>s.Sedol))

Order by Region, i.CurrEx, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_InfoScchg_Diff_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_InfoTicker_Dupe(Canadian)]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_InfoTicker_Dupe(Canadian)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Detecting ticker dupes for CPrcInfo for IDC - same ticker different code.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step 1]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step 1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select distinct x.ventype, i.ticker, i.code from SecMapX x
join CPrcInfo i on i.code = x.vencode
join CPrcInfo i2 on i2.ticker = i.ticker
where x.ventype = 1
and i.ticker is not NULL
and i.ticker <> ''''
and i.code <> i2.code
and i.CurrEx not in (''G'', ''I'')
order by i.Ticker, i.Code

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                                   PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	               PRINT ''***WARNING***'';								
ELSE                                                                                      PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_InfoTicker_Dupe(Canadian)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_InfoTicker_Dupe(NA)]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_InfoTicker_Dupe(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Detecting ticker dupes for prc.PrcInfo for IDC - same ticker different code.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step 1]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step 1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select distinct x.ventype, i.ticker, i.code from SecMapX x
join prc.PrcInfo i on i.code = x.vencode
join prc.PrcInfo i2 on i2.ticker = i.ticker
where x.ventype = 1
and i.ticker is not NULL
and i.ticker <> ''''
and i.code <> i2.code
and i.CurrEx not in (''G'', ''I'')
order by i.Ticker, i.Code

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                                   PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	               PRINT ''***WARNING***'';								
ELSE                                                                                      PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_InfoTicker_Dupe(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_InfoTicker_Inactive]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_InfoTicker_Inactive', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Sweeps IDC US and Canada info records that have a TICKER but status is inactive.  6.146 rows in initial output (9/02/09).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select ''USA'' as Region, cusip, issuer, ticker, CurrEx, Status, LastUpdate from prc.prcinfo 
where status not in (''0'', ''b'') and ticker <> '' ''
UNION
select ''CAN'' as Region, cusip, issuer, ticker, CurrEx, Status, LastUpdate from cprcinfo 
where status not in (''0'', ''b'') and ticker <> '' ''
order by Region desc, CurrEx, Status, Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_InfoTicker_Inactive _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_OptionBidAsk]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_OptionBidAsk', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Screens OptBBO, OptDly, and OptPrc for cases where bid=1000 and ask=1000 both.  Generated  by a complaint from Matcap.  QA #144015', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Original complaint by Matcap (Greg Monegro).  QA #144015

select ''OPTDLY'' as Region, i.ticker, i.expyear, o.contrcode, o.date_, o.bid, o.ask, o.flags
from optdly o join optcntr i on (o.contrcode=i.code) where o.bid=1000 and o.ask=1000 and o.date_ >= GETDATE() -2
UNION
select ''OPTBBO'' as Region, i.ticker, i.expyear, o.contrcode, o.date_, o.bid, o.ask, o.flags
from optbbo o join optcntr i on (o.contrcode=i.code) where o.bid=1000 and o.ask=1000 and o.date_ >= GETDATE() -2
UNION
select ''OPTPRC'' as Region, i.ticker, i.expyear, o.contrcode, o.date_, o.bid, o.ask, o.flags
from optprc o join optcntr i on (o.contrcode=i.code) where o.bid=1000 and o.ask=1000 and o.date_ >= GETDATE() -2
order by i.ticker, region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Options\IDC_OptionBidAsk_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_OptionExpiry]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_OptionExpiry', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs contracts that have prices past the expiration date.  #938769', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- #938769, options trading after expiry

SELECT  m.ID, C.EXPDATE, p.* FROM SECMSTR M
        JOIN PRC.OPTINFO I ON I.CODE = M.SECCODE AND M.TYPE_ = 1
        JOIN PRC.OPTCNTR C ON      C.INFOCODE = I.CODE
                --AND     C.PUTCALL = ''P''
        JOIN OPTDLY P ON      P.CONTRCODE = C.CODE
                AND     P.DATE_ BETWEEN ''1/1/1990'' AND ''5/28/2010''
WHERE P.TOTALVOLUME > 0 AND C.EXPDATE < P.DATE_ 

order by m.ID, c.ExpDate, p.Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Options\IDC_OptionExpiry_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_OptionPrices]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_OptionPrices', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans OptCls for OHLC all equal 1000.  Generated by Matcap complaint, QA #144105.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Complaint originated by Matcap.  QA #144015
-- All prices equal 1000.
select i.ticker, i.expyear, o.* from optcls o join optcntr i on (o.contrcode=i.code)
where o.close_=1000 and o.high=1000 and o.low_=1000 and o.open_=1000
and date_ = (select filedate from update_status where tablename = ''OptCls'')

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Options\IDC_OptionPrices_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_OTCBB]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_OTCBB', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Put in place to catch OTCBB stocks (exchange code H) missing the group identifier $ in Prc.PrcScChg.  Requested by Nancy O''Hara.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--OTCBB (exch code H) missing "$" group identifier
select i.cusip as Info_Cusip, s.StartDate, s.EndDate, s.cusip as Chg_Cusip, 
s.ticker, s.fullticker, s.group_, s.series, s.exchange
from prc.prcscchg s join prc.prcinfo i on (i.code=s.code)
where startdate > ''2006-07-04'' and exchange = ''h'' 
and group_ <> ''$'' order by i.cusip, s.StartDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_OTCBB_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_PacRim_Delisted_Tickers]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_PacRim_Delisted_Tickers', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Companion query to IDC_PacRim_Tickers, to remove TICKER from delisted PacRim securities.  Among other things, this is done to prevent bad Toyo Keizai mappings on Japanese stocks, which unlike other vendors utilize TICKER to make the map.  (Expanded country coverage at request of TRSL.)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--#907703: Delisted PacRim securities.  Japanese ticker field not null leads to bad Toyo Keizai maps.

select ''Australia'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''aa'' and health!=''1'' and ticker!=''''
UNION
select ''China'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''fc'' and health!=''1'' and ticker!=''''
UNION
select ''HongKong'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''fh'' and health!=''1'' and ticker!=''''
UNION
select ''Indonesia'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''fl'' and health!=''1'' and ticker!=''''
UNION
select ''Japan'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''fj'' and health!=''1'' and ticker!=''''
UNION
select ''NewZealand'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''an'' and health!=''1'' and ticker!=''''
UNION
select ''Singapore'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''fm'' and health!=''1'' and ticker!=''''
UNION
select ''SouthKorea'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''fk'' and health!=''1'' and ticker!=''''
UNION
select ''Thailand'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''ft'' and health!=''1'' and ticker!=''''
UNION
select ''Vietnam'' as Region, sedol, issuer, health, quotectry, Ticker from gprcinfo2 where quotectry =''gv'' and health!=''1'' and ticker!=''''

order by Region, sedol
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_PacRimTickers_Delisted__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:00pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=200000, 
		@active_end_time=235959, 
		@schedule_uid=N'14d121b4-d0b1-4d89-ad54-09570ec49267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_PacRim_Tickers]    Script Date: 3/15/2016 8:56:02 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:02 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_PacRim_Tickers', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Update TICKER in Gprcinfo2 from Gprcinfa''s TickerCode, LocalCodeA, or LocalCodeB, for Australia, New Zealand, Hong Kong, Singapore, Japan, South Korea, and China.  (Expanded list at the request of TRSL, 9/16/09.)                                                            *2012-02-22 Excluded sedol B23PWV from the Japanese section (#1003459).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:02 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--PacRim Ticker Symbols (add''l countries added at TRSL request)

Select ''Australia'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''aa'' and i.exchange!=''3'' and i.health=''1'' and i.ticker<>a.tickercode
or (i.quotectry=''aa'' and i.exchange!=''3'' and i.health=''1'' and( i.ticker='''' or i.ticker is NULL)) and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''AA'' and i.ticker!=a.tickercode)
UNION
select ''China'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''fc'' and i.exchange!=''3'' and i.health=''1'' and i.ticker<>a.tickercode
or (i.quotectry=''fc'' and i.exchange!=''3'' and i.health=''1'' and( i.ticker='''' or i.ticker is NULL)) and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''FC'' and i.ticker!=a.tickercode)
UNION
select ''HongKong'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''fh'' and len(i.ticker)>4 and i.exchange!=''3'' and i.health=''1'' and i.ticker<>a.tickercode
or (i.quotectry=''fh'' and i.exchange!=''3'' and i.health=''1'' and ( i.ticker='''' or i.ticker is NULL)) and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''FH'' and i.ticker!=a.tickercode)
UNION
select ''Indonesia'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''fl'' and i.exchange!=''3'' and i.health=''1'' and i.ticker<>a.tickercode
or (i.quotectry=''fl'' and i.exchange!=''3'' and i.health=''1'' and( i.ticker='''' or i.ticker is NULL)) and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''FL'' and i.ticker!=a.tickercode)
UNION
select ''Japan'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.LocalcodeB as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''fj'' and i.SECTYPE!=''31'' and len(i.ticker)>4 and i.exchange!=''3'' and i.health=''1'' and i.ticker<>a.LocalCodeB
or (i.quotectry=''fj'' and i.sedol!=''B23PWV'' and i.health=''1'' and i.ticker='''') and (a.LocalCodeB!='''' or a.LocalCodeB is not NULL)
or (i.status=''D'' and i.quotectry=''FJ'' and i.ticker!=substring(a.LocalCodeB,1,4))
UNION
select ''NewZealand'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''an'' and i.exchange!=''3'' and i.health=''1'' and i.ticker!=a.TickerCode
or (i.quotectry=''an'' and i.exchange!=''3'' and i.health=''1'' and i.ticker='''') and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''AN'' and i.ticker!=a.tickercode)
UNION
select ''Singapore'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''fm'' and i.exchange!=''3'' and i.health=''1'' and i.ticker<>a.tickercode
or (i.quotectry=''fm'' and i.exchange!=''3'' and i.health=''1'' and i.ticker='''') and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''FM'' and i.ticker!=a.tickercode)
UNION
--Active South Korea stocks where gprcinfo2 Ticker does not match gprcinfa TickerCode.
select ''SouthKorea'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, substring(a.TickerCode,2, len(a.TickerCode)-1) as Symbol
from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''fk'' and i.exchange!=''3'' and i.health=''1'' and a.tickercode is not NULL and a.tickercode!='''' and substring(a.TickerCode,2, len(a.TickerCode)-1) <> i.ticker
--Unsuccessfully tried to add "or (i.status=''D'' and i.quotectry=''FM'' and i.ticker!=a.tickercode)" to South Korea.
UNION
--Active South Korea stocks with no Ticker
select ''SouthKorea'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where quotectry=''fk'' and i.exchange!=''3'' and health=''1'' and ticker=''''
UNION
select ''Thailand'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''ft'' and i.exchange!=''3'' and len(i.ticker)>4 and i.health=''1'' and i.ticker<>a.tickercode 
or (i.quotectry=''ft'' and i.exchange!=''3'' and i.health=''1'' and i.ticker='''') and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''FT'' and i.ticker!=a.tickercode)
UNION
select ''Vietnam'' as Region, i.sedol, i.issuer, i.sectype, i.quotectry, i.Exchange, i.Ticker, a.TickerCode as Symbol from gprcinfo2 i join gprcinfa a on (i.code =a.code)
where i.quotectry =''gv'' and i.exchange!=''3'' and i.ticker<>a.tickercode 
or (i.quotectry=''gv'' and i.exchange!=''3'' and i.health=''1'' and i.ticker is NULL) and (a.TickerCode!='''' or a.TickerCode is not NULL)
or (i.status=''D'' and i.quotectry=''GV'' and i.ticker!=a.tickercode)

order by Region, sedol
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_PacRimTickers__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:00pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=200000, 
		@active_end_time=235959, 
		@schedule_uid=N'14d121b4-d0b1-4d89-ad54-09570ec49267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_PriceOutliers(G)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_PriceOutliers(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Counterpart to MQA queries G_OC_Difference & SQL queries IDC_HLOC_G.  Looks for (high > 2*open) or (high > 2*close), or (low < .5 * open) or (low < .5 * close), or (open > 2 * close) or (close > 2 * open).  8/14/12 Market filter list added (list supplied by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Global Price Outliers:
--High > 2* open or close, low < .5* open or close; open > 2 * close or close> 2 * open.

SELECT Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > (2) and close_ > (2) and p.volume <> 0
and p.high > (2 * open_) 
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > (2) and close_ > (2) and p.volume <> 0
and p.high > (2 * close_) 
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > (2) and close_ > (2) and p.volume <> 0
and p.low < (.5 * open_) 
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > (2) and close_ > (2) and p.volume <> 0
and p.low < (.5 * close_)
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > (2) and close_ > (2) and p.volume <> 0
and p.open_ > (2 * close_) 
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > (2) and close_ > (2) and p.volume <> 0
and p.close_ > (2 * open_)
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
Order by p.Exchange, i.Sedol

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\Prices and Quotes\IDC_PriceOutliers(G)_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'4x a day (M-F)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=8, 
		@freq_subday_interval=6, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20110111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'93500748-5776-4b0e-8cd8-a6148a869501'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_PriceOutliers(NA)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_PriceOutliers(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Counterpart to MQA queries NA_OC_Difference & SQL queries IDC_HLOC_CA, IDC_HLOCcomp_US, IDC_HLOCexc_US.  Looks for (high > 2*open) or (high > 2*close), or (low < .5 * open) or (low < .5 * close), or (open > 2 * close) or (close > 2 * open).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC North American Price Outliers:
--High > 2* open or close, low < .5* open or close; open > 2 * close or close> 2 * open.

SELECT ''CA'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from cprcdly p join cprcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where open_ > (2) and close_ > (2) and p.volume <> 0 and p.high > (2 * open_) 

UNION

SELECT ''USA-Comp'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcdly p join prc.prcinfo i on (p.code=i.code)  and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and open_ > (2) and close_ > (2) and p.volume <> 0 and p.high > (2 * open_)

UNION

SELECT ''USA-Exch'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcexc p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and open_ > (2) and close_ > (2) and p.volume <> 0 and p.high > (2 * open_) 

Order by Region, p.date_, cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_PriceOutliers(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080821, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8b971dc9-f1ae-4094-ac91-b3ed87edfac4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_PriceViolations(G)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_PriceViolations(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'10/25/10 Removed price filters by request of Bangalore Data (Manjanath Hodal).  8/14/12 Market filters supplied (list provided by LC).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Global Price Outliers:

SELECT ''OpenGreaterThanHigh'' as Region, Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'') and 
c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ > high and p.volume <> 0
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT ''CloseGreaterThanHigh'', Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'') and 
c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and close_ > high and p.volume <> 0
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT ''OpenLessThanLow'' as Region, Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'') and 
c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and open_ < low and p.volume <> 0
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT ''CloseLessThanLow'' as Region, Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'') and 
c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and close_ < low and p.volume <> 0
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')
UNION
SELECT ''HighLessThanLow'' as Region, Sedol, Isin, Issuer, Sectype, p.Date_, Open_, High, Low, Close_, p.Exchange, c.Desc_
from gprcval p join gprcinfo2 i on (p.code=i.code) join gprcvala a on (i.code=a.code) and (p.date_=a.date_)
join gprccode c on (p.exchange=c.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>= getdate()-3
where i.sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'') and 
c.type_=75 and a.closetypecode=''9'' and a.HighLowTypeCode=''F'' and high < low and p.volume <> 0
and p.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',
''FTA'', ''FTB'')

Order by Sedol, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\Prices and Quotes\IDC_PriceViolations(G)_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'4x a day (M-F)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=8, 
		@freq_subday_interval=6, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20110111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'93500748-5776-4b0e-8cd8-a6148a869501'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_PriceViolations(NA)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_PriceViolations(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans for instances where High > Low, or Low > open/close > High.  Combines MQA queries NA_OHLC_Violations, NA_CloseViolations and SQL queries IDC_CompPrice and IDC_ExchPrice.                        2011-10-20 Sudeep brought to our attention that the query only referenced the CPRDLY table in every UNION clause.  Corrected the query.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC North American Price Violations:
--Low > open or close > High

SELECT ''CA-Close>High'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from cprcdly p join cprcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where p.close_ > p.high
UNION
SELECT ''CA-Open>High'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from cprcdly p join cprcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where p.open_ > p.high
UNION
SELECT ''CA-Close<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from cprcdly p join cprcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where p.close_ < p.low
UNION
SELECT ''CA-Open<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from cprcdly p join cprcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where p.open_ < p.low
UNION
SELECT ''CA-High<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from cprcdly p join cprcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where p.high < p.low

UNION

SELECT ''USComp-Close>High'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcdly p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.close_ > p.high
UNION
SELECT ''USComp-Open>High'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcdly p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.open_ > p.high
UNION
SELECT ''USComp-Close<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcdly p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.close_ < p.low
UNION
SELECT ''USComp-Open<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcdly p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.open_ < p.low
UNION
SELECT ''USComp-High<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcdly p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.high < p.low

UNION

SELECT ''USExch-Close>High'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcexc p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.close_ > p.high
UNION
SELECT ''USExch-Open>High'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcexc p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.open_ > p.high
UNION
SELECT ''USExch-Close<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcexc p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.close_ < p.low
UNION
SELECT ''USExch-Open<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcexc p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.open_ < p.low
UNION
SELECT ''USExch-High<Low'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_
from prc.prcexc p join prc.prcinfo i on (p.code=i.code) and p.date_ >= GETDATE() -2
where i.currex in (''A'', ''B'', ''F'') and p.high < p.low

Order by Region, Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_PriceViolations(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080821, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8b971dc9-f1ae-4094-ac91-b3ed87edfac4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_QBM_Date]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_QBM_Date', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs sedols with EndDate not 12/31/2049 for last record in Gprcqbm.  TT #979766', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--TT #979766: Last QBM record''s EndDate is not 12/31/2049
--IDC Global dupe QBM EndDates

WITH QBM AS (SELECT ROW_NUMBER() OVER (PARTITION BY CODE ORDER BY STARTDATE ASC) as rowNum, * 
FROM GPRCQBM) SELECT i.Sedol, A.Code, a.StartDate, 
     case when b.startdate is null then ''2049-12-31'' else b.startdate-1 end as EndDate, a.QBM FROM QBM A 
LEFT JOIN QBM B ON A.CODE = B.CODE AND A.ROWNUM = B.ROWNUM - 1
join gprcinfo2 i on (a.code=i.code)
WHERE A.CODE IN (select distinct I.CODE from gprcinfo2 i join GPrcQBM g1 on (i.code=g1.code) 
join GPrcQBM g2 on g1.Code = g2.Code and g1.StartDate > g2.StartDate and g1.EndDate = g2.EndDate)
ORDER BY A.Code, A.STARTDATE

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_QBM_Date_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=2
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_QuoteOutliers(G)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_QuoteOutliers(G)', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Counterpart to MQA query that looks for close / bid /ask outliers.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Quote Outliers:  close/bid or close/ask in Global pricing

SELECT Sedol, Isin, Issuer, SecType, p.Exchange, Date_, Open_, High, Low, Close_, Bid, Ask
from gprcval p join gprcinfo2 i on (p.code=i.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>=getdate()-3
where sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and open_ > (2) and close_ > (2) and bid > 0 and ask > 0 and p.volume <> 0
and ((p.close_/p.bid) not between -1.25 and 1.25) 

UNION

SELECT Sedol, Isin, Issuer, SecType, p.Exchange, Date_, Open_, High, Low, Close_, Bid, Ask
from gprcval p join gprcinfo2 i on (p.code=i.code) --and p.date_ = (select FileDate from Update_Status where tablename=''gprcval'')
and p.date_>=getdate()-3
where sectype in (''8'', ''9'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''54'', ''5G'', ''6C'', ''6D'',''N1'')
and open_ > (2) and close_ > (2) and bid > 0 and ask > 0 and p.volume <> 0
and ((p.close_/p.ask) not between -1.25 and 1.25)

Order by Sedol, Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\Prices and Quotes\IDC_QuoteOutliers(G)_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'4x a day (M-F)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=8, 
		@freq_subday_interval=6, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20110111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'93500748-5776-4b0e-8cd8-a6148a869501'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_QuoteOutliers(NA)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_QuoteOutliers(NA)', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'SQL counterpart to the MQA query that compares the CLOSE against the BID and ASK.  If Close/Bid or Close/Ask is greater than 1.25 then it gets reviewed.  Scans Canada, US composite, and US primary exchange tables.  20110602 Query modified to reflect IDC North American run is no longer in the -1, but is now prior to it.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Quote Outliers:  close/bid or close/ask for Canada, IDC Composite, IDC primary exchange

SELECT ''Canada'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_, v.Bid, v.Ask
from cprcdly p join cprcinfo i on (p.code=i.code) join cprcvol v on (i.code=v.code) and (p.date_=v.date_)
and p.date_ >= getdate()-2
where open_ > (2) and close_ > (2) and v.bid > 0 and v.ask > 0 and p.volume <> 0
and ((p.close_/v.bid) not between -1.25 and 1.25) 

UNION

SELECT ''USA-Comp'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_, v.Bid, v.Ask
from prc.prcdly p join prc.prcinfo i on (p.code=i.code) join prc.prcvol v on (i.code=v.code) and (p.date_=v.date_)
and p.date_ >= getdate()-2
where open_ > (2) and close_ > (2) and v.bid > 0 and v.ask > 0 and p.volume <> 0
and ((p.close_/v.bid) not between -1.25 and 1.25) 

UNION

SELECT ''USA-Exch'' as Region, Cusip, Issuer, p.Date_, Open_, High, Low, Close_, Bid, Ask
from prc.prcexc p join prc.prcinfo i on (p.code=i.code)
and p.date_ >= getdate()-2
where open_ > (2) and close_ > (2) and bid > 0 and ask > 0 and p.volume <> 0
and ((p.close_/p.bid) not between -1.25 and 1.25) 

order by Region, p.date_, cusip
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_QuoteOutliers(NA) _$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080821, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8b971dc9-f1ae-4094-ac91-b3ed87edfac4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SEDOL_Mismatch_CA]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SEDOL_Mismatch_CA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will look for differences in SEDOL between the CPRCINFO table and the CPRCSCCHG table. This usually occurs becasue the SEDOL is updated too early in CPRCSCCHG and then flips back to the old SEDOL when it should have the new SEDOL.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select
	*
	from cprcinfo i
	join cprcscchg chg 
	on	i.code = chg.code
	and chg.startdate = (select max(startdate) from cprcscchg  where code = chg.code)
	where i.sedol <> chg.sedol and chg.sedol <> ''''
	and chg.startdate > ''2013-04-20''
	order by chg.startdate desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------


', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_SEDOL_Mismatch_CA_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'IDC_SEDOL_Mismatch_CA', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130419, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'1346f658-6730-4aa9-9740-eeefef95ade1'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SEDOL_Mismatch_US]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SEDOL_Mismatch_US', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will look for differences in SEDOL between the prc.PRCINFO table and the prc.PRCSCCHG table. This usually occurs becasue the SEDOL is updated too early in prc.PRCSCCHG and then flips back to the old SEDOL when it should have the new SEDOL.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select
	*
	from prc.prcinfo i
	join prc.prcscchg chg 
	on	i.code = chg.code
	and chg.startdate = (select max(startdate) from prc.prcscchg  where code = chg.code)
	where i.sedol <> chg.sedol and chg.sedol <> ''''
	and chg.startdate > ''2012-12-31''
	order by chg.startdate desc
	
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1           PRINT ''***WARNING***'';									 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
	', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_SEDOL_MisMatch_US_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run_IDC_SEDOL_MisMatch_US', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130419, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'cfbc3f94-3f60-402b-b54a-84e81b6fa17b'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SEDOL_Missing_US]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SEDOL_Missing_US', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This check detects missing SEDOLS in IDC for NA.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- detect missing IDC (NA) SEDOLS for issues
with a as
(select Code, cusip, Issuer, LastUpdate from prc.PrcInfo
where Country != ''US''
and LastUpdate > GETDATE() - 15
and Sedol is null
and Cusip LIKE ''[a-Z]%'')
, b as 
(select code, min(Date_) as first_pricing_date from prc.PrcDly 
where Date_ > GETDATE() - 60
group by code)
select a.Cusip, a.Issuer, b.first_pricing_date, a.LastUpdate from a 
join b on a.code = b.code
group by a.cusip, a.Issuer, b.first_pricing_date, a.LastUpdate
order by a.cusip, a.Issuer, b.first_pricing_date, a.LastUpdate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Denis>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_SEDOL_Missing_US_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 8:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120302, 
		@active_end_date=99991231, 
		@active_start_time=80000, 
		@active_end_time=235959, 
		@schedule_uid=N'ccbfc2cc-7d70-480b-b7e9-86942c88dcaa'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SedolDiff]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SedolDiff', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Compares most recent SEDOL in IDC tables (info, scchg, sdlchg) against each other and against Security Master, Security Sedol, and Security Sedol2.  Requested by Bangalore Data.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sedol diffs across IDC''s tables & Security tables
--Security vs IDC US (primary)

Select ''US Primary'' as Region, i.Cusip as "Security Cusip", p.Sedol as "IDC InfoSedol", sc.Sedol as "IDC ScChgSedol", 
ss.Sedol as "IDC SedolHist", i.Sedol as "Sec Sedol", c.Sedol as "Sec SedolHist"
from secmstrx i join secmapx m on (i.seccode=m.seccode) and i.type_=1 and m.ventype=1 and m.exchange=1 and m.rank=1
join secsdlchgx c on (i.seccode=c.seccode) and c.EndDate=''6/05/2079''
join prc.prcinfo p on (m.vencode=p.code) join prc.prcscchg sc on (p.code=sc.code) and sc.EndDate is NULL
join prc.prcsdlchg ss on (p.code=ss.code) and ss.EndDate is NULL 
and (p.Sedol!=sc.Sedol or p.Sedol!=ss.Sedol or sc.Sedol!=ss.Sedol)

UNION
--Security vs IDC US (secondary)
Select ''US Secondary'' as Region, i.Cusip as "Security Cusip", p.Sedol as "IDC InfoSedol", sc.Sedol as "IDC ScChgSedol", 
ss.Sedol as "IDC SedolHist", i.Sedol2 as "Sec Sedol", c.Sedol as "Sec SedolHist"
from secmstrx i join secmapx m on (i.seccode=m.seccode) and i.type_=1 and m.ventype=1 and m.exchange=1 and m.rank=2
join secsdl2chgx c on (i.seccode=c.seccode) and c.EndDate=''6/05/2079''
join prc.prcinfo p on (m.vencode=p.code) join prc.prcscchg sc on (p.code=sc.code) and sc.EndDate is NULL
join prc.prcsdlchg ss on (p.code=ss.code) and ss.EndDate is NULL 
and (p.Sedol!=sc.Sedol or p.Sedol!=ss.Sedol or sc.Sedol!=ss.Sedol)

UNION
--Security vs IDC Canada (primary)
Select ''Canada Primary'' as Region, i.Cusip as "Security Cusip", p.Sedol as "IDC InfoSedol", sc.Sedol as "IDC ScChgSedol", 
ss.Sedol as "IDCS edolHist", i.Sedol as "Sec Sedol", c.Sedol as "Sec SedolHist"
from secmstrx i join secmapx m on (i.seccode=m.seccode) and i.type_=1 and m.ventype=1 and m.exchange=2 and m.rank=1
join secsdlchgx c on (i.seccode=c.seccode) and c.EndDate=''6/05/2079''
join cprcinfo p on (m.vencode=p.code) join cprcscchg sc on (p.code=sc.code) and sc.EndDate is NULL
join cprcsdlchg ss on (p.code=ss.code) and ss.EndDate is NULL 
and (p.Sedol!=sc.Sedol or p.Sedol!=ss.Sedol or sc.Sedol!=ss.Sedol)

UNION
--Security vs IDC Canada (secondary)
Select ''Canada Secondary'' as Region, i.Cusip as "Security Cusip", p.Sedol as "IDC InfoSedol", sc.Sedol as "IDC ScChgSedol", 
ss.Sedol as "IDC SedolHist", i.Sedol2 as "Sec Sedol", c.Sedol as "Sec SedolHist"
from secmstrx i join secmapx m on (i.seccode=m.seccode) and i.type_=1 and m.ventype=1 and m.exchange=2 and m.rank=2
join secsdl2chgx c on (i.seccode=c.seccode) and c.EndDate=''6/05/2079''
join cprcinfo p on (m.vencode=p.code) join cprcscchg sc on (p.code=sc.code) and sc.EndDate is NULL
join cprcsdlchg ss on (p.code=ss.code) and ss.EndDate is NULL 
and (p.Sedol!=sc.Sedol or p.Sedol!=ss.Sedol or sc.Sedol!=ss.Sedol)

Order by Region, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_SedolDiff_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 8:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120302, 
		@active_end_date=99991231, 
		@active_start_time=80000, 
		@active_end_time=235959, 
		@schedule_uid=N'ccbfc2cc-7d70-480b-b7e9-86942c88dcaa'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SedolDiverg(G)]    Script Date: 3/15/2016 8:56:03 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:03 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SedolDiverg(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'IDC Global Sedol Divergence
Where the most current SEDOL in Gprcchg does not match the SEDOL in Gprcinfo2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:03 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Global Info Sedol doesn''t match current sedol in Gprcchg

Select i.Sedol as "Info Sedol", i.Issuer, s.Date_, s.Sedol as "Current Sedol" from gprcinfo2 i join gprcchg s on (i.code=s.code) 
and s.Date_ = (select top 1 Date_ from gprcchg where code=i.code order by Date_ desc)
where i.sedol<>s.sedol

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_SedolDiverg(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'349dcb04-c560-4756-9b60-b53739c36662'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SharesSplits(G)]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SharesSplits(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for capital actions that impact shares outstanding that do not have a corresponding shares outstanding record on the exdate.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Currently screening for active European stocks, sectype 8, 9, and 10
-- IDC Global shares & splits

SELECT i.Sedol, s.ExDate, i.QuoteCtry, i.Issuer, i.Health, s.Rate, s.ChangeType FROM gprccap s

LEFT JOIN gprcshr r ON R.CODE = S.CODE AND S.EXDATE = R.DATE_ AND S.EXDATE <= GETDATE()-2
LEFT JOIN gprcshr R1 ON R1.CODE = S.CODE AND R1.DATE_ = (SELECT MAX(DATE_) FROM gprcshr WHERE CODE = S.CODE AND DATE_ < S.EXDATE)
LEFT JOIN gprcadj A1 ON A1.CODE = S.CODE AND R1.DATE_ BETWEEN A1.STARTDATE AND A1.ENDDATE
LEFT JOIN gprcshr R2 ON R2.CODE = S.CODE AND R2.DATE_ = (SELECT MIN(DATE_) FROM gprcshr WHERE CODE = S.CODE AND DATE_ > S.EXDATE)
LEFT JOIN gprcadj A2 ON A2.CODE = S.CODE AND R2.DATE_ BETWEEN A2.STARTDATE AND A2.ENDDATE
LEFT JOIN gprcinfo2 i ON I.CODE = S.CODE

WHERE R.SHARES IS NULL AND S.EXDATE > (SELECT MIN(DATE_) FROM gprcshr WHERE CODE = S.CODE) and s.exdate <= GetDate()-2 
and i.sectype in (''08'',''09'',''10'') and i.health=''1'' and i.quotectry like ''e%'' and s.rate not in (1,0) and s.changetype in (''f'',''g'',''j'')

order by i.status, i.quotectry, i.sedol, s.exdate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_SharesSplits(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_SharesSplits(NA)]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_SharesSplits(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for shares out dates that correspond to split dates - if there isn''t an entry that it is flagged for review.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- US shares & splits
SELECT ''US'' as Region, I.CUSIP, s.ExDate, i.currex, i.issuer, i.status, s.ratio FROM PRC.SPLITANN S

LEFT JOIN PRC.PRCSHR R ON R.CODE = S.CODE AND S.EXDATE = R.DATE_ AND S.EXDATE <= GETDATE()-2
LEFT JOIN PRC.PRCSHR R1 ON R1.CODE = S.CODE AND R1.DATE_ = (SELECT MAX(DATE_) FROM PRC.PRCSHR WHERE CODE = S.CODE AND DATE_ < S.EXDATE)
LEFT JOIN PRC.PRCADJ A1 ON A1.CODE = S.CODE AND R1.DATE_ BETWEEN A1.STARTDATE AND A1.ENDDATE
AND A1.ADJTYPE = 1
LEFT JOIN PRC.PRCSHR R2 ON R2.CODE = S.CODE AND R2.DATE_ = (SELECT MIN(DATE_) FROM PRC.PRCSHR WHERE CODE = S.CODE AND DATE_ > S.EXDATE)
LEFT JOIN PRC.PRCADJ A2 ON A2.CODE = S.CODE AND R2.DATE_ BETWEEN A2.STARTDATE AND A2.ENDDATE
AND A2.ADJTYPE = 1
LEFT JOIN PRC.PRCINFO I ON I.CODE = S.CODE

WHERE R.SHARES IS NULL AND S.EXDATE > (SELECT MIN(DATE_) FROM PRC.PRCSHR WHERE CODE = S.CODE) and s.exdate <= GetDate()-2 
and i.currex not in (''%'',''u'',''h'',''1'')

UNION

-- Canada shares & splits
SELECT ''CA'' as Region, I.CUSIP, s.ExDate, i.currex, i.issuer, i.status, s.ratio FROM cSPLITANN S

LEFT JOIN cPRCSHR R ON R.CODE = S.CODE AND S.EXDATE = R.DATE_ AND S.EXDATE <= GETDATE()-2
LEFT JOIN cPRCSHR R1 ON R1.CODE = S.CODE AND R1.DATE_ = (SELECT MAX(DATE_) FROM cPRCSHR WHERE CODE = S.CODE AND DATE_ < S.EXDATE)
LEFT JOIN cPRCADJ A1 ON A1.CODE = S.CODE AND R1.DATE_ BETWEEN A1.STARTDATE AND A1.ENDDATE
AND A1.ADJTYPE = 1
LEFT JOIN cPRCSHR R2 ON R2.CODE = S.CODE AND R2.DATE_ = (SELECT MIN(DATE_) FROM cPRCSHR WHERE CODE = S.CODE AND DATE_ > S.EXDATE)
LEFT JOIN cPRCADJ A2 ON A2.CODE = S.CODE AND R2.DATE_ BETWEEN A2.STARTDATE AND A2.ENDDATE
AND A2.ADJTYPE = 1
LEFT JOIN cPRCINFO I ON I.CODE = S.CODE

WHERE R.SHARES IS NULL AND S.EXDATE > (SELECT MIN(DATE_) FROM cPRCSHR WHERE CODE = S.CODE) and s.exdate <= GetDate()-2 

order by Region desc, i.status, i.currex, i.cusip, s.exdate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_SharesSplits(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ShrsOut(G)]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ShrsOut(G)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for spikes in shares outstanding from the previous value.  8/14/12 Market filter added (list provided by Lisa Conner).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC global shares outstanding

select i.Sedol, s.Date_ as CurrentDate, s.Shares as CurrentShares, s2.Date_ as PrevDate, s2.Shares as PrevShares, 
(100 * ((s.Shares / s2.Shares) - 1)) as PctChgShares, i.Issuer, i.ISIN, i.QuoteCtry from gprcinfo2 i
join gprcshr s on i.code = s.code join gprcshr s2 on s.code = s2.code
	and s2.Date_ = (select MAX(Date_) from gprcshr where code = s2.code and Date_ < s.Date_)
where ((100 * ((s.Shares / s2.Shares) - 1)) not between -25 and 25) and s.Date_ >= GetDate() - 2
and i.QuoteCtry+i.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', 
''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'', ''FTA'', ''FTB'')
order by PctChgShares, i.ISIN

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\Shares\IDC_ShrsOut(G)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 8:30pm', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=203000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f9f9e4-9ab7-4c71-9ace-b1c1dc630c3f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_ShrsOut(NA)]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_ShrsOut(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for spikes in shares outstanding.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC shares outstanding.  US excludes OTC exchanges H, U, %.  US and Canada exclude sectype F (funds).

Select ''USA'' as Region, i.cusip, i.issuer, i.ticker, i.currex, i.sectype, s.date_, s.shares, (100 * ((s.Shares / s2.Shares) - 1)) AS PctChgShares
from prc.prcinfo i join prc.prcshr s on (i.code=s.code) join prc.prcshr s2 on (s.code=s2.code)
and s2.date_=(SELECT MAX(Date_) FROM prc.prcshr WHERE s.code = s2.code AND s.Date_ < s2.Date_)
where ((100 * ((S.Shares / S2.Shares) - 1)) NOT BETWEEN -10 AND 10) 
and i.currex in (''A'', ''B'', ''F'') and i.sectype!=(''F'') and s.Date_ >= GETDATE() - 2
UNION
Select ''CAN'' as Region, i.cusip, i.issuer, i.ticker, i.currex, i.sectype, s.date_, s.shares, (100 * ((s.Shares / s2.Shares) - 1)) AS PctChgShares
from cprcinfo i join cprcshr s on (i.code=s.code) join cprcshr s2 on (s.code=s2.code)
and s2.date_=(SELECT MAX(Date_) FROM Cprcshr WHERE s.code = s2.code AND s.Date_ < s2.Date_)
where ((100 * ((S.Shares / S2.Shares) - 1)) NOT BETWEEN -10 AND 10) 
and i.sectype!=''F'' and s.Date_ >= GETDATE() - 2
order by region, i.currex, i.sectype
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_ShrsOut(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 12:05am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=500, 
		@active_end_time=235959, 
		@schedule_uid=N'2156868f-2edd-4093-affd-cc08faa342fc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_StartDates_Enddates]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_StartDates_Enddates', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for blank (1900-01-01) start dates in PRCSCCHG & CPRCSCCHG.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT ''PRCSCCHG'' AS TABLE_, * FROM PRC.PRCSCCHG WHERE STARTDATE = '''' or startdate > enddate
UNION
SELECT ''CPRCSCCHG'' AS TABLE_, * FROM CPRCSCCHG WHERE STARTDATE = ''''  or startdate > enddate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Changes\IDC_StartDatesEndDates_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_StatusF_R]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_StatusF_R', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'US and Canadian cusips with status F that should be 0 (zero) or status R that locks the record.  TT #1014234', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC Status F or R
select ''US_F'' as Region, max(p.Date_) as "Last Price Date", i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
from prc.prcinfo i join prc.prcdly p on (i.code=p.code)
where i.Status=''F'' group by i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
having max(p.Date_) > (i.LastUpdate+1)
UNION
select ''CA_F'' as Region, max(p.Date_) as "Last Price Date", i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
from cprcinfo i join cprcdly p on (i.code=p.code)
where i.Status=''F'' group by i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
having max(p.Date_) > (i.LastUpdate+1)
UNION
select ''US_R'' as Region, max(p.Date_) as "Last Price Date", i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
from prc.prcinfo i join prc.prcdly p on (i.code=p.code)
where i.Status=''R'' group by i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
UNION
select ''CA_R'' as Region, max(p.Date_) as "Last Price Date", i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
from cprcinfo i join cprcdly p on (i.code=p.code)
where i.Status=''R'' group by i.Cusip, i.Ticker, i.Issuer, i.Status, i.LastUpdate
order by Region, i.Ticker

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_StatusF_R_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly (Sundays @ 11 PM)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120813, 
		@active_end_date=99991231, 
		@active_start_time=230000, 
		@active_end_time=235959, 
		@schedule_uid=N'4d35494d-dff6-4b7e-9548-125d7417abdf'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_Ticker_Overlap]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_Ticker_Overlap', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch cases where there are overlaps of tickers', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [run query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select 
	*
	from	prc.prcinfo i
join 		prc.prcscchg chg1 
	on		i.code = chg1.code
	and		i.sectype = ''c''
join		prc.prcscchg chg2
	on		chg1.ticker = chg2.ticker
	and		chg1.ticker <> ''''
	and		chg1.code <> chg2.code
	and		chg1.startdate between chg2.startdate and isnull(chg2.enddate, ''2079-01-01'')
order by	chg1.startdate desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\IDC_Ticker_Overlap_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Monthly run', 
		@enabled=1, 
		@freq_type=16, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140321, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'da8e7d18-513e-4e83-85a4-0e9299160351'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_TickerHist_GroupSeries]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_TickerHist_GroupSeries', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'It has been brought to our attention that our updates are not properly converting IDC tickers in c/prcscchg TICKER and FULLTICKER fields.  (Actually, INFOs TICKER field too.)  So we need a check to output incompatible Group_/Series  Exchange codes.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- Incompatible exchange codes & Group/Series in Ticker Changes

Select ''USA'' as Region, i.cusip as Info_Cusip, i.status, i.sectype, s.cusip, s.ticker, s.startdate, s.enddate, s.fullticker, s.baseticker, s.group_, series, s.exchange
from prc.prcinfo i join prc.prcscchg s on (i.code=s.code) where (group_ NOT IN (select '' '' union select CHAR(code) descr from PRCCODE2 where type_ = 13) and s.exchange in (''1'',''a'',''b'',''c'',''d'',''e'',''f'',''t'')
or series NOT IN (select '' '' union select CHAR(code) descr from PRCCODE2 where type_ = 15)) and s.exchange in (''a'',''b'',''e'',''f'') and group_ IS NOT NULL and series IS NOT NULL 
and s.exchange!=''b'' and s.group_!=''e'' and s.series!=''c''

UNION

Select ''USA'' as Region, i.cusip as Info_Cusip, i.status, i.sectype, s.cusip, s.ticker, s.startdate, s.enddate, s.fullticker, s.baseticker, s.group_, series, s.exchange
from prc.prcinfo i join prc.prcscchg s on (i.code=s.code) where (group_ NOT IN (select '' '' union select CHAR(code) descr from PRCCODE2 where type_ = 14) and s.exchange in (''h'',''u'',''%'')
or series NOT IN (select '' '' union select CHAR(code) descr from PRCCODE2 where type_ = 16)) 
and s.exchange in (''h'',''u'',''%'') and group_ IS NOT NULL and series IS NOT NULL
and (len(s.Ticker)<(6))

UNION

Select ''CAN'' as Region, i.cusip as Info_Cusip, i.status, i.sectype, s.cusip, s.ticker, s.startdate, s.enddate, s.fullticker, s.baseticker, s.group_, series, s.exchange
from cprcinfo i join cprcscchg s on (i.code=s.code) where (group_ NOT IN (select '' '' union select CHAR(code) descr from PRCCODE2 where type_ = 13)
or series NOT IN (select '' '' union select CHAR(code) descr from PRCCODE2 where type_ = 15)) and exchange in (select distinct currex from Cprcinfo) and group_ IS NOT NULL and series IS NOT NULL

order by REGION desc, s.exchange desc, i.status, i.sectype, i.cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_TickerHist_GroupSeries_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=8
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_TickerMissing]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_TickerMissing', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Created from Teamtrack #934437 complaint:  cusips with active status but no ticker.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC:  Active status but no Ticker

select ''US'' as Region, cusip, Issuer, SecType, Currex, LastUpdate
from prc.prcinfo where status=''0'' and (ticker is NULL or ticker='''') and currex not in (''u'',''%'',''I'')

UNION

select ''CA'' as Region, cusip, Issuer, SecType, Currex, LastUpdate
from cprcinfo where status=''0'' and ticker is NULL

order by Region desc, currex, cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_TickerMissing_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'0963f31c-4a6f-45dd-aee8-c63635b70ea4'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_TotalReturn_CA]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_TotalReturn_CA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for 20%+ TR spikes when price > 5, 50% spikes when price between 2 & 5 in the global total return table (Cprcdly).  9/19/2012 At Lisa Conner''s request, added Market Cap to output.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Canada Total Return w/MktCap

Select i.Cusip, i.Issuer, i.SecType, i.CurrEx, p1.Date_, p1.Close_, p1.TotRet,
p2.Date_ as PrevDate, p2.Close_ as PrevClose, p2.TotRet as PrevTotRet, s.Shares, round((p1.Close_*s.Shares),2) as MktCap
from cprcinfo i join cprcdly p1 on (i.code=p1.code) join cprcdly p2 on (i.code=p2.code) and (p1.Date_-1 = p2.Date_)
join cprcshr s on (i.code=s.code) and s.Date_ = (select top 1 Date_ from cprcshr where code=s.code order by Date_ desc)
where i.SecType not in (''R'', ''W'') and p1.Date_>=GetDate()-2 
and (p1.Close_ is not NULL or p1.Close_<>0) and (p1.Volume is not NULL or p1.Volume<>0)
and (p1.Close_ between 2 and 5 and ((p1.TotRet / p2.TotRet)-1) not between -.5 and .5)

UNION

Select i.Cusip, i.Issuer, i.SecType, i.CurrEx, p1.Date_, p1.Close_, p1.TotRet,
p2.Date_ as PrevDate, p2.Close_ as PrevClose, p2.TotRet as PrevTotRet, s.Shares, round((p1.Close_*s.Shares),2) as MktCap
from cprcinfo i join cprcdly p1 on (i.code=p1.code) join cprcdly p2 on (i.code=p2.code) and (p1.Date_-1 = p2.Date_)
join cprcshr s on (i.code=s.code) and s.Date_ = (select top 1 Date_ from cprcshr where code=s.code order by Date_ desc)
where i.SecType not in (''R'', ''W'') and p1.Date_>=GetDate()-2 
and (p1.Close_ is not NULL or p1.Close_<>0) and (p1.Volume is not NULL or p1.Volume<>0)
and p1.Close_ > 5 and ((p1.TotRet / p2.TotRet)-1) not between -.2 and .2

order by MktCap desc, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_TotalReturn_CA_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 12:05am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=500, 
		@active_end_time=235959, 
		@schedule_uid=N'2156868f-2edd-4093-affd-cc08faa342fc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_TotalReturn_Global]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_TotalReturn_Global', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for 20%+ TR spikes in the global total return table (GPRCRET).  *3/02/11 Adding ISIN to output.  8/14/12 Market filter applied (list provided by Lisa Conner).  9/19/2012 At Lisa Conner''s request market cap added to output.
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC GLOBAL Total Return w/MktCap

Select i.Sedol, i.ISIN, i.Issuer, i.SecType, p1.Date_, p1.Close_, r1.TotRet, p1.Exchange, p1.Currency_,
p2.Date_ as PrevDate, p2.Close_ as PrevClose, r2.TotRet as PrevTotRet, p2.Exchange, p2.Currency_,
s.Shares, round((p1.Close_*s.Shares),2) as MktCap
from gprcinfo2 i join gprcval p1 on (i.code=p1.code) join gprcval p2 on (i.code=p2.code) and (p1.Date_-1 = p2.Date_)
join gprcvala a1 on (i.code=a1.code) and (p1.Date_=a1.Date_) join gprcvala a2 on (i.code=a2.code) and (p2.Date_=a2.Date_)
join gprcret r1 on (i.code=r1.code) and (p1.date_=r1.date_) join gprcret r2 on (i.code=r2.code) and (r1.Date_-1=r2.Date_)
join gprcshr s on (i.code=s.code) and s.Date_ = (select top 1 Date_ from gprcshr where code=s.code order by Date_ desc)
where i.SecType in (''8'',''08'', ''9'',''09'', ''10'',''54'', ''5F'', ''5G'', ''6C'', ''6D'', ''N1'') 
and p1.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', 
''FCS'', ''FCZ'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',''FTA'', ''FTB'') 
and p1.Date_>=GetDate()-2 and a1.CloseTypeCode=''9'' and a2.CloseTypeCode=''9''
and (p1.Close_ is not NULL or p1.Close_<>0) and (p1.Volume is not NULL or p1.Volume<>0)
and (p1.Close_ between 2 and 5 and ((r1.TotRet / r2.TotRet)-1) not between -.5 and .5)

UNION

Select i.Sedol, i.ISIN, i.Issuer, i.SecType, p1.Date_, p1.Close_, r1.TotRet, p1.Exchange, p1.Currency_,
p2.Date_ as PrevDate, p2.Close_ as PrevClose, r2.TotRet as PrevTotRet, p2.Exchange, p2.Currency_,
s.Shares, round((p1.Close_*s.Shares),2) as MktCap
from gprcinfo2 i join gprcval p1 on (i.code=p1.code) join gprcval p2 on (i.code=p2.code) and (p1.Date_-1 = p2.Date_)
join gprcvala a1 on (i.code=a1.code) and (p1.Date_=a1.Date_) join gprcvala a2 on (i.code=a2.code) and (p2.Date_=a2.Date_)
join gprcret r1 on (i.code=r1.code) and (p1.date_=r1.date_) join gprcret r2 on (i.code=r2.code) and (r1.Date_-1=r2.Date_)
join gprcshr s on (i.code=s.code) and s.Date_ = (select top 1 Date_ from gprcshr where code=s.code order by Date_ desc)
where i.SecType in (''8'',''08'', ''9'',''09'', ''10'',''54'', ''5F'', ''5G'', ''6C'', ''6D'', ''N1'') 
and p1.Exchange in (''EXL'', ''EFC'', ''EBB'', ''EDA'', ''EDF'', ''EIC'', ''EEM'', ''ENA'', ''ESE'', ''EAV'', ''SDC'', ''EPL'', ''FJT'', ''FJO'', ''AAS'', 
''FCS'', ''FCZ'', ''FHH'', ''FMS'', ''FNK'', ''FIB'', ''FIN'',''FTA'', ''FTB'') 
and p1.Date_>=GetDate()-2 and a1.CloseTypeCode=''9'' and a2.CloseTypeCode=''9''
and (p1.Close_ is not NULL or p1.Close_<>0) and (p1.Volume is not NULL or p1.Volume<>0)
and p1.Close_ > 5 and ((r1.TotRet / r2.TotRet)-1) not between -.2 and .2

order by MktCap desc, i.Sedol

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC Global\Total Return\IDC_TotalReturn_Global_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'4x a day (M-F)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=8, 
		@freq_subday_interval=6, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20110111, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'93500748-5776-4b0e-8cd8-a6148a869501'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_TotalReturn_US]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_TotalReturn_US', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for total return spikes in prc.PRCDLY.  9/19/2012 At Lisa Conner''s request MktCap added to output.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:04 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC US Total Return w/MktCap

Select i.Cusip, i.Issuer, i.SecType, i.CurrEx, p1.Date_, p1.Close_, p1.TotRet,
p2.Date_ as PrevDate, p2.Close_ as PrevClose, p2.TotRet as PrevTotRet, s.Shares, round((p1.Close_*s.Shares),2) as MktCap
from prc.prcinfo i join prc.prcdly p1 on (i.code=p1.code) join prc.prcdly p2 on (i.code=p2.code) and (p1.Date_-1 = p2.Date_)
join prc.prcshr s on (i.code=s.code) and s.Date_ = (select top 1 Date_ from prc.prcshr where code=s.code order by Date_ desc)
where i.SecType not in (''R'', ''W'') and p1.Date_>=GetDate()-2 
and (p1.Close_ is not NULL or p1.Close_<>0) and (p1.Volume is not NULL or p1.Volume<>0)
and (p1.Close_ between 2 and 5 and ((p1.TotRet / p2.TotRet)-1) not between -.5 and .5)

UNION

Select i.Cusip, i.Issuer, i.SecType, i.CurrEx, p1.Date_, p1.Close_, p1.TotRet,
p2.Date_ as PrevDate, p2.Close_ as PrevClose, p2.TotRet as PrevTotRet, s.Shares, round((p1.Close_*s.Shares),2) as MktCap
from prc.prcinfo i join prc.prcdly p1 on (i.code=p1.code) join prc.prcdly p2 on (i.code=p2.code) and (p1.Date_-1 = p2.Date_)
join prc.prcshr s on (i.code=s.code) and s.Date_ = (select top 1 Date_ from prc.prcshr where code=s.code order by Date_ desc)
where i.SecType not in (''R'', ''W'') and p1.Date_>=GetDate()-2 
and (p1.Close_ is not NULL or p1.Close_<>0) and (p1.Volume is not NULL or p1.Volume<>0)
and p1.Close_ > 5 and ((p1.TotRet / p2.TotRet)-1) not between -.2 and .2

order by MktCap desc, i.Cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_TotalReturn_US_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 12:05am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=500, 
		@active_end_time=235959, 
		@schedule_uid=N'2156868f-2edd-4093-affd-cc08faa342fc'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [IDC_VWAPS]    Script Date: 3/15/2016 8:56:04 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:04 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'IDC_VWAPS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query will replace two MQA queries that catch VWAP violations & missing VWAPs. 3/4/2016 - Adding CurrEx =''S'' to the query.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--US and Canadian VWAPs:   missing

select ''USA'' as Region, i.sectype, i.ticker, i.cusip, i.sedol, p.date_, v.VWAP, i.currex, p.Volume, p.High, p.Low
,v.AvgTrade,v.BlockVol,v.NumTrades from prc.prcinfo i 
join prc.prcvol v on (i.code=v.code) 
join prc.prcdly p on (i.code=p.code)
and (p.date_=v.date_) 
and i.currex in (''A'', ''B'', ''F'',''S'') 
and p.volume!=''-99999'' 
and p.date_=(select MAX(Date_) 
from prc.prcdly) where p.code=v.code
and (v.vwap is NULL) or (v.vwap = ''-99999'') or (v.vwap = '''')

union

select ''CAN'' as Region, i.sectype, i.ticker, i.cusip, i.sedol, p.date_, v.VWAP, i.currex, p.Volume, p.High, p.Low
,v.AvgTrade,v.BlockVol,v.NumTrades from cprcinfo i join cprcvol v on (i.code=v.code) join cprcdly p on (i.code=p.code)
and (p.date_=v.date_) and p.volume!=''-99999'' and
p.date_=(select MAX(Date_) from cprcdly) where p.code=v.code
and (v.vwap is NULL) or (v.vwap = ''-99999'') or (v.vwap = '''')

order by region desc, i.currex, i.sectype, v.vwap


---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<BLR Team>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\IDC_VWAPS_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 2:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'b5db78d1-5a69-4532-9fb8-4e7e45769c74'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Idx_Missing_Map_Nasdaq]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Idx_Missing_Map_Nasdaq', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from prc.idxsec sc where vendor = 3 and not exists( select * from secmstrx where type_ = 1 and seccode = sc.prccode)
and firstdate > ''2010-01-01''
and firstdate > ''4/1/2013''
order by lastdate desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Index\Idx_Missing_Map_Nasdaq_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run_Query', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130429, 
		@active_end_date=99991231, 
		@active_start_time=71500, 
		@active_end_time=235959, 
		@schedule_uid=N'72d17370-bd8a-4660-b01d-3204e56638fa'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Idx_Missing_Map_SP_Russell]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Idx_Missing_Map_SP_Russell', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch any records in the prc.IDXSec table that are not mapped to a Seccode that exists in Secmstrx.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from prc.idxsec sc where vendor in(1,2) and not exists( select * from secmstrx where type_ = 1 and seccode = sc.prccode)
order by lastdate desc
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Index\Idx_Missing_Map_SP_Russell__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run Query', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=31, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130429, 
		@active_end_date=99991231, 
		@active_start_time=234500, 
		@active_end_time=235959, 
		@schedule_uid=N'ff3b844f-4964-40fe-8ee4-2d723375ab31'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Idx_PrcCode]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Idx_PrcCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Prc.IdxSec''s PRCCODE does not exist as SECCODE in SecmstrX or that seccode''s CUSIP ends in XX.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Prc.IdxSec PRCCODE does not exist as SECCODE in SecmstrX
select ''S&P'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.cusip=s.cusip)
where prccode not in (select distinct seccode from secmstrx) and prccode!=0 and i.vendor=1
UNION
select ''S&P'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.prccode=s.seccode)
where s.Cusip like ''%XX'' and prccode!=0 and i.vendor=1
UNION
select ''Russell'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.cusip=s.cusip)
where prccode not in (select distinct seccode from secmstrx) and prccode!=0 and i.vendor=2
UNION
select ''Russell'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.prccode=s.seccode)
where s.Cusip like ''%XX'' and prccode!=0 and i.vendor=2
UNION
select ''Nasdaq'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.cusip=s.cusip)
where prccode not in (select distinct seccode from secmstrx) and prccode!=0 and i.vendor=3
UNION
select ''Nasdaq'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.prccode=s.seccode)
where s.Cusip like ''%XX'' and prccode!=0 and i.vendor=3
UNION
select ''DJIA'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.cusip=s.cusip)
where prccode not in (select distinct seccode from secmstrx) and prccode!=0 and i.vendor=4
UNION
select ''DJIA'' as Region, s.SecCode, i.PrcCode as "IdxSec SecCode", s.Name, s.Cusip as "Sec Cusip", i.Cusip, i.Name, i.Ticker, s.ID
from prc.idxsec i join secmstrx s on (i.prccode=s.seccode)
where s.Cusip like ''%XX'' and prccode!=0 and i.vendor=4
Order by Region, s.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Index\Idx_PrcCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 4:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=40000, 
		@active_end_time=235959, 
		@schedule_uid=N'7c144dad-9636-4e90-a731-09b1e01b7ebd'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Idx_S&P_Con]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Idx_S&P_Con', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'S&P constituents'' prc.idxsec LastDate does not match max(Date_) in IdxSpCmp.  Requested by Ping Wu, CK Ko, & Eddie Sylvester.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--S&P constituent dates

Select i.Vendor, i.Cusip, i.Name, i.FirstDate, i.LastDate, MaxDate from prc.idxsec i join
(select seccode, max(date_) as maxdate from idxspcmp group by seccode) s
on i.vendor=1  and s.seccode=i.code and i.lastdate != s.maxdate order by cusip

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Index\Idx_S&P_ConsDate_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'3b72ae68-96c2-4564-b64f-0903284df353'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Index Totals]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Index Totals', 
		@enabled=0, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'In response to an IDC failure to include 7000 index and index-related records in the 7/12/2010 file, and notified by a client, this check is instituted to provide the index counts for the past 5 calendar days.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Index counts for past 5 days in IdxDaily, IDC US, and IDC Canada.

Select ''IDX'' as Region, count(distinct Code) as "Index Total", Date_ as Date from idxdaily where date_ >=getdate()-5 group by Date_

UNION

select ''IDC-US'' as Region, count(distinct Code) as "Index Total", Date_ as Date from prc.prcidx where date_ >=getdate()-5 group by Date_

UNION

select ''IDC-CA'' as Region, count(distinct Code) as "Index Total", Date_ as Date from cprcidx where date_ >=getdate()-5 group by Date_

order by Region, Date_

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\IDC\Index_Totals_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090529, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'05a9074f-b8b4-491d-8d49-c2665ee5a12a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_Drops]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_Drops', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query sweeps the changes table for mapping drops on all vendors  WITH the vendor name.   6/30/2009 Added the UPDATE number to output.  12/13/2011 Added SECCODE to output.
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--SecMapX and GSecMapX mapping changes
-- Vendor CS FTP is excluded.

Select ''Sec-Del'' as Region, mqasys.value2 as Upd, secventype.VenId, I.ID, i.SecCode, I.cusip as CuSed, m.VenCode, m.Exchange, i.Name, secventype.VenName, secventype.VenType
from mqasys, secmapx_changes m join secmstrx_changes i on (i.seccode=m.seccode)
join secventype on secventype.ventype = m.ventype
where m.updateflag_=''d'' and i.type_=1 and m.ventype!=256 and mqasys.type=3

UNION

select ''Sec-Chg'' as Region, mqasys.value2 as Upd, secventype.VenId, i.ID, i.SecCode, i.Cusip as CuSed, m.VenCode, m.Exchange, i.Name, secventype.VenName, secventype.VenType
from mqasys, secmapx_changes x join secmapx m on (x.seccode=m.seccode) and (m.ventype=x.ventype) join secmstrx_changes i on (x.seccode=i.seccode) 
join secventype on (secventype.ventype=x.ventype)
where x.updateflag_=''d'' and i.type_=1 and x.ventype!=256 and mqasys.type=3

UNION

select ''Gsec-Del'' as Region, mqasys.value2 as Upd, secventype.VenId, I.ID, i.SecCode, I.sedol as CuSed, m.VenCode, m.Exchange, i.Name, secventype.VenName, secventype.VenType
from mqasys, gsecmapx_changes m join gsecmstrx_changes i on (i.seccode=m.seccode)
join secventype on secventype.ventype = m.ventype
where m.updateflag_=''d'' and m.ventype!=256 and mqasys.type=3

UNION

select ''Gsec-Chg'' as Region, mqasys.value2 as Upd, secventype.VenId, i.ID, i.SecCode, i.Sedol as CuSed, m.VenCode, m.Exchange, i.Name, secventype.VenName, secventype.VenType
from mqasys, gsecmapx_changes x join gsecmapx_changes m on (x.seccode=m.seccode) and (m.ventype=x.ventype)
join gsecmstrx i on (x.seccode=i.seccode) join secventype on (secventype.ventype=x.ventype)
where x.updateflag_=''d'' and i.type_=1 and x.ventype!=256 and mqasys.type=3
order by SecVenType.ventype, i.ID, m.vencode, m.Exchange, region desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1           PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Nancy>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping Drops\Mapping_Drops_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'3x a Day (Su-Sa)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=127, 
		@freq_subday_type=8, 
		@freq_subday_interval=8, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20081219, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'b4ad8166-59cc-4fd7-aa33-9cd10c5f9919'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_Dupes(Glbl)]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_Dupes(Glbl)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans most vendors in GsecmapX and Gsecmap for vendor codes mapped to > 1 (Gs)ID.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Dupe Vendor Mapping in Global Mapping (Legacy and X)
--IDC
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=1 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=1
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=1 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=1
UNION
--IBES
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=2 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=2
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=2 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=2
UNION
--CS
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=4 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=4
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=3 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=3
UNION
--MSCI
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=7 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=7
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=4 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=4
UNION
--MX
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=8 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=8
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=5 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=5
UNION
--MXFP
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=9 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=9
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=9 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=9
UNION
--Worldscope
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=10 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=10
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=6 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=6
UNION
--Barra
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=14 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=14
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=13 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=13
UNION
--Gemm
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=15 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=15
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=22 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=22
UNION
--DataStream
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=16 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=16
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=14 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=14
UNION
--DS2
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=33 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=33
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=35 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=35
UNION
--SPGD
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=18 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=18
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=18 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=18
UNION
--Ford
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=19 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=19
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=21 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=21
UNION
--Topas
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=20 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=20
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=23 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=23
UNION
--Owner
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=21 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=21
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=25 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=25
UNION
--SM2D
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=23 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=23
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=26 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=26
UNION
--SM2H
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=24 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=24
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=27 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=27
UNION
--RKD
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=26 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=26
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=29 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=29
UNION
--TPID
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=27 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=27
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=30 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=30
UNION
--BMI
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=28 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=28
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=31 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=31
UNION
--GEMECF
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=30 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=30
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=32 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=32
UNION
--ASX
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=32 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=32
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=34 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=34
UNION
--Ford2
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=43 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=34
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=36 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=36
UNION
--WSPIT
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=35 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=35
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=37 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=37
UNION
--NF
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=36 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=36
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=38 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=38
UNION
--DEALS
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=37 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=37
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=39 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=39
UNION
--DXL
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=40 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=40
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=40 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=40
UNION
--WSPTS
select ''GsecmapX'' as Region, g.ID, m.seccode, m.ventype, m.vencode from gsecmapx m join 
(select vencode, count(vencode) as [count] from gsecmapx where ventype=43 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstrx g on (m.seccode=g.seccode) where ventype=43
UNION
select ''Gsecmap'' as Region, g.GsID as ID, m.seccode, m.ventype, m.vencode from gsecmap m join 
(select vencode, count(vencode) as [count] from gsecmap where ventype=41 group by vencode having count(vencode) > 1) a
on a.vencode=m.vencode join gsecmstr g on (m.seccode=g.seccode) where ventype=41

order by ventype, vencode, ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_Dupes(Glbl)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_Dupes(NA)]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_Dupes(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans most vendors in SecmapX for vendor codes mapped to > 1 ID.  3/10/11 1)  Removed the LEGACY aspect, 2) added IBESC, IBESX, WSPTS, AS4, SPGD2.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Dupe Vendor Mapping in North American Mapping (X)
--IDC
select ''IDCx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=1 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange
join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=1
UNION
--IBES
select ''IBESx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=2 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=2
UNION
--IBESC
select ''IBESCx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=3 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=3
UNION
--CS
select ''XFx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=4 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=4
UNION
--MSCI
select ''MSCIx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=7 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=7
UNION
--MX
select ''MXx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=8 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=8
UNION
--MXFP
select ''MXFPx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=9 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=9
UNION
--Worldscope
select ''WSx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=10 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=10
UNION
--Barra
select ''BARRAx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=14 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=14
UNION
--Gemm
select ''GEMMx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=15 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=15
UNION
--DataStream
select ''DSx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=16 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=16
UNION
--DS2
select ''DS2x'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=33 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=33
UNION
--SPGH
select ''SPGHx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=17 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=17
UNION
--SPGD
select ''SPGDx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=18 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=18
UNION
--Ford
select ''FORDx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=19 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=19
UNION
--Topas
select ''TOPASx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=20 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=20
UNION
--Owner
select ''OWNx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=21 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=21
UNION
--SM2D
select ''SM2Dx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=23 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=23
UNION
--SM2H
select ''SM2Hx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=24 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=24
UNION
--RKD
select ''RKDx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=26 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=26
UNION
--TPID
select ''TPIDx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=27 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=27
UNION
--BMI
select ''BMIx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=28 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=28
UNION
--GEMECF
select ''GEMx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=30 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=30
UNION
--Ford2
select ''FORD2x'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=43 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=34
UNION
--WSPIT
select ''WSPITx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=35 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=35
UNION
--NF
select ''NFx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=36 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=36
UNION
--DEALS
select ''DEALSx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=37 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=37
UNION
--DXL
select ''DXLx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=40 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=40
UNION
--IBESX
select ''IBESXx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=42 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=42
UNION
--WSPTS
select ''WSPTSx'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=43 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=43
UNION
--AS4
select ''AS4x'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=46 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=46
UNION
--SPGD2
select ''SPGD2x'' as Region, g.ID, m.seccode, m.ventype, m.vencode from SecmapX m join 
(select exchange, vencode, count(vencode) as [count] from SecmapX where ventype=47 group by exchange, vencode having count(vencode) > 1) a
on a.vencode=m.vencode and a.exchange=m.exchange join SecmstrX g on (m.seccode=g.seccode) where type_=1 and ventype=47
order by Ventype, Vencode, ID
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_Dupes(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_IDsWithDupeVendors]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_IDsWithDupeVendors', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Dev #252829
Same vendor code mapped more than once to the same ID.
E.g. Id CTQ has the same DS2 infocode mapped twice - each entry in Ds2CusipChg has its own mapping.
', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Same Vendor code mapped > 1 to same ID.  Dev #252829
--10/25/10 Added "StartDate" filter to X tables to accommodate GEMECF and exclude ventype 33 (GEM) from legacy tables.
--12/30/10 Added "s.type_=1" to only review equities (not indices or futures).

Select ''SecmapX'' as Region, s.Id, m.VenType, m.VenCode
from secmapx m join (select vencode, ventype, exchange, StartDate, seccode, count(vencode) as [count] from secmapx 
group by vencode, ventype, exchange, StartDate, seccode having count (vencode) > 1) a join secmstrx s on (a.seccode=s.seccode)
on (a.vencode = m.vencode) and (a.ventype=m.ventype) and (a.seccode=m.seccode) and s.type_=1 and m.ventype not in (5)
and m.exchange=a.exchange and m.StartDate=a.StartDate

UNION
--Eliminated StartDate filter for GEM
Select ''SecmapX'' as Region, s.Id, m.VenType, m.VenCode
from secmapx m join (select vencode, ventype, exchange, seccode, count(vencode) as [count] from secmapx 
group by vencode, ventype, exchange, seccode having count (vencode) > 1) a join secmstrx s on (a.seccode=s.seccode)
on (a.vencode = m.vencode) and (a.ventype=m.ventype) and (a.seccode=m.seccode) and s.type_=1 and m.ventype=30

UNION

select ''Secmap'' as Region, s.Id, m.VenType, m.VenCode
from secmap m join (select vencode, ventype, exchange, seccode, count(vencode) as [count] from secmap 
group by vencode, ventype, exchange, seccode having count (vencode) > 1) a join secmstr s on (a.seccode=s.seccode)
on (a.vencode = m.vencode) and (a.ventype=m.ventype) and (a.seccode=m.seccode) and s.type_=1 and m.ventype !=15
and m.exchange=a.exchange

UNION

select ''GSecmapX'' as Region, s.Id, m.VenType, m.VenCode
from GsecmapX m join (select vencode, ventype, exchange, StartDate, seccode, count(vencode) as [count] from GsecmapX 
group by vencode, ventype, exchange, StartDate, seccode having count (vencode) > 1) a join GsecmstrX s on (a.seccode=s.seccode)
on (a.vencode = m.vencode) and (a.ventype=m.ventype) and (a.seccode=m.seccode)
and m.exchange=a.exchange and m.StartDate=a.StartDate

UNION

select ''GSecmap'' as Region, s.GSid as Id, m.VenType, m.VenCode
from Gsecmap m join (select vencode, ventype, seccode, count(vencode) as [count] from Gsecmap 
group by vencode, ventype, seccode having count (vencode) > 1) a join Gsecmstr s on (a.seccode=s.seccode)
on (a.vencode = m.vencode) and (a.ventype=m.ventype) and (a.seccode=m.seccode)

order by s.Id, m.Vencode, m.VenType, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_IDsWithDupeVendors_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_MissingDS]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_MissingDS', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs infocdes in DsCtryQtInfo that are not mapped in either SecmapX or GsecmapX.  Created from complaint in Teamtrack #936303.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--DS records not in SecMapX or GSecMapX

select ''NA_DS'' as Region, Cusip as CuSed, DsQtName, Region as DS_Region, Infocode from dsctryqtinfo
where cusip <>'''' and StatusCode=''A'' and region in (''NA'', ''US'', ''CA'')
and infocode not in (select vencode from secmapx where ventype = 16)
UNION
select ''NA_Ds2'' as Region, Cusip as CuSed, DsQtName, Region as DS_Region, i.Infocode from ds2ctryqtinfo i join ds2cusipchg c on (i.infocode=c.infocode)
where StatusCode=''A'' and region in (''NA'', ''US'', ''CA'') and StartDate=(select top 1 startdate from ds2cusipchg where infocode=c.infocode order by StartDate desc)
and i.infocode not in (select vencode from secmapx where ventype = 33)
UNION
select ''G_DS'' as Region, Sedol as CuSed, DsQtName, Region as DS_Region, Infocode from dsctryqtinfo
where sedol <> '''' and StatusCode=''A'' and region not in (''NA'', ''US'', ''CA'')
and infocode not in (select vencode from gsecmapx where ventype = 16)
UNION
select ''G_Ds2'' as Region, Sedol as CuSed, DsQtName, Region as DS_Region, i.Infocode from ds2ctryqtinfo i join ds2sedolchg c on (i.infocode=c.infocode)
where StatusCode=''A'' and region not in (''NA'', ''US'', ''CA'') and StartDate=(select top 1 startdate from ds2sedolchg where infocode=c.infocode order by StartDate desc)
and i.infocode not in (select vencode from gsecmapx where ventype = 33)

order by Region, CuSed

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_MissingDS_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_MissingDS2]    Script Date: 3/15/2016 8:56:05 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:05 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_MissingDS2', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Finds unmapped DS2 infocodes that do have cusip and/or sedol.  #943846 (Jon Crawford, Tudor Capital)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:05 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--#943846, Jon Crawford (Tudor Capital)
--DataStream unmapped though cusip and/or sedol is present
--Added "type_" filters for Secmstrx (1) & Gsecmstrx (10) to only look at equities.

SELECT i.InfoCode, i.DsCode, DsQtName, Region, StatusCode, TypeCode, s.sedol, c.cusip, Isnull(b.id, a.id) AS Id 
FROM   ds2ctryqtinfo i LEFT JOIN ds2sedolchg s on (s.infocode = i.infocode) 
and s.startdate = (SELECT MAX(startdate) from ds2sedolchg where infocode = i.infocode) 
LEFT JOIN ds2cusipchg c ON (c.infocode = i.infocode) and c.startdate = (SELECT MAX(startdate) 
from ds2cusipchg where infocode = i.infocode) 
LEFT JOIN (SELECT id, sedol, name FROM secmstrx where type_=1 
UNION SELECT id, sedol, name FROM gsecmstrx where type_=10) a 
on (a.sedol = s.sedol) LEFT JOIN secmstrx b ON b.cusip = c.cusip 
where i.infocode NOT IN (SELECT DISTINCT vencode from secmapx 
where ventype = 33 UNION SELECT DISTINCT vencode from gsecmapx where ventype = 33) 
AND ( s.sedol IS NOT NULL OR c.cusip IS NOT NULL )
order by Id desc, region, cusip, sedol
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_MissingDS2_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Tu-Sa 4:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=124, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=40000, 
		@active_end_time=235959, 
		@schedule_uid=N'21969e35-41c5-42ed-a2cc-eb710bb4497a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_MissingDXL]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_MissingDXL', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'[Client: Whitebox]  DXL recs w/cusip or sedol but not mapped to an ID.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--TT #1009208
--DXL recs with CUSIP (No. America) or SEDOL (Global) not mapped
select ''North America'' as Region, d.Code, d.SecName, d.DataRegionCode, d.MarketCode, d.AssetClassCode, i.Item, i.Value_, i.StartDate, i.LicFlag
from dxlsecinfo d join DxlLicMrktId i on (d.code=i.code) where d.DataRegionCode=6 and i.Item in (1) and i.LicFlag in (1)
and d.MarketCode in (15, 24) and not exists (select * from secmapx where d.code=vencode and ventype=40)
UNION
select ''INTL'' as Region, d.Code, d.SecName, d.DataRegionCode, d.MarketCode, d.AssetClassCode, i.Item, i.Value_, i.StartDate, i.LicFlag
from dxlsecinfo d join DxlLicMrktId i on (d.code=i.code) where d.DataRegionCode!=6 and i.Item in (2) and i.LicFlag in (2)
and d.MarketCode not in (15, 24) and not exists (select * from gsecmapx where d.code=vencode and ventype=40)
Order by Region, d.Code

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\DXL\Mapping_MissingDXL_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Saturday 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=64, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'54eef44e-f470-4e9d-a5c5-1eced288ab5a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_MissingIDC]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_MissingIDC', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'IDC codes not mapped to an ID (North America, Global).  Two versions of queries - one set includes the ID that it should be mapped to on cusip/sedol, the other set just outputs the IDC information (cusip/sedol NOT present in security).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IDC codes (No. America & Global) not mapped to an ID
--4 queries

--IDC North America not mapped but CUSIP exists
select ''US'' as Region, s.ID, s.Name, i.Cusip, i.Issuer, i.CurrEx, i.SecType, i.Status, i.LastUpdate, i.Code
from prc.prcinfo i join secmstrx s on (i.cusip=s.cusip) where not exists 
(select * from secmapx where i.code=vencode and ventype=1 and exchange=1)
UNION
select ''CA'' as Region, s.ID, s.Name, i.Cusip, i.Issuer, i.CurrEx, i.SecType, i.Status, i.LastUpdate, i.Code
from cprcinfo i join secmstrx s on (i.cusip=s.cusip) where not exists 
(select * from secmapx where i.code=vencode and ventype=1 and exchange=2)
order by Region, Code

--IDC North America not mapped and CUSIP not present
select ''US'' as Region, i.Cusip, i.Issuer, i.CurrEx, i.SecType, i.Status, i.LastUpdate, i.Code
from prc.prcinfo i where not exists 
(select * from secmapx where i.code=vencode and ventype=1 and exchange=1)
UNION
select ''CA'' as Region, i.Cusip, i.Issuer, i.CurrEx, i.SecType, i.Status, i.LastUpdate, i.Code
from cprcinfo i where not exists 
(select * from secmapx where i.code=vencode and ventype=1 and exchange=2)
order by Region, Code

--IDC Global not mapped but SEDOL exists
select ''Global'' as Region, s.ID, s.Name, i.Sedol, i.Issuer, i.QuoteCtry, i.SecType, i.Health, i.ModDate, i.Code
from gprcinfo2 i join gsecmstrx s on (i.sedol=s.sedol) where not exists 
(select * from gsecmapx where i.code=vencode and ventype=1) and ModDate<GetDate()-1
order by i.Code

--IDC Global not mapped and SEDOL not present
select ''Global'' as Region, i.Sedol, i.Issuer, i.QuoteCtry, i.SecType, i.Health, i.ModDate, i.Code
from gprcinfo2 i where not exists 
(select * from gsecmapx where i.code=vencode and ventype=1) and ModDate<GetDate()-1
order by i.Code
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\IDC\Mapping_MissingIDC_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 4:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=40000, 
		@active_end_time=235959, 
		@schedule_uid=N'7c144dad-9636-4e90-a731-09b1e01b7ebd'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_MSCI Diverg]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_MSCI Diverg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Compares MSCI mapping in Gsecmap and GsecmapX that rank #1 is the same.  Divergence is outputted.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--MSCI mapping divergence between Gsecmap & GsecmapX

Select a.*, p.VenCode as TsCode_Legacy
from gsecmap p join 
	(select Id, p.SecCode, p.VenCode as TsCode_X
	from gsecmstrx m join gsecmapx p on m.seccode=p.seccode
	and rank=1 where p.ventype = 7 except select GsID, p.SecCode, p.VenCode as TsCode_X
	from gsecmstr m join gsecmap p on m.seccode=p.seccode where p.ventype=4) a
on p.seccode=a.seccode and p.ventype=4 order by ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping_MSCI_Diverg_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_Ventype25notin10(Global)]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_Ventype25notin10(Global)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Checks for codes that exists under ventype 25 but not in 10 (Worldscope). This was for Hiroshi.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'
select ''GMSTR_Data'' as Data , mx.id, mx.seccode, mx.name,  mx.cusip, mx.sedol, ''WSInfo Data'' as Data, ws.code, ws.WsID,ws.Name, ws.Entity, ws.SEDOL, WS.CUSIP from gsecmapx mp 
join gsecmstrx mx
on mp.seccode = mx.seccode
and mx.type_ = 10 
join wsinfo ws
on mp.vencode = ws.code
where not exists(select * from gsecmapx where ventype = 10 and mp.vencode = vencode)
and mp.ventype = 25

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

 ', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_Ventype25notin10(Global)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Mapping_Ventype25notin10(Global)', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20130321, 
		@active_end_date=99991231, 
		@active_start_time=120000, 
		@active_end_time=235959, 
		@schedule_uid=N'db56a2d8-534d-4523-a33d-920a75e69361'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Mapping_Ventype25notin10(NA)]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Mapping_Ventype25notin10(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'These are securities that are mapped as Ventype =25 and not mapped as Ventype = 10', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Step1]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select ''MSTR_Data'' as Data , mx.id, mx.seccode, mx.name,  mx.cusip, mx.sedol, ''WSInfo Data'' as Data, ws.code, ws.WsID,ws.Name, ws.Entity, ws.SEDOL, WS.CUSIP from secmapx mp 
join secmstrx mx
on mp.seccode = mx.seccode
and mx.type_ = 1 
join wsinfo ws
on mp.vencode = ws.code
where not exists(select * from secmapx where ventype = 10 and mp.vencode = vencode)
and mp.ventype = 25
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Mapping\Mapping_Ventype25notin10(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run_Ventype25notin10_US', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20130318, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'009d3695-844f-4a36-a862-1b4ba16ab717'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Missing_Futures_Expirations]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Missing_Futures_Expirations', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This looks at cases where there is pricing for a contract but no expriation date. This request was given by Ann Marie Gray on behalf of First Quadrant.

--This query was implemented by Patrick Howerter', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select 
 i.ticker, i.name, d.contract
	from	cminfo i
join		cmdaily d
	on		i.infocode =  d.infocode
	and		d.date_ > ''2013-01-01''
where i.ticker in(''TS'', ''BF'', ''JB'', ''GX'', ''CG'', ''FV'', ''R-'', ''BT'', ''GM'', ''TY'',
''TU'', ''US'', ''CC'', ''CL'', ''CB'', ''C-'', ''CT'', ''QN'', ''LF'', ''FC'',
''GC'', ''GI'', ''HG'', ''HO'', ''KC'', ''KW'', ''LC'', ''LH'', ''LP'', ''ZG'',
''MW'', ''NG'', ''S-'', ''SI'', ''SB'', ''W-'', ''RB'', ''L-'', ''GH'', ''B-'',
''ED'', ''LA'', ''AD'', ''BP'', ''CD'', ''DX'', ''JY'', ''NE'', ''XB'', ''SF'',
''EC'',''RP'', ''LJ'', ''PI'', ''BL'', ''BZ'', ''MX'', ''DF'', ''ZM'', ''AZ'',
''ES'', ''MZ'', ''X-'', ''HH'', ''HS'', ''IX'', ''IS'', ''TT'', ''KS'', ''ER'',
''MD'', ''II'', ''NQ'', ''NX'', ''NN'', ''NZ'', ''OX'', ''VU'', ''EZ'', ''VM'',
''SJ'', ''SZ'', ''SP'', ''SV'', ''SU'', ''TP'', ''VE'', ''FX'', ''WI'', ''VX''
)
and not exists (select * from cmexpmth where code = i.StartMonth and contract = d.contract)
group by i.ticker, i.name, d.contract
order by i.ticker, d.contract

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\CRB_Futures\Missing_Futures_Expirations_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run on Sundays', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140203, 
		@active_end_date=99991231, 
		@active_start_time=200000, 
		@active_end_time=235959, 
		@schedule_uid=N'f9cdfb5c-9f8d-4d9b-acdb-a29ff560426a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Missing_Mapping_MSCI_ACWI]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Missing_Mapping_MSCI_ACWI', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Missing mapping for MSCI ACWI constituents', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step1]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'declare @date as smalldatetime
set @date = getdate()

select      *
from  ms2idxconstdly d
join  ms2secinfo o
      on    o.secid = d.secid
      and @date between d.startdate and isnull(d.enddate,''6/5/2079'')
left join gsecmapx gmp
      on    gmp.vencode = o.secid
      and gmp.ventype = 48
      and @date between gmp.startdate and gmp.enddate
left join secmapx mp
      on    mp.vencode = o.secid
      and mp.ventype = 48
      and @date between mp.startdate and mp.enddate
left join gsecmstrx gmr
      on    gmr.seccode = gmp.seccode
left join secmstrx mr
      on    mr.seccode = mp.seccode
      and mr.type_ = 1
where mscicode = 892400
and isnull(gmr.id,mr.id) is null
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 0	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Nancy>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\Monitor\qcchecks\SecMstr\Mapping\Missing_Mapping_MSCI_ACWI_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=8
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Missing_Mapping_RUSSELL_3000]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Missing_Mapping_RUSSELL_3000', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Missing mapping for Russell 3000 constituents', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step1]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'declare @date as smalldatetime
set @date = (select max(date_) from idxrlcmp where idxcode = 177)

select      *
from  idxrlcmp sp
left join   prc.idxsec s
      on    s.code = sp.seccode
      and s.vendor = 2
left join secmstrx mr
      on    mr.seccode = s.prccode
      and mr.type_ = 1
where mr.id is null
and sp.date_ = @date
and sp.idxcode = 177
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 0	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Nancy>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\Monitor\qcchecks\SecMstr\Mapping\Missing_Mapping_RUSSELL_3000_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Missing_Mapping_SP_500]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Missing_Mapping_SP_500', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Missing mapping for S&P 500 constituents', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step1]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'declare @date as smalldatetime
set @date = (select max(date_) from idxspcmp where idxcode = 203)

select      *
from  idxspcmp sp
left join   prc.idxsec s
      on    s.code = sp.seccode
      and s.vendor = 1
left join secmstrx mr
      on    mr.seccode = s.prccode
      and mr.type_ = 1
where mr.id is null
and sp.date_ = @date
and sp.idxcode = 203

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 0	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Nancy>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\Monitor\qcchecks\SecMstr\Mapping\Missing_Mapping_SP_500_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [monitoring_job]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'monitoring_job', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'monitoring job', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step 1]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step 1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'WITH 
a AS
(
   SELECT job_id, message, run_date, run_time,
         ROW_NUMBER()OVER (PARTITION BY job_id order by run_date desc, run_time desc) AS rn1
   FROM msdb.dbo.sysjobhistory
),
b AS
( 
SELECT job_id, output_file_name, last_run_date, last_run_time,
         ROW_NUMBER()OVER (PARTITION BY job_id order by last_run_date desc, last_run_time desc) AS rn2
   FROM msdb.dbo.sysjobsteps
),
c AS
(
 select job_id, name from msdb.dbo.sysjobs
),
d AS 
(
select l.name, s.job_id from  msdb.dbo.sysjobs s 
join master.sys.syslogins l on s.owner_sid = l.sid
),
e AS
(
SELECT job_id, run_date, run_time, SUBSTRING(message,((CHARINDEX(''***<<('',message) + 6)),((CHARINDEX('')>>***'',message))-(CHARINDEX(''***<<('',message) + 6)))  AS rows, 
ROW_NUMBER()OVER (PARTITION BY job_id order by run_date desc, run_time desc) AS rn3
FROM msdb.dbo.sysjobhistory where message like ''%***<<(%''
),
f AS
(
SELECT job_id, run_date, run_time,             
ROW_NUMBER()OVER (PARTITION BY job_id order by run_date desc, run_time desc) AS rn4,
			CASE
			WHEN  message LIKE ''%***ZERO RESULTS***%'' THEN ''ZERO RESULTS'' 
			WHEN  message LIKE ''%***WARNING***%'' THEN ''WARNING'' 
            WHEN  message LIKE ''%***ISSUE***%'' THEN ''ISSUE'' 
            WHEN  message LIKE ''%***CRITICAL***%'' THEN ''CRITICAL''
            END "status"
FROM msdb.dbo.sysjobhistory where message like ''%***<<(%''
),
g as
(
select replace (output_file_name, ''$(ESCAPE_SQUOTE(DATE))'',last_run_date) as output_link, job_id,last_run_date, last_run_time,
ROW_NUMBER()OVER (PARTITION BY job_id order by last_run_date desc, last_run_time desc) AS rn5
FROM msdb.dbo.sysjobsteps
),
h AS
(
SELECT job_id, run_date, run_time, SUBSTRING(message,((CHARINDEX(''***CM:'',message) + 6)),((CHARINDEX(''|CM***'',message))-(CHARINDEX(''***CM:'',message) + 6)))  AS comment, 
ROW_NUMBER()OVER (PARTITION BY job_id order by run_date desc, run_time desc) AS rn6
FROM msdb.dbo.sysjobhistory where message like ''%|CM***%''
)
SELECT f.status, e.rows as number_of_rows, c.name as job_name, g.output_link as output_link, b.last_run_date, b.last_run_time, h.comment FROM a 
join b on b.job_id = a.job_id
join c on c.job_id = b.job_id
join d on d.job_id = b.job_id
join e on e.job_id = b.job_id
join f on f.job_id = b.job_id
join g on g.job_id = b.job_id
join h on h.job_id = b.job_id
WHERE rn1 = 1 and rn2 = 1 and rn3 = 1 and rn4 = 1 and rn5 = 1 and rn6 = 1 and d.name = ''sa''
order by f.status, b.last_run_date desc, b.last_run_time desc
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitoring\monitoring_job_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Currency]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Currency', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'MSCI currency codes in MsdFxDly but not defined in MsCode.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:06 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--MSCI currency codes in MsdFxDly but not defined in MsCode

select distinct currency_ from msdfxdly where currency_ not in 
(select desc_ from mscode where codename=''currency'') and currency_ not in (''mxp'',''plz'',''rur'')

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Currency_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Morning 7am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20081110, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'42f4534c-f145-4157-8258-43a595c113e8'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Cusip(ISIN)]    Script Date: 3/15/2016 8:56:06 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:06 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Cusip(ISIN)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'On request from Acadian (Talken, #947470) Data will manually enter CUSIP for US and Canadian securities where ISIN is provided.  (We''ll extract the CUSIP from ISIN.)', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Legacy MSCI missing cusips, #947470
--We can easily maintain the cusip when ISIN is provided

select tscode, Name, Sedol, Isin, Country, Cusip, ModDate from msdsec 
where country in (''us'',''ca'') and (cusip='''' or cusip is NULL) and isin <> ''''
order by tscode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Cusip(ISIN)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Cusip(Sedol)]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Cusip(Sedol)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Populate Tscodes with missing CUSIPs from IDC via sedol matching.  #947470 (Acadian) complaint.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Legacy MSCI missing cusips, #947470
--Obtaining CUSIP from IDC by matching on SEDOL

select ''US'' as Region, m.TsCode, i.Cusip, i.Sedol, m.ISIN, m.Name, i.Issuer from prc.prcinfo i join msdsec m
on (i.sedol=m.sedol) where m.country=''US'' and (m.cusip='''' or m.cusip is NULL) and (m.ISIN='''' or m.ISIN is NULL)
and (m.Sedol <> '''')

UNION

select ''CA'' as Region, m.TsCode, i.Cusip, i.Sedol, m.ISIN, m.Name, i.Issuer from cprcinfo i join msdsec m
on (i.sedol=m.sedol) where m.country=''CA'' and (m.cusip='''' or m.cusip is NULL) and (m.ISIN='''' or m.ISIN is NULL)
and (m.Sedol <> '''')

order by Region, tscode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Cusip(Sedol)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Overlapping_Date_MS2SecCu]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Overlapping_Date_MS2SecCu', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This check should return 0 rows.  If it does return any rows, we should notify dev/PM of the problem.  
It checks for overlapping dates in MS2SecCu.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run_query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run_query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from MS2SecCu 
where SecID in 
(
select a.SecID from MS2SecCu a
join MS2SecCu b
on a.SecID = b.SecID
and a.StartDate < b.StartDate
and ISNULL(a.EndDate, ''2079-12-31'') >= b.StartDate
)
and StartDate>''2011-1-1''

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Denis - notify dev/PM if any results>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Overlapping_Date_MS2SecCu_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'349dcb04-c560-4756-9b60-b53739c36662'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Overlapping_Date_MS2SecInfoChg]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Overlapping_Date_MS2SecInfoChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This check should return 0 rows.  If it does return any rows, we should notify dev/PM of the problem.  
It checks for overlapping dates in MS2SecInfoChg.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run_query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run_query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select SecID, StartDate, EndDate, TsCode, IssCode, SecCode, Name_, ISOCtryCode 
from MS2SecInfoChg
where TsCode in 
(
select a.TsCode from MS2SecInfoChg  a
join MS2SecInfoChg  b
on a.SecID = b.SecID
and a.StartDate < b.StartDate
and ISNULL(a.EndDate, ''2079-12-31'') >= b.StartDate
)
and StartDate >=''1/1/2011''
order by SecID, StartDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1           PRINT ''***WARNING***'';									 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Denis - notify dev/PM if any results>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Overlapping_Date_MS2SecInfoChg_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Evening (after NA IDC)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=63, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090212, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'59c944a7-b11b-4a4d-a252-3e453a9e2a53'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Overlapping_Date_MS2SecISIN]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Overlapping_Date_MS2SecISIN', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This check should return 0 rows.  If it does return any rows, we should notify dev/PM of the problem.  
It checks for overlapping dates in MS2SecISIN.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run_query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run_query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from MS2SecISIN 
where SecID in 
(
select a.SecID from MS2SecISIN a
join MS2SecISIN b
on a.SecID = b.SecID
and a.StartDate < b.StartDate
and ISNULL(a.EndDate, ''2079-12-31'') >= b.StartDate
)
and StartDate>''2011-1-1''

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Denis - notify dev/PM if any results>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Overlapping_Date_MS2SecISIN_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'349dcb04-c560-4756-9b60-b53739c36662'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [MSCI_Overlapping_Date_MS2SecSed]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'MSCI_Overlapping_Date_MS2SecSed', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This check should return 0 rows.  If it does return any rows, we should notify dev/PM of the problem.  
It checks for overlapping dates in MS2SecSed.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run_query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run_query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select * from MS2SecSed 
where SecID in 
(
select a.SecID from MS2SecSed a
join MS2SecSed b
on a.SecID = b.SecID
and a.StartDate < b.StartDate
and ISNULL(a.EndDate, ''2079-12-31'') >= b.StartDate
)
and StartDate>''2011-1-1''

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Denis - notify dev/PM if any results>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\MSCI\MSCI_Overlapping_Date_MS2SecSed_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'349dcb04-c560-4756-9b60-b53739c36662'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [PrcIss_DupIsrName]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'PrcIss_DupIsrName', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans for isrcodes with identical isrnames.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--TT #888221, Duplicate issuer names in PrcPrcIss

select a.isrname, a.isrcode, b.isrcode, a.isoctry, b.isoctry
from prc.prcisr a
join prc.prcisr b on a.isrname = b.isrname and a.isrcode < b.isrcode
order by a.isrname;

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Issuer\PrcIss_DupeIsrName_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [PrcIss_Duplicate_Ranks]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'PrcIss_Duplicate_Ranks', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for any duplicate rank 1 records in prc.PRCISS and sends the output to a file (name).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- duplicate rank 1 records in prc.PRCISS

select 
	isrcode, 
	rank,
	count(*)
from prc.prciss where type_ in (1,6)
group by isrcode, rank 
having count(*) > 1
order by isrcode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Issuer\PrcIss_Duplicate_Ranks_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [PrcIss_FI_OrphanIsrcodes]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'PrcIss_FI_OrphanIsrcodes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Isrcodes in FiSirsCissinfo or FiSirsGissInfo that do not exist in Prc.PrcIsr/Prc.PrcIsrr.  Reported by Palantir (#939919).', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--FiSirsCissInfo, FiSirsGissInfo isrcodes that do not exist in Prc.PrcIss/Prc.PrcIsr.

Select distinct a.isrcode as FI_Isrcode, ''Govt'' as Region from fisirsGissinfo a 
where a.isrcode is not null and a.isrcode not in (select isrcode from prc.prcisr)

UNION

Select distinct a.isrcode as FI_Isrcode, ''Corp'' as Region from fisirsCissinfo a 
where a.isrcode is not null and a.isrcode not in (select isrcode from prc.prcisr)

ORDER BY Region, Isrcode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Issuer\PrcIss_FI_OrphanIsrcodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [PrcISS_Issuer_Rank1]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'PrcISS_Issuer_Rank1', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch cases where a seccode that is not a rank = 1 has more mappings than a seccode that is a rank of 1.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--started with 1600 issues was 1536  on 4/26/2013
--240 on 5/29/2013

select 
	*
	from 
(select 
	is1.isrcode, count(*) as mcount
from 
	prc.prciss is1 
left join secmapx imp
on is1.code = imp.seccode
and is1.type_ = 1
left join gsecmapx igmp
on is1.code = igmp.seccode
and is1.type_ = 6
where is1.rank = 1 and is1.type_ in (1,6)
group by isrcode
) as b
join 

(

select
 a.isrcode, a.isoctry, a.type_,
max(ct) as mcount
from 

(select
	iss.isrcode, isr.isoctry, iss.code, iss.type_, count(*) as ct
	from prc.prciss iss
join		prc.prcisr isr
on iss.isrcode = isr.isrcode
left join secmapx mpx 
on iss.code = mpx.seccode
and iss.type_ = 1
left join gsecmapx gmpx
on iss.code = gmpx.seccode
and iss.type_ = 6
where isnull(mpx.seccode, gmpx.seccode) is not null
	group by iss.isrcode, isr.isoctry, iss.code, iss.type_) as a 
group by a.isrcode,a.isoctry, a.type_) as a1
on b.isrcode = a1.isrcode
where b.mcount <> a1.mcount
and ((a1.type_ =  6 and  (ISOCtry <> ''US''  and ISOCtry <> ''CA'') ) or (a1.type_ =  1 and  (ISOCtry =''US'' or ISOCtry = ''CA'') )  )
and (a1.mcount - b.mcount) > 5
and a1.isrcode not in
(
11035947
,1047710
,1100464
,1557482
,1557712
,1217910
,1152326
,1162198
,1162602
,1192186
,1166823
,1077803
,1270038
,1015620
,2113048
,11005286
,1004331
,1019637
,1291263
,1099842
,1051710
,40447
,1028413
,1008152
,1031202
,1203918
,293454
,10973213
,1011722
,357246
,10909082
,1073006
,7162
,46253
,69101
,1350044
,1051403
,1080752
,1186601
,1190144
,1065366
, 1080787
,2262120     
,1174501     
,1195995   
,1194418 
) 

order by (a1.mcount - b.mcount) desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Issuer\Issuer_Rank1_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run Query', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20130531, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'119f1223-1822-41c7-af99-d4c45bd957d2'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [PrcIss_MissingIDs]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'PrcIss_MissingIDs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for IDs in SECMSTR/GSECMSTR that do not exist in prc.PRCISS.                                                                             [2011.10.27] Added global sectype "5G."', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- IDs not added/mapped to Prc.PrcIsr isrcodes.
-- 2012-08-13 Removed IDC Global sectype 5F after QC review with Lisa Conner and Nancy O''Hara.

select ''US'' as Region,	M.ID, M.CUSIP AS CuSed,	M.Name, P.SecType, p.LastUpdate from 
SECMSTRx M join SECMAPx MP ON (MP.SECCODE = M.SECCODE) AND MP.VENTYPE	= 1
	AND	MP.EXCHANGE	= 1 JOIN PRC.PRCINFO P ON (P.CODE	= MP.VENCODE) WHERE	M.TYPE_ = 1
	AND	P.SECTYPE	in (''A'', ''C'', ''I'', ''P'', ''Q'', ''R'', ''T'', ''U'', ''W'')
	and p.LastUpdate<=GetDate()-2
	AND	M.SECCODE	NOT IN (SELECT DISTINCT CODE FROM PRC.PRCISS WHERE TYPE_ = 1)

UNION

SELECT ''CA'' AS REGION, M.ID,	M.CUSIP AS CuSed,	M.Name, P.SecType, p.LastUpdate from
SECMSTRx M join SECMAPx MP ON (MP.SECCODE	= M.SECCODE) AND	MP.VENTYPE	= 1
	AND	MP.EXCHANGE	= 2 JOIN CPRCINFO P ON	(P.CODE = MP.VENCODE) WHERE M.TYPE_ = 1
	AND	P.SECTYPE	in (''A'', ''C'', ''I'', ''P'', ''Q'', ''R'', ''T'', ''U'', ''W'')
	and p.LastUpdate<=GetDate()-2
	AND	M.SECCODE	NOT IN (SELECT DISTINCT CODE FROM PRC.PRCISS WHERE TYPE_ = 1)

UNION

SELECT ''GLB'' AS Region,	M.GSID	AS ID, M.SEDOL AS CeSed,	M.Name, P.SecType, p.ModDate as LastUpdate from
GSECMSTR M JOIN GSECMAP MP ON	(MP.SECCODE	= M.SECCODE) AND	MP.VENTYPE	= 1
	JOIN	GPRCINFO2 P ON	(P.CODE = MP.VENCODE) 
	WHERE P.SECTYPE IN (''08'', ''09'', ''10'', ''20'', ''21'', ''23'', ''24'', ''31'', ''32'', ''34'', ''35'', ''5G'')
	and p.ModDate<=GetDate()-2
	AND	M.SECCODE	NOT IN (SELECT DISTINCT CODE FROM PRC.PRCISS WHERE TYPE_ = 6)

ORDER BY REGION, SECTYPE, NAME

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Issuer\PrcIss_MissingIDs_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [PrcIss_Orphans]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'PrcIss_Orphans', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query looks for orphaned records in prc.PRCISS; orphans are codes in prc.PRCISS that do not have a corresponding record in (G)SECMSTR.  The output is written to the ''F:\NightlyChecks\monitor\qcchecks\IssuerOutput'' with a name of ''PRCISS_OrphansYYYYMMDD.''', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- Orphaned prc.PRCISS codes in the Security tables

SELECT ISS.*, MSTR.GsID AS MQAID FROM PRC.PRCISS ISS 
LEFT OUTER JOIN GSECMSTR MSTR ON ISS.CODE = MSTR.SECCODE 
WHERE ISS.TYPE_ = 6 AND MSTR.SECCODE IS NULL 
UNION
SELECT ISS.*, MSTR.ID AS MQAID FROM PRC.PRCISS ISS 
LEFT OUTER JOIN SECMSTRx MSTR ON ISS.CODE = MSTR.SECCODE AND ISS.TYPE_ = MSTR.TYPE_
WHERE MSTR.SECCODE IS NULL AND MSTR.TYPE_ IN (1,20)
order by iss.isrcode, iss.type_, iss.code

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Issuer\PrcIss_Orphans_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [QAI_LIC.Subplan_1]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [Database Maintenance]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Database Maintenance' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Database Maintenance'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'QAI_LIC.Subplan_1', 
		@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=N'XAVIER\Administrator', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Subplan_1]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Subplan_1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'SSIS', 
		@command=N'/Server "$(ESCAPE_NONE(SRVR))" /SQL "Maintenance Plans\QAI_LIC" /set "\Package\Subplan_1.Disable;false"', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [qai_master_full.Subplan_1]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [Database Maintenance]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Database Maintenance' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Database Maintenance'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'qai_master_full.Subplan_1', 
		@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=N'XAVIER\Administrator', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Subplan_1]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Subplan_1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'SSIS', 
		@command=N'/Server "$(ESCAPE_NONE(SRVR))" /SQL "Maintenance Plans\qai_master_full" /set "\Package\Subplan_1.Disable;false"', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [qaimaster statistics and indexes.Subplan_1]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [Database Maintenance]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'Database Maintenance' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'Database Maintenance'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'qaimaster statistics and indexes.Subplan_1', 
		@enabled=1, 
		@notify_level_eventlog=2, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'Database Maintenance', 
		@owner_login_name=N'XAVIER\Administrator', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Subplan_1]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Subplan_1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'SSIS', 
		@command=N'/Server "$(ESCAPE_NONE(SRVR))" /SQL "Maintenance Plans\qaimaster statistics and indexes" /set "\Package\Subplan_1.Disable;false"', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [RKD_ExchRIC]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'RKD_ExchRIC', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Look for exchcode and RIC mismatches for Japanese securities.  Specifically exchcode TYO and RIC "OS" or exchcode OSA and RIC ".T"', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--RKD mismatch between EXCHCODE and RIC

select i.Code, i.Name_, i.RIC, i.ExchCode, i.Sedol, i.ISIN, r.Sedol as "Info Sedol", r.RIC as "Info RIC"
from rkdfndcmprefissue r join rkdfndinfo i on (i.code=r.code) where i.exchcode=''TYO'' and i.RIC like ''%OS''

UNION
select i.Code, i.Name_, i.RIC, i.ExchCode, i.Sedol, i.ISIN, r.Sedol as "Info Sedol", r.RIC as "Info RIC"
from rkdfndcmprefissue r join rkdfndinfo i on (i.code=r.code) where i.exchcode=''OSA'' and i.RIC like ''%.T''

order by i.RIC

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\RKD\RKD_ExchRIC_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [RKD_IssueOrderDupes]    Script Date: 3/15/2016 8:56:07 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:07 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'RKD_IssueOrderDupes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'RkdFndCmpRefIssue:  Response to client complaint that the same company, different issues have the same IssueOrder assignment.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:07 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--RkdFnd:  duplicate IssueOrder for same RkdFnd CODE (#937909)

select r.PrimaryName, i.IssueName, i.code, i.IssueID, i.IssueCode, i.IssueTypeCode, I.IssueStatus, i.IssueOrder,
i.Cusip, i.ISIN, i.Sedol, i.ExchCode
from RkdFndCmpRefIssue i join RkdFndCmpRefIssue a on (i.code=a.code) join RkdFndCmpRef r on (r.code=i.code)
where (i.IssueOrder=a.IssueOrder) and (i.IssueTypeCode=a.IssueTypeCode) and (i.IssueCode!=a.IssueCode)
order by i.code, i.IssueOrder
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\RKD\RKD_IssueOrderDupe_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 6 a.m.', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'13abc3e5-e5bb-4279-b1ad-06bbb9d3df0c'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Bad_IDs]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Bad_IDs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for bad IDs in SECMSTR where the ID is in Scientific Notation.  12/27/10 Excluded IDs created by, and only mapped to, GEM.  8/24/11 Only output IDs that map to IDC.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sec_Bad_ID check

select ''SecmstrX'' as Region, Id, Cusip, Sedol, Name, s.SecCode from secmstrx s join secmapx m 
on (s.seccode=m.seccode) where type_=1 and m.ventype=1 and
(id like ''%`%'' or id like ''%~%'' or id like ''%!%'' or id like ''%@%'' or id like ''%#%'' or id like ''%$%'' or id like ''% % %'' 
or id like ''%^%'' or id like ''%&%'' or id like ''%*%'' or id like ''%(%'' or id like ''%)%'' or id like ''%-%'' or id like ''%=%'' 
or id like ''%+%'' or id like ''%,%'' or id like ''%<%'' or id like ''%>%'' or id like ''%?%'' or id like ''%/%'' or id like ''%[%'' 
or id like ''%]%'' or id like ''%%'' or id like ''%\%'')

UNION

select ''Secmstr'' as Region, Id, Cusip, Sedol, Name, s.SecCode from secmstr s join secmap m
on (s.seccode=m.seccode) where type_=1 and m.ventype=1 and
(id like ''%`%'' or id like ''%~%'' or id like ''%!%'' or id like ''%@%'' or id like ''%#%'' or id like ''%$%'' or id like ''% % %'' 
or id like ''%^%'' or id like ''%&%'' or id like ''%*%'' or id like ''%(%'' or id like ''%)%'' or id like ''%-%'' or id like ''%=%'' 
or id like ''%+%'' or id like ''%,%'' or id like ''%<%'' or id like ''%>%'' or id like ''%?%'' or id like ''%/%'' or id like ''%[%'' 
or id like ''%]%'' or id like ''%%'' or id like ''%\%'')

order by Id, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\SEC_BadIDs_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekdays at 7', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=1, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=70000, 
		@active_end_time=235959, 
		@schedule_uid=N'53626d3e-f2bb-40c3-97c5-0684dc9b6b8f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CountryCode]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CountryCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'[Ice Bear, #1009366]                                                                           Check security tables (all four) COUNTRY field, which should be the 3-character ISO code, should in fact have three characters.  At the time of this writing (2012-06-06) the only culprits are FIXED INCOME Ids.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Wrong ISO Country Code length (aka not 3) in security master tables.  
--Both Security & Global Security output in one file.

--Global Security
select ''Gsecmstr'' as Region, SecCode, GsId as ID, Name, LEN(country) Len_Country, Country from gsecmstr  where LEN(country) > 0 and LEN(country) <> 3
UNION
select ''GsecmstrX'' as Region, SecCode, ID, Name, LEN(country) Len_Country, Country from gsecmstrX where LEN(country) > 0 and LEN(country) <> 3
order by ID, Region

--Security Master
select ''Secmstr'' as Region, SecCode, Id, Type_, LEN(country) Len_Country, Country from secmstr where LEN(country) > 0 and LEN(country) <> 3
UNION
select ''SecmstrX'' as Region, SecCode, Id, Type_, LEN(country) Len_Country, Country from secmstrX where LEN(country) > 0 and LEN(country) <> 3
order by ID, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CountryCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 5:00AM', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20120606, 
		@active_end_date=99991231, 
		@active_start_time=50000, 
		@active_end_time=235959, 
		@schedule_uid=N'f2fe5360-4d75-42aa-9b4a-b4021daa4175'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CPrc_CspCusipProb]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CPrc_CspCusipProb', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans C/Prc and Sec cusip change tables and outputs entries where the DATE matches but CUSIP does not.  Query written by Jean-Marc Reynaud (5/08/2009).  Original output had 13 rows.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sec_CPrc_CspCusipProb
--Scans C/Prc and Sec cusip change tables and outputs entries 
--where the DATE matches but CUSIP does not.

select ''CAN'' as Region, secmstrx.cusip, secmstrx.id, seccspchgx.*, prc.*
from seccspchgx join secmapx on (secmapx.seccode = seccspchgx.seccode)
join cprcchg prc on (secmapx.vencode = prc.code) 
join secmstrx on (secmstrx.seccode = secmapx.seccode)
where secmstrx.type_=1 and secmapx.ventype = 1 and exchange = 2
and seccspchgx.StartDate = prc.Date_ and seccspchgx.cusip <> prc.cusip

UNION

select ''USA'' as Region, secmstrx.cusip, secmstrx.id, seccspchgx.*, prc.*
from seccspchgx join secmapx on (secmapx.seccode = seccspchgx.seccode)
join prc.prcchg prc on (secmapx.vencode = prc.code) 
join secmstrx on (secmstrx.seccode = secmapx.seccode)
where secmstrx.type_=1 and secmapx.ventype = 1 and exchange = 1
and seccspchgx.StartDate = prc.Date_ and seccspchgx.cusip <> prc.cusip

order by REGION, Secmstrx.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CPrc_CspCusipProb_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CPrc_CspDateProb]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CPrc_CspDateProb', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans C/Prc and Sec cusip change tables and outputs entries where CUSIP matches but DATE does not.  Query created by Jean-Marc Reynaud (5/08/09).  Original output had 454 rows.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sec_CPrc_CspDateProb
--Scans C/Prc and Sec cusip change tables and outputs entries where CUSIP matches but DATE does not.
--Added IDs that have legitimate duplicate cusips in history.

select ''CAN'' as Region, SecMstrX.cusip, SecMstrX.id, SecCspChgX.StartDate as SecDate, SecCspChgX.cusip as SecCusip, 
prc.date_ as PrcDate, prc.cusip as PrcCusip
from seccspchgx join secmapx on (secmapx.seccode = seccspchgx.seccode)
join cprcchg prc on (secmapx.vencode = prc.code)
join secmstrx on (secmstrx.seccode = secmapx.seccode)
where secmstrx.type_=1 and secmapx.ventype = 1 and exchange = 2
and seccspchgx.StartDate <> prc.Date_ and seccspchgx.cusip = prc.cusip
and secmstrx.id not in (''EGPD'', ''00245P40'',''00245P80'',''00245P88'',''43278730'',''65526010'',
''76891430'',''76891454'',''76891479'',''BTDRF'',''CFCU'',''IBNT'',''ISHPF'',''MIDC'',''98889220'',''00758M57'', ''EWRX'', ''GPGPF'')

UNION

select ''USA'' as Region, SecMstrX.cusip, SecMstrX.id, SecCspChgx.StartDate as SecDate, SecCspChgx.cusip as SecCusip, 
prc.date_ as PrcDate, prc.cusip as PrcCusip
from SecCspChgX join SecMapX on (SecMapX.seccode = SecCspChgX.seccode)
join prc.prcchg prc on (SecMapX.vencode = prc.code) 
join SecMstrX on (SecMstrX.seccode = SecMapX.seccode)
where SecMstrX.type_=1 and SecMapx.ventype = 1 and exchange = 1
and SecCspChgX.StartDate <> prc.Date_ and SecCspChgX.cusip = prc.cusip
and SecMstrX.id not in (''EGPD'', ''00245P40'',''00245P80'',''00245P88'',''43278730'',''65526010'',
''76891430'',''76891454'',''76891479'',''BTDRF'',''CFCU'',''IBNT'',''ISHPF'',''MIDC'',''98889220'',''00758M57'', ''EWRX'', ''GPGPF'')

order by REGION, SecMstrX.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CPrc_CspDateProb_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CPrc_MissingCspHist]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CPrc_MissingCspHist', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Screens US and Canada cusip change tables and Security Cusip Change, and outputs instances where either C/Prc or Sec has a cusip history but the other does not.  Original run on 5/08/2009 revealed 3 cases in Cprcchg and 4 in Prc.Prcchg.  [Query written by Jean-Marc Reynaud.]', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Cusip history is NULL in either C/PRC or SEC.
--NOTE:  Dual listings can have different cusip histories, but where they share a cusip the DATE
--must MATCH.  (E.g. 29409D10)

select ''CAN'' as Region , SecMstrX.cusip, SecMstrX.id, SecMapX.*, prc.* from cprcchg prc 
full outer join SecMapX on SecMapX.vencode = prc.code
join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2
and (SecMapX.vencode is NULL or prc.code is NULL)
union
select ''USA'' as Region, SecMstrX.cusip, SecMstrX.id, SecMapX.*, prc.* from prc.prcchg prc 
full outer join SecMapX on SecMapX.vencode = prc.code
join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1
and (SecMapX.vencode is NULL or prc.code is NULL)

order by Region, SecMstrX.ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CPrcMissingCspHist_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CPrc_MissingSedolHist]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CPrc_MissingSedolHist', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans CPrc and Sec sedol change tables and outputs instances where one has a sedol history and the other does not.  Query written by Jean-Marc Reynaud, Teresa Healy, and Kathy Dervin.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sec_CPrc_MissingSedolHist:  scans C/Prc and Sec sedol change tables and outputs entries where one has history but the other does not.

select ''CAN'' as Region, ''1'' as Flag, SecMstrX.cusip, SecMstrX.id, SecSdlChgX.*, prc.* 
from SecSdlChgX join SecMapX on SecMapX.seccode = SecSdlChgX.seccode
join CprcSdlChg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2 and SecMapX.rank=1
and (SecMapX.vencode is NULL or prc.code is NULL)

UNION

select ''CAN'' as Region, ''2'' as Flag, SecMstrX.cusip, SecMstrX.id, SecSdl2ChgX.*, prc.* 
from SecSdl2ChgX join SecMapX on SecMapX.seccode = SecSdl2ChgX.seccode
join CprcSdlChg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2 and SecMapX.rank=2 and SecSdl2ChgX.StartDate = prc.StartDate 
and (SecMapX.vencode is NULL or prc.code is NULL)

UNION

select ''USA'' as Region, ''1'' as Flag, SecMstrX.cusip, SecMstrX.id, SecSdlChgX.*, prc.* 
from SecSdlChgX join SecMapX on SecMapX.seccode = SecSdlChgX.seccode
join prc.prcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1 and SecMapX.rank=1 
and (SecMapX.vencode is NULL or prc.code is NULL)

UNION

select ''USA'' as Region, ''2'' as Flag, SecMstrX.cusip, SecMstrX.id, SecSdl2ChgX.*, prc.* 
from SecSdl2ChgX join SecMapX on SecMapX.seccode = SecSdl2ChgX.seccode
join prc.prcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1 and SecMapX.rank=2 and SecSdl2ChgX.StartDate = prc.StartDate 
and (SecMapX.vencode is NULL or prc.code is NULL)

order by REGION, SecMstrX.ID, FLAG

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CPrc_MissingSedolHist_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CPrc_SdlDateProb]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CPrc_SdlDateProb', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans C/Prc and Sec sedol change tables and outputs entries where SEDOL matches but DATE does not.  Query created by Jean-Marc, Teresa Healy, and Kathy Dervin.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sec_CPrc_SdlDateProb:  Scans C/Prc and Sec sedol change tables and outputs entries where SEDOL matches but DATE does not.

select ''CAN'' as Region, ''1'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdlChgX.StartDate as SecDate, SecSdlChgX.Sedol as Sec_Sedol, 
prc.StartDate as PrcDate, prc.Sedol as PrcSedol 
from SecSdlChgX join SecMapX on SecMapX.seccode = SecSdlChgX.seccode
join cprcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2 and SecMapX.rank=1
and SecSdlChgX.StartDate <> prc.StartDate and SecSdlChgX.sedol = prc.sedol
and SecMstrX.id not in (''COW'',''FLS.V'',''SNTP.V'',''57777R10'',''72369J10'',
''BADN'',''GTOP'',''HCTL'',''IBCS'',''ITRT'',''PBTK'',''TSEO'',''VFND'',''80660570'',''CLDS'',''TNTD'',''AUGR'',''AHMC'',''45320610'',''31679Q10'',''AINI'')

UNION

select ''CAN'' as Region, ''2'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdl2ChgX.StartDate as SecDate, SecSdl2ChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.Sedol as PrcSedol 
from SecSdl2ChgX join SecMapX on SecMapX.seccode = SecSdl2ChgX.seccode
join cprcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2 and SecMapX.rank=2
and SecSdl2ChgX.StartDate <> prc.StartDate and SecSdl2ChgX.sedol = prc.sedol
and SecMstrX.id not in (''COW'',''FLS.V'',''SNTP.V'',''57777R10'',''72369J10'',
''BADN'',''GTOP'',''HCTL'',''IBCS'',''ITRT'',''PBTK'',''TSEO'',''VFND'',''80660570'',''CLDS'',''TNTD'',''AUGR'',''AHMC'',''45320610'',''31679Q10'',''AINI'')

UNION

select ''USA'' as Region, ''1'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdlChgX.StartDate as SecDate, SecSdlChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.Sedol as PrcSedol 
from SecSdlChgX join SecMapX on SecMapX.seccode = SecSdlChgX.seccode
join prc.prcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1 and SecMapX.rank=1
and SecSdlChgX.StartDate <> prc.StartDate and SecSdlChgX.sedol = prc.sedol
and SecMstrX.id not in (''COW'',''FLS.V'',''SNTP.V'',''57777R10'',''72369J10'',
''BADN'',''GTOP'',''HCTL'',''IBCS'',''ITRT'',''PBTK'',''TSEO'',''VFND'',''80660570'',''CLDS'',''TNTD'',''AUGR'',''AHMC'',''45320610'',''31679Q10'',''AINI'')

UNION

select ''USA'' as Region, ''2'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdl2ChgX.StartDate as SecDate, SecSdl2ChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.Sedol as PrcSedol 
from SecSdl2ChgX join SecMapX on SecMapX.seccode = SecSdl2ChgX.seccode
join prc.prcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1 and SecMapX.rank=2
and SecSdl2ChgX.StartDate <> prc.StartDate and SecSdl2ChgX.sedol = prc.sedol
and SecMstrX.id not in (''COW'',''FLS.V'',''SNTP.V'',''57777R10'',''72369J10'',
''BADN'',''GTOP'',''HCTL'',''IBCS'',''ITRT'',''PBTK'',''TSEO'',''VFND'',''80660570'',''CLDS'',''TNTD'',''AUGR'',''AHMC'',''45320610'',''31679Q10'',''AINI'')

order by REGION, SecMstrX.ID, FLAG

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CPrc_SdlDateProb_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CPrc_SdlSedolProb]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CPrc_SdlSedolProb', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Scans CPrc and Sec tables and outputs those instances where the DATE matches but the SEDOL does not.  Query written by Jean-Marc Reynaud, Teresa Healy, and Kathy Dervin.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Sec_CPrc_SdlDateProb scans C/Prc and Sec sedol change tables and outputs entries where DATE matches but SEDOL does not.

select ''CAN'' as Region, ''1'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdlChgX.StartDate as SecDate, SecSdlChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.sedol as PrcSedol
from SecSdlChgX join SecMapX on SecMapX.seccode = SecSdlChgX.seccode
join cprcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2 and SecMapX.rank=1
and SecSdlChgX.StartDate = prc.StartDate and SecSdlChgX.sedol <> prc.sedol

UNION

select ''CAN'' as Region, ''2'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdl2ChgX.StartDate as SecDate, SecSdl2ChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.sedol as PrcSedol
from SecSdl2ChgX join SecMapX on SecMapX.seccode = SecSdl2ChgX.seccode
join cprcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 2 and SecMapX.rank=2
and SecSdl2ChgX.StartDate = prc.StartDate and SecSdl2ChgX.sedol <> prc.sedol

UNION

select ''USA'' as Region, ''1'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdlChgX.StartDate as SecDate, SecSdlChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.sedol as PrcSedol
from SecSdlChgX join SecMapX on SecMapX.seccode = SecSdlChgX.seccode
join prc.prcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1 and SecMapX.rank=1
and SecSdlChgX.StartDate = prc.StartDate and SecSdlChgX.sedol <> prc.sedol

UNION

select ''USA'' as Region, ''2'' as Flag, SecMstrX.cusip, SecMstrX.ID, SecSdl2ChgX.StartDate as SecDate, SecSdl2ChgX.Sedol as SecSedol,
prc.StartDate as PrcDate, prc.sedol as PrcSedol
from SecSdl2ChgX join SecMapX on SecMapX.seccode = SecSdl2ChgX.seccode
join prc.prcsdlchg prc on SecMapX.vencode = prc.code join SecMstrX on SecMstrX.seccode = SecMapX.seccode
where SecMstrX.type_=1 and SecMapX.ventype = 1 and exchange = 1 and SecMapX.rank=2
and SecSdl2ChgX.StartDate = prc.StartDate and SecSdl2ChgX.sedol <> prc.sedol

order by REGION, SecMstrX.ID, FLAG

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CPrc_SdlSedolProb_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_CusipHist]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_CusipHist', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Check for divergence in CUSIP historybetween Seccspchg-ScspchgX.  Outputs IDs for those with differences.  Only does so for EQUTIES.  [Query written by Greg Monegro.]  4/22/2010', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- Cusips not in both Security Cusip Change

-- Secmstr only
select ''Secmstr'' as Region, ID, Name, s.Cusip, c.Cusip as CusipHist, c.Date_ as StartDate, s.Seccode from secmstr s join seccspchg c
on (s.seccode=c.seccode) where s.type_=1 and c.cusip not in (select cusip from seccspchgx where seccode=c.seccode)

UNION

-- SecmstrX only
select ''SecmstrX'' as Region, ID, Name, s.Cusip, c.Cusip as CusipHist, c.StartDate, s.Seccode from secmstrx s join seccspchgx c
on (s.seccode=c.seccode) where s.type_=1 and c.cusip not in (select cusip from seccspchg where seccode=c.seccode)

order by ID, Region, StartDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_CusipHist_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_DivergID]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_DivergID', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Divergence - SECCODE the same, ID different between legacy and X tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Security divergence same SECCODE, different ID

-- North American Security
select ''NA'' as Region, x.ID, x.Sedol, x.Name, x.SecCode, g.ID as Legacy_ID, g.sedol as "Legacy Sedol", g.Name as Legacy_Name, 
g.Seccode as "Legacy SecCode" from secmstrx x join secmstr g on (x.seccode = g.seccode) 
where x.type_=1 and g.type_=1 and x.ID<>g.ID

UNION

-- Global Security
select ''Global'' as Region, x.ID, x.Sedol, x.Name, x.SecCode, g.GsID as Legacy_ID, g.sedol as "Legacy Sedol", g.Name as Legacy_Name, 
g.Seccode as "Legacy SecCode" from gsecmstrx x join gsecmstr g on (x.seccode=g.seccode) 
where x.ID<>g.GsID

order by Region, ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Divergence\Sec_DivergID_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_DivergSecCodes]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_DivergSecCodes', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Divergence - ID the same, SECCODE different between legacy and X tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Security divergence same ID, different SECCODE

-- North American Security
select ''NA'' as Region, x.ID, x.Sedol, x.Name, x.SecCode, g.ID as Legacy_ID, g.sedol as "Legacy Sedol", g.Name as Legacy_Name, 
g.Seccode as "Legacy SecCode" from secmstrx x join secmstr g on (x.ID = g.ID) 
where x.type_=1 and g.type_=1 and x.SecCode<>g.SecCode

UNION

-- Global Security
select ''Global'' as Region, x.ID, x.Sedol, x.Name, x.SecCode, g.GsID as Legacy_ID, g.sedol as "Legacy Sedol", g.Name as Legacy_Name, 
g.Seccode as "Legacy SecCode" from gsecmstrx x join gsecmstr g on (x.ID=g.GsID) 
where x.SecCode<>g.SecCode

order by Region, ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Divergence\Sec_DivergSecCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_DupeIDs]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_DupeIDs', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Client pointed out there are 52 pairs of (global) IDs with different seccodes.  This query scans Secmstr/SecmstrX and Gsecmstr/GsecmstrX.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Dupe IDs in Master tables

Select ''SecmstrX'' as Region, SecCode, ID, Cusip as CuSed, ISIN, Name from secmstrx where id in 
(select id from secmstrx group by id having count(*) > 1) and type_=1

UNION
select ''Secmstr'' as Region, SecCode, ID, Cusip as CuSed, ISIN, Name from secmstr where ID in 
(select ID from secmstr group by ID having count(*) > 1) and type_=1

UNION
select ''GsecmstrX'' as Region, SecCode, ID, Sedol as CuSed, ISIN, Name from gsecmstrx where id in (select id from gsecmstrx group by id having count(*) > 1)

UNION
select ''Gsecmstr'' as Region, SecCode, GsID as ID, Sedol as CuSed, ISIN, Name from gsecmstr where GsID in (select GsID from gsecmstr group by GsID 
having count(*) > 1) 

order by ID, Region desc

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Divergence\SEC_DupeIDs_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Saturday 3:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=64, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'54eef44e-f470-4e9d-a5c5-1eced288ab5a'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_DupeSedol]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_DupeSedol', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Outputs the sedol duplicated in the security sedol change table and the ID(s) it is linked to.  TT #999169', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--TT #999169, Dupe sedols in Security Sedol Change tables

Select ''Gsec'' as Region, i.ID, i.SecCode, i.sedol as "Sec Sedol", s.StartDate, s.Sedol as "Sedol Change"
from gsecsdlchg s join (select sedol, count(sedol) 
as [count] from gsecsdlchg group by sedol having count (sedol) > 1) a on (a.sedol = s.sedol)
join gsecmstrx i on (s.seccode=i.seccode) where s.sedol <> ''''

UNION

Select ''Sec'' as Region, i.ID, i.SecCode, i.sedol as "Sec Sedol", s.StartDate, s.Sedol as "Sedol Change"
from secsdlchgx s join (select sedol, count(sedol) 
as [count] from secsdlchgx group by sedol having count (sedol) > 1) a on (a.sedol = s.sedol)
join secmstrx i on (s.seccode=i.seccode) where s.sedol <> '''' and i.type_=1

Order by Region, s.Sedol

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_DupeSedol_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Dupesedols_Secsdlchgx]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Dupesedols_Secsdlchgx', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks duplicate sedol in SecSdlChgX', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT A.*
FROM SECSDLCHGX A
JOIN SECSDLCHGX B
ON A.SEDOL = B.SEDOL
AND A.SECCODE <> B.SECCODE
ORDER BY A.SEDOL, A.STARTDATE


---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Sudeep>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\Monitor\qcchecks\SecMstr\Sec_Dupesedols_SecSdlChgx__$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'11:30pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20081119, 
		@active_end_date=99991231, 
		@active_start_time=233000, 
		@active_end_time=235959, 
		@schedule_uid=N'7f6a67de-0520-44db-8003-f8d84cecdcbe'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Dupesedols_SecSdlChgx & GsecSdlChg]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Dupesedols_SecSdlChgx & GsecSdlChg', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query is to find out overlapping sedols in SecSdlChgx & GsecSdlChg tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT * 
FROM SECSDLCHGX A
JOIN GSECSDLCHG B
ON A.SEDOL = B.SEDOL
AND A.SECCODE <> B.SECCODE
ORDER BY A.SEDOL, A.STARTDATE


----------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Sudeep>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_Dupesedols_SecSdlChgx & GsecSdlChg_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 2:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'b5db78d1-5a69-4532-9fb8-4e7e45769c74'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Duplicate_Sedol_EndDates]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Duplicate_Sedol_EndDates', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for duplicate sedol enddate in SecSdlChgX table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Select * from SecSdlChgX where SecCode in(
Select SecCode from SecSdlChgX where EndDate=''2079-06-06''group by SecCode having COUNT(distinct Sedol)>1
) order by SecCode,EndDate 

----------------------------------------------------------------------------------------------------------------------------------------							
Declare @row_num INT							
SET @row_num = @@ROWCOUNT							
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''							
-----------------------------------------------------------------------------------------------------------------------------------------							
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';							
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';		
ELSE                                                                             PRINT ''***CRITICAL***'';							
GO							
-----------------------------------------------------------------------------------------------------------------------------------------							
PRINT ''***CM:<<<Celine>>>|CM***''							
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_Duplicate_Sedol_EndDates_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=126, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140711, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f44494-13fe-4f98-a83d-64108446a267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_ID Drops]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_ID Drops', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Reviews _change tables for Secmstr, SecmstrX, Gsecmstr, & GsecmstrX for deleted IDs.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--ID Drops
select ''SecX'' as Region, SecCode, Id, Name, Cusip as CusSed, Sedol from secmstrx_changes  where updateflag_=''d''
union
select ''Sec'' as Region, SecCode, Id, Name, Cusip as CuSed, Sedol from secmstr_changes  where updateflag_=''d''
union
select ''GsecX'' as Region, SecCode, Id, Name, Cusip as CuSed, Sedol from gsecmstrx_changes  where updateflag_=''d''
union
select ''Gsec'' as Region, SecCode, GsId as Id, Name, Sedol as CuSed, Sedol from gsecmstr_changes  where updateflag_=''d''
order by Id, Region

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';							 
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------

', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Id Drops\Sec_ID Drops_$(ESCAPE_SQUOTE(DATE))_$(ESCAPE_SQUOTE(TIME)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'3x a Day (Su-Sa)', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=127, 
		@freq_subday_type=8, 
		@freq_subday_interval=8, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20081219, 
		@active_end_date=99991231, 
		@active_start_time=0, 
		@active_end_time=235959, 
		@schedule_uid=N'b4ad8166-59cc-4fd7-aa33-9cd10c5f9919'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_IdDivergence]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_IdDivergence', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Check for divergence between Secmstr-SecmstrX and Gsecmstr-GsecmstrX.  Outputs IDs that exist in one master table but not the other.  Only does so for EQUTIES.  [Query written by Greg Monegro.]  4/21/2010', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- IDs not in both Security Masters

-- SecmstrX only
select ''SecmstrX'' as Region, ID, Name, Cusip as CuSed, Seccode from secmstrx where type_=1 and ID not in (select ID from secmstr where type_=1)
UNION
-- Secmstr only
select ''Secmstr'' as Region, ID, Name, Cusip as CuSed, Seccode from secmstr where type_=1 and ID not in (select ID from secmstrx where type_=1)
UNION
-- GsecmstrX only
select ''GsecmstrX'' as Region, ID, Name, Sedol as CuSed, Seccode from gsecmstrx where type_=10 and ID not in (select GsID from gsecmstr)
UNION
-- Gsecmstr only
select ''Gsecmstr'' as Region, GsID as ID, Name, Sedol as CuSed, Seccode from gsecmstr where GsID not in (select ID from gsecmstrx where type_=10)

order by Region, ID

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Divergence\Sec_IdDivergence_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Orphan(Glbl)]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Orphan(Glbl)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for orphaned seccodes in the global security tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT ''GsecmapX'' AS TABLE_, SECCODE FROM gsecmapx WHERE 
SECCODE NOT IN (SELECT DISTINCT SECCODE FROM gSECMSTRx)

UNION

SELECT ''Gsecmap'' AS TABLE_, SECCODE FROM gsecmap WHERE 
SECCODE NOT IN (SELECT DISTINCT SECCODE FROM gSECMSTR)

UNION

SELECT ''GSecSdlChg'' AS TABLE_, SECCODE FROM gSecSdlChg WHERE 
SECCODE NOT IN (SELECT DISTINCT SECCODE FROM gSECMSTR)

order by Table_, SecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Divergence\Sec_Orphan(Glbl)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Orphan(NA)]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Orphan(NA)', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This query checks for orphaned seccodes in the security tables.  

Changes made by Patrick Howerter to only compare against securities in secmstrx that have type_ = 1. 8/21/2013', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'Select ''SecCspChg'' as Table_, SecCode from seccspchg where seccode not in (select distinct seccode from secmstr where type_ = 1) 
union
Select ''SecCspChgX'' as Table_, SecCode from seccspchgx where seccode not in (select distinct seccode from secmstrx where type_ = 1) 
union
Select ''SecMap'' as Table_, SecCode from secmap where seccode not in (select distinct seccode from secmstr where type_ = 1) and exchange <>20
union
Select ''SecMapX'' as Table_, SecCode from secmapx where seccode not in (select distinct seccode from secmstrx where type_ = 1 ) and exchange <>20
union
Select ''SecSdlChg'' as Table_, SecCode from secsdlchg where seccode not in (select distinct seccode from secmstr where type_ = 1)
union
Select ''SecSdlChgX'' as Table_, SecCode from secsdlchgx where seccode not in (select distinct seccode from secmstrx where type_ = 1)
union
Select ''SecSdl2Chg'' as Table_, SecCode from secsdl2chg where seccode not in (select distinct seccode from secmstr where type_ = 1 )
union
Select ''SecSdl2ChgX'' as Table_, SecCode from secsdl2chgx where seccode not in (select distinct seccode from secmstrx where type_ = 1)

order by Table_, SecCode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Divergence\Sec_Orphan(NA)_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 2:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'5584a0bf-d532-4d32-b82e-067f946b5d79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Overlapping_CUSIP_NA]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Overlapping_CUSIP_NA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch cases where there are overlapping startdate/enddate values in the SecCspChgx table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select    * from  seccspchgx chg1
join seccspchgx chg2
on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
and chg1.cusip <> chg2.cusip

union
select 
      * 
      from  seccspchgx chg1
join  seccspchgx chg2
      on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
      and chg1.CUSIP = chg2.CUSIP
      and chg1.startdate <> chg2.startdate
	  
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
	  
	', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_Overlapping_CUSIP_NA_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Run Query', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=126, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140711, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'af1ce6f4-5251-4cd5-b6bc-22902f557c79'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Overlapping_Sedol_GBL]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Overlapping_Sedol_GBL', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch cases of overlapping SEDOL history in the GSecSdlchg table.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:08 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select   * from gSecsdlChg chg1
join gSecsdlChg chg2
on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
and chg1.sedol <> chg2.sedol
union
select 
      * 
      from gSecsdlChg chg1
join gSecsdlChg chg2
      on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
      and chg1.sedol = chg2.sedol
      and chg1.startdate <> chg2.startdate


---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_Overlapping_Sedol_GBL_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=126, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140711, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f44494-13fe-4f98-a83d-64108446a267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_Overlapping_Sedol_NA]    Script Date: 3/15/2016 8:56:08 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:08 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_Overlapping_Sedol_NA', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch cases in the SecSdlChgx and SecSdl2Chgx table where there are overlapping startdate and enddate combinations.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'
select  ''SecsdlChgx'',   * from  SecsdlChgx chg1
join SecsdlChgx chg2
on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
and chg1.sedol <> chg2.sedol
union
select 
      ''SecsdlChgx'', * 
      from  SecsdlChgx chg1
join  SecsdlChgx chg2
      on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
      and chg1.sedol = chg2.sedol
      and chg1.startdate <> chg2.startdate

 
 
 select  ''Secsdl2Chgx'',   * from  Secsdl2Chgx chg1
join Secsdl2Chgx chg2
on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
and chg1.sedol <> chg2.sedol
union
select 
      ''Secsdl2Chgx'', * 
      from  Secsdl2Chgx chg1
join  Secsdl2Chgx chg2
      on chg1.SecCode = chg2.SecCode
where chg1.StartDate between chg2.StartDate and chg2.EndDate
      and chg1.sedol = chg2.sedol
      and chg1.startdate <> chg2.startdate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_Overlapping_Sedol_NA_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily Run', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=126, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140711, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'15ba3dbf-2a31-4ba3-a906-b25d0bc70f67'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_SedolHist]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_SedolHist', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Check for divergence in SEDOL history between Secsdlchg-SecsdlchgX.  Outputs IDs for those with differences.  Only does so for EQUITIES.  [Query written by Greg Monegro.]  4/22/2010', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'-- Sedols not in both Security Sedol Change

-- Secmstr only, Sdl and Sdl2
select ''Secmstr'' as Region, ID, s.Sedol, c.Sedol as SedolHist, c.Date_ as StartDate, Name, s.Seccode from secmstr s join secsdlchg c
on (s.seccode=c.seccode) where s.type_=1 and c.sedol not in (select sedol from secsdlchgx where seccode=c.seccode)

UNION

select ''Secmstr2'' as Region, ID, s.Sedol, c.Sedol as SedolHist, c.Date_ as StartDate, Name, s.Seccode from secmstr s join secsdl2chg c
on (s.seccode=c.seccode) where s.type_=1 and c.sedol not in (select sedol from secsdl2chgx where seccode=c.seccode)

UNION

-- SecmstrX only, Sdl and Sdl2
select ''SecmstrX'' as Region, ID, s.Sedol, c.Sedol as SedolHist, c.StartDate, Name, s.Seccode from secmstrx s join secsdlchgx c
on (s.seccode=c.seccode) where s.type_=1 and c.sedol not in (select sedol from secsdlchg where seccode=c.seccode)

UNION

select ''SecmstrX2'' as Region, ID, s.Sedol, c.Sedol as SedolHist, c.StartDate, Name, s.Seccode from secmstrx s join secsdl2chgx c
on (s.seccode=c.seccode) where s.type_=1 and c.sedol not in (select sedol from secsdl2chg where seccode=c.seccode)

order by ID, Region, StartDate

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_SedolHist_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 10:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=12, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20080912, 
		@active_end_date=99991231, 
		@active_start_time=100000, 
		@active_end_time=235959, 
		@schedule_uid=N'72b72e00-9509-4a08-aec2-f3ceb474ef0d'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_SEDOLIDCMismatchRank1]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_SEDOLIDCMismatchRank1', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch differences between Secmstrx SEDOLs and SEDOLs in the idc info tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT
	mx.id, mx.sedol, i.sedol as US_Sedol, i2.sedol as CA_Sedol
	FROM	Secmstrx mx
	JOIN	Secmapx mp
	on		mx.seccode = mp.seccode
	and		mx.type_ = 1
	and		mp.ventype = 1
	and		mp.rank = (select min(rank) from secmapx where seccode = mp.seccode and mp.ventype = ventype and exchange = mp.exchange)
	left join prc.prcsdlchg i
	on		mp.vencode = i.code
	and		i.StartDate = (select max(StartDate) from prc.prcsdlchg where code = i.code)
	and		mp.exchange =1
	left join cprcsdlchg i2
	on		mp.vencode = i2.code
	and		i2.StartDate = (select max(StartDate) from cprcsdlchg where code = i2.code)
	and		mp.exchange = 2
	where	
	(mx.sedol is not null  and mx.sedol <> '''')
	and (i.sedol is not null or i2.sedol is not null)
	and		mp.rank =1 
	and mx.sedol <> isnull(i.sedol, i2.sedol)
	order by mx.seccode


---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
 ', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_SEDOLIDCMismatchRank1_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 3:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20070214, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'8d35a3df-32b9-4c3d-a211-0b943651c79f'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Sec_SEDOLIDCMismatchRank2]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Sec_SEDOLIDCMismatchRank2', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'This will catch differences between Secmstrx SEDOL2 and SEDOL in the idc info tables.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run Query]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run Query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'SELECT
	mx.id, mx.cusip, mx.sedol2, i.sedol as US_Sedol, i2.sedol as CA_Sedol
	FROM	Secmstrx mx
	JOIN	Secmapx mp
	on		mx.seccode = mp.seccode
	and		mx.type_ = 1
	and		mp.ventype = 1
	and		mp.rank = (select min(rank) from secmapx where seccode = mp.seccode and mp.ventype = ventype and exchange = mp.exchange)
	left join prc.prcsdlchg i
	on		mp.vencode = i.code
	and		i.StartDate = (select max(StartDate) from prc.prcsdlchg where code = i.code)
	and		mp.exchange =1
	left join cprcsdlchg i2
	on		mp.vencode = i2.code
	and		i2.StartDate = (select max(StartDate) from cprcsdlchg where code = i2.code)
	and		mp.exchange = 2
	where	
	(mx.sedol is not null  and mx.sedol <> '''')
	and (i.sedol is not null or i2.sedol is not null)
	and		mp.rank =2
	and mx.sedol2 <> isnull(i.sedol, i2.sedol)
	order by mx.seccode

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
 ', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Sec_SEDOLIDCMismatchRank2_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily 2:00am', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080811, 
		@active_end_date=99991231, 
		@active_start_time=30000, 
		@active_end_time=235959, 
		@schedule_uid=N'b5db78d1-5a69-4532-9fb8-4e7e45769c74'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Secmap_IBES_ExchCode]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Secmap_IBES_ExchCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Looks for invalid exchange codes on IBES, IBESC mapping in Secmap and SecmapX.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--IBES & IBESC invalid exchange codes
Select count(*) as "Secmap" from secmap where exchange <> 0 and ventype in (1, 4)

Select count(*) as "SecmapX" from secmapx where exchange <> 0 and ventype in (2, 3)

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\SecMstr\Secmap_IBES_ExchCodes_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [Secmstr_dup_vencode]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'Secmstr_dup_vencode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Secmstr_dup_vencode finds duplicate vencodes.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step1]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select
p.vencode, p.exchange, count(1) cnt 
from
secmstr m 
join secmap p 
on p.seccode = m.seccode 
where
1=1 
and m.type_ = 1 
and p.ventype = 14 
and p.exchange in (1
, 2) 
group by
p.VenCode
, p.exchange 
having
count(1) > 1

---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';
ELSE                                                                             PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Sudeep - duplicate vencodes>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\Monitor\qcchecks\SecMstr\Secmstr_dup_vencode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'M-F 6:00am', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=62, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20090505, 
		@active_end_date=99991231, 
		@active_start_time=60000, 
		@active_end_time=235959, 
		@schedule_uid=N'7ccae5ad-28bd-40ea-8747-e4e003491122'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [syspolicy_purge_history]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'syspolicy_purge_history', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'No description available.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Verify that automation is enabled.]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Verify that automation is enabled.', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=1, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'IF (msdb.dbo.fn_syspolicy_is_automation_enabled() != 1)
        BEGIN
            RAISERROR(34022, 16, 1)
        END', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Purge history.]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Purge history.', 
		@step_id=2, 
		@cmdexec_success_code=0, 
		@on_success_action=3, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'EXEC msdb.dbo.sp_syspolicy_purge_history', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Erase Phantom System Health Records.]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Erase Phantom System Health Records.', 
		@step_id=3, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'PowerShell', 
		@command=N'if (''$(ESCAPE_SQUOTE(INST))'' -eq ''MSSQLSERVER'') {$a = ''\DEFAULT''} ELSE {$a = ''''};
(Get-Item SQLSERVER:\SQLPolicy\$(ESCAPE_NONE(SRVR))$a).EraseSystemHealthPhantomRecords()', 
		@database_name=N'master', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'syspolicy_purge_history_schedule', 
		@enabled=1, 
		@freq_type=4, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=0, 
		@active_start_date=20080101, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'98a47561-36a3-4b94-827b-e72c5db0076b'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [WS_DupCode]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'WS_DupCode', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'daily checks for the duplicate world scope codes', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [step1]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'step1', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'select *
from wsinfo
where code in (
select i.Code
from wsinfo i
where i.entity in (''C'',''S'')
group by i.code
,     i.entity
having count(*) > 1
)


---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1	      PRINT ''***WARNING***'';								
ELSE                                                                     	      PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Celine>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Worldscope\WS_DupCode_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Daily', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=126, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20140711, 
		@active_end_date=99991231, 
		@active_start_time=20000, 
		@active_end_time=235959, 
		@schedule_uid=N'd9f44494-13fe-4f98-a83d-64108446a267'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

/****** Object:  Job [WS_MarketCap]    Script Date: 3/15/2016 8:56:09 AM ******/
BEGIN TRANSACTION
DECLARE @ReturnCode INT
SELECT @ReturnCode = 0
/****** Object:  JobCategory [[Uncategorized (Local)]]]    Script Date: 3/15/2016 8:56:09 AM ******/
IF NOT EXISTS (SELECT name FROM msdb.dbo.syscategories WHERE name=N'[Uncategorized (Local)]' AND category_class=1)
BEGIN
EXEC @ReturnCode = msdb.dbo.sp_add_category @class=N'JOB', @type=N'LOCAL', @name=N'[Uncategorized (Local)]'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback

END

DECLARE @jobId BINARY(16)
EXEC @ReturnCode =  msdb.dbo.sp_add_job @job_name=N'WS_MarketCap', 
		@enabled=1, 
		@notify_level_eventlog=0, 
		@notify_level_email=0, 
		@notify_level_netsend=0, 
		@notify_level_page=0, 
		@delete_level=0, 
		@description=N'Reviews Worldscope''s market cap (item 8001) where Q4 or S2 does not equal Annual values.  #938436 (Highbridge)  Original output had 50,080 rows.', 
		@category_name=N'[Uncategorized (Local)]', 
		@owner_login_name=N'sa', @job_id = @jobId OUTPUT
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
/****** Object:  Step [Run query]    Script Date: 3/15/2016 8:56:09 AM ******/
EXEC @ReturnCode = msdb.dbo.sp_add_jobstep @job_id=@jobId, @step_name=N'Run query', 
		@step_id=1, 
		@cmdexec_success_code=0, 
		@on_success_action=1, 
		@on_success_step_id=0, 
		@on_fail_action=2, 
		@on_fail_step_id=0, 
		@retry_attempts=0, 
		@retry_interval=0, 
		@os_run_priority=0, @subsystem=N'TSQL', 
		@command=N'--Worldscope MarketCap (item 8001) S2 or Q4 does not equal A.

select i.WsID, i.Name, i.IsoCtry, d.item, d.year_ , d.Freq, d.Seq, d.value_, d2.year_, d2.Freq, d2.value_ 
from wsinfo i join wsndata d on (i.code=d.code) join wsndata d2 on (d.code=d2.code)
and (d.item=d2.item) where d.item=''8001'' and d.year_=d2.year_ and d.freq=''q'' and d.seq=''4''
and d2.freq=''a'' and d2.seq=''1'' and d.value_!=d2.value_ --and d.year_ > 2007

UNION

select i.WsID, i.Name, i.IsoCtry, d.item, d.year_ , d.freq, d.seq, d.value_, d2.year_, d2.freq, d2.value_ 
from wsinfo i join wsndata d on (i.code=d.code) join wsndata d2 on (d.code=d2.code)
and (d.item=d2.item) where d.item=''8001'' and d.year_=d2.year_ and d.freq=''s'' and d.seq=''2''
and d2.freq=''a'' and d2.seq=''1'' and d.value_!=d2.value_ --and d.year_ > 2007
order by i.WsID, d.Year_
---------------------------------------------------------------------------------------------------------------------------------------
Declare @row_num INT
SET @row_num = @@ROWCOUNT
Print ''***<<(''+cast(@row_num as varchar(11))+'')>>***''
-----------------------------------------------------------------------------------------------------------------------------------------
IF @row_num = 0                                                          PRINT ''***ZERO RESULTS***'';
ELSE IF @row_num  > 0 AND @row_num <= 1									 PRINT ''***WARNING***'';
ELSE                                                                     PRINT ''***CRITICAL***'';
GO
-----------------------------------------------------------------------------------------------------------------------------------------
PRINT ''***CM:<<<Insert your comment here>>>|CM***''
-----------------------------------------------------------------------------------------------------------------------------------------
', 
		@database_name=N'qai_master', 
		@output_file_name=N'F:\NightlyChecks\monitor\qcchecks\Worldscope\WS_MarketCap_$(ESCAPE_SQUOTE(DATE)).txt', 
		@flags=0
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_update_job @job_id = @jobId, @start_step_id = 1
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobschedule @job_id=@jobId, @name=N'Weekly Sunday 10:00pm', 
		@enabled=1, 
		@freq_type=8, 
		@freq_interval=1, 
		@freq_subday_type=1, 
		@freq_subday_interval=0, 
		@freq_relative_interval=0, 
		@freq_recurrence_factor=1, 
		@active_start_date=20100502, 
		@active_end_date=99991231, 
		@active_start_time=220000, 
		@active_end_time=235959, 
		@schedule_uid=N'43b68373-56ff-4fee-8e9b-521c0b705586'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
EXEC @ReturnCode = msdb.dbo.sp_add_jobserver @job_id = @jobId, @server_name = N'(local)'
IF (@@ERROR <> 0 OR @ReturnCode <> 0) GOTO QuitWithRollback
COMMIT TRANSACTION
GOTO EndSave
QuitWithRollback:
    IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION
EndSave:

GO

